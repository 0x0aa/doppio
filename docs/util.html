<!DOCTYPE html>  <html> <head>   <title>util.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="frontend.html">                 frontend.coffee               </a>                                           <a class="source" href="node.html">                 node.coffee               </a>                                           <a class="source" href="untar.html">                 untar.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                                           <a class="source" href="ClassFile.html">                 ClassFile.coffee               </a>                                           <a class="source" href="ConstantPool.html">                 ConstantPool.coffee               </a>                                           <a class="source" href="attributes.html">                 attributes.coffee               </a>                                           <a class="source" href="disassembler.html">                 disassembler.coffee               </a>                                           <a class="source" href="exceptions.html">                 exceptions.coffee               </a>                                           <a class="source" href="java_object.html">                 java_object.coffee               </a>                                           <a class="source" href="jvm.html">                 jvm.coffee               </a>                                           <a class="source" href="logging.html">                 logging.coffee               </a>                                           <a class="source" href="methods.html">                 methods.coffee               </a>                                           <a class="source" href="natives.html">                 natives.coffee               </a>                                           <a class="source" href="opcodes.html">                 opcodes.coffee               </a>                                           <a class="source" href="runtime.html">                 runtime.coffee               </a>                                           <a class="source" href="testing.html">                 testing.coffee               </a>                                           <a class="source" href="types.html">                 types.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               util.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>pull in external modules</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">gLong = </span><span class="nx">require</span> <span class="s1">&#39;../vendor/gLong.js&#39;</span>
<span class="nv">exceptions = </span><span class="nx">require</span> <span class="s1">&#39;./exceptions&#39;</span>
<span class="p">{</span><span class="nx">trace</span><span class="p">,</span><span class="nx">vtrace</span><span class="p">,</span><span class="nx">error</span><span class="p">,</span><span class="nx">debug</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./logging&#39;</span>

<span class="s2">&quot;use strict&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>things assigned to root will be available outside this module</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root = </span><span class="nx">exports</span> <span class="o">?</span> <span class="nb">window</span><span class="p">.</span><span class="nx">util</span> <span class="o">?=</span> <span class="p">{}</span>

<span class="nv">root.INT_MAX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="nv">root.INT_MIN = </span><span class="o">-</span><span class="nx">root</span><span class="p">.</span><span class="nx">INT_MAX</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># -2^31</span>

<span class="nv">root.FLOAT_POS_INFINITY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">128</span><span class="p">)</span>
<span class="nv">root.FLOAT_NEG_INFINITY = </span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="nx">root</span><span class="p">.</span><span class="nx">FLOAT_POS_INFINITY</span>
<span class="nv">root.FLOAT_POS_INFINITY_AS_INT = </span><span class="mh">0x7F800000</span>
<span class="nv">root.FLOAT_NEG_INFINITY_AS_INT = </span><span class="o">-</span><span class="mi">8388608</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>We use the JavaScript NaN as our NaN value, and convert it to
a NaN value in the SNaN range when an int equivalent is requested.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.FLOAT_NaN_AS_INT = </span><span class="mh">0x7fc00000</span>

<span class="nv">root.int_mod = </span><span class="nf">(rs, a, b) -&gt;</span>
  <span class="nx">exceptions</span><span class="p">.</span><span class="nx">java_throw</span> <span class="nx">rs</span><span class="p">,</span> <span class="s1">&#39;java/lang/ArithmeticException&#39;</span><span class="p">,</span> <span class="s1">&#39;/ by zero&#39;</span> <span class="k">if</span> <span class="nx">b</span> <span class="o">==</span> <span class="mi">0</span>
  <span class="nx">a</span> <span class="o">%</span> <span class="nx">b</span>

<span class="nv">root.int_div = </span><span class="nf">(rs, a, b) -&gt;</span>
  <span class="nx">exceptions</span><span class="p">.</span><span class="nx">java_throw</span> <span class="nx">rs</span><span class="p">,</span> <span class="s1">&#39;java/lang/ArithmeticException&#39;</span><span class="p">,</span> <span class="s1">&#39;/ by zero&#39;</span> <span class="k">if</span> <span class="nx">b</span> <span class="o">==</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>spec: "if the dividend is the negative integer of largest possible magnitude
for the int type, and the divisor is -1, then overflow occurs, and the
result is equal to the dividend."</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">a</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">root</span><span class="p">.</span><span class="nx">INT_MIN</span> <span class="o">and</span> <span class="nx">b</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
  <span class="p">(</span><span class="nx">a</span> <span class="err">/ b) | 0</span>

<span class="nv">root.long_mod = </span><span class="nf">(rs, a, b) -&gt;</span>
  <span class="nx">exceptions</span><span class="p">.</span><span class="nx">java_throw</span> <span class="nx">rs</span><span class="p">,</span> <span class="s1">&#39;java/lang/ArithmeticException&#39;</span><span class="p">,</span> <span class="s1">&#39;/ by zero&#39;</span> <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">isZero</span><span class="p">()</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">modulo</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>

<span class="nv">root.long_div = </span><span class="nf">(rs, a, b) -&gt;</span>
  <span class="nx">exceptions</span><span class="p">.</span><span class="nx">java_throw</span> <span class="nx">rs</span><span class="p">,</span> <span class="s1">&#39;java/lang/ArithmeticException&#39;</span><span class="p">,</span> <span class="s1">&#39;/ by zero&#39;</span> <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">isZero</span><span class="p">()</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">div</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>

<span class="nv">root.float2int = </span><span class="nf">(a) -&gt;</span>
  <span class="k">if</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">root</span><span class="p">.</span><span class="nx">INT_MAX</span> <span class="k">then</span> <span class="nx">root</span><span class="p">.</span><span class="nx">INT_MAX</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">root</span><span class="p">.</span><span class="nx">INT_MIN</span> <span class="k">then</span> <span class="nx">root</span><span class="p">.</span><span class="nx">INT_MIN</span>
  <span class="k">else</span> <span class="nx">a</span><span class="o">|</span><span class="mi">0</span>

<span class="nv">root.intbits2float = </span><span class="nf">(int32) -&gt;</span>
  <span class="k">if</span> <span class="nx">Int32Array</span><span class="o">?</span>
    <span class="nv">i_view = </span><span class="k">new</span> <span class="nx">Int32Array</span> <span class="p">[</span><span class="nx">int32</span><span class="p">]</span>
    <span class="nv">f_view = </span><span class="k">new</span> <span class="nx">Float32Array</span> <span class="nx">i_view</span><span class="p">.</span><span class="nx">buffer</span>
    <span class="k">return</span> <span class="nx">f_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Fallback for older JS engines</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Map +/- infinity to JavaScript equivalents</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">int32</span> <span class="o">==</span> <span class="nx">root</span><span class="p">.</span><span class="nx">FLOAT_POS_INFINITY_AS_INT</span>
    <span class="k">return</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">int32</span> <span class="o">==</span> <span class="nx">root</span><span class="p">.</span><span class="nx">FLOAT_NEG_INFINITY_AS_INT</span>
    <span class="k">return</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">NEGATIVE_INFINITY</span>

  <span class="nv">sign = </span><span class="p">(</span><span class="nx">int32</span> <span class="o">&amp;</span>       <span class="mh">0x80000000</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span><span class="mi">31</span>
  <span class="nv">exponent = </span><span class="p">(</span><span class="nx">int32</span> <span class="o">&amp;</span>   <span class="mh">0x7F800000</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span><span class="mi">23</span>
  <span class="nv">significand = </span><span class="nx">int32</span> <span class="o">&amp;</span> <span class="mh">0x007FFFFF</span>
  <span class="k">if</span> <span class="nx">exponent</span> <span class="o">is</span> <span class="mi">0</span>  <span class="c1"># we must denormalize!</span>
    <span class="nv">value = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nx">sign</span><span class="p">)</span><span class="o">*</span><span class="nx">significand</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">149</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nv">value = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nx">sign</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nx">significand</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">23</span><span class="p">))</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">exponent</span><span class="o">-</span><span class="mi">127</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>NaN check</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">value</span> <span class="o">&lt;</span> <span class="nx">root</span><span class="p">.</span><span class="nx">FLOAT_NEG_INFINITY</span> <span class="o">or</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="nx">root</span><span class="p">.</span><span class="nx">FLOAT_POS_INFINITY</span>
    <span class="nv">value = </span><span class="kc">NaN</span>

  <span class="k">return</span> <span class="nx">value</span>

<span class="nv">root.longbits2double = </span><span class="nf">(uint32_a, uint32_b) -&gt;</span>
  <span class="k">if</span> <span class="nx">Uint32Array</span><span class="o">?</span>
    <span class="nv">i_view = </span><span class="k">new</span> <span class="nx">Uint32Array</span> <span class="mi">2</span>
    <span class="nx">i_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">uint32_b</span>
    <span class="nx">i_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">uint32_a</span>
    <span class="nv">d_view = </span><span class="k">new</span> <span class="nx">Float64Array</span> <span class="nx">i_view</span><span class="p">.</span><span class="nx">buffer</span>
    <span class="k">return</span> <span class="nx">d_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="nv">sign     = </span><span class="p">(</span><span class="nx">uint32_a</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span><span class="mi">31</span>
  <span class="nv">exponent = </span><span class="p">(</span><span class="nx">uint32_a</span> <span class="o">&amp;</span> <span class="mh">0x7FF00000</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span><span class="mi">20</span>
  <span class="nv">significand = </span><span class="nx">root</span><span class="p">.</span><span class="nx">lshift</span><span class="p">(</span><span class="nx">uint32_a</span> <span class="o">&amp;</span> <span class="mh">0x000FFFFF</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="nx">uint32_b</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Special values!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">exponent</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">significand</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="nx">exponent</span> <span class="o">is</span> <span class="mi">2047</span>
    <span class="k">if</span> <span class="nx">significand</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">sign</span> <span class="o">is</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">NEGATIVE_INFINITY</span>
      <span class="k">return</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span>
    <span class="k">else</span> <span class="k">return</span> <span class="kc">NaN</span>

  <span class="k">if</span> <span class="nx">exponent</span> <span class="o">is</span> <span class="mi">0</span>  <span class="c1"># we must denormalize!</span>
    <span class="nv">value = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nx">sign</span><span class="p">)</span><span class="o">*</span><span class="nx">significand</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1074</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="nv">value = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nx">sign</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nx">significand</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">52</span><span class="p">))</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">exponent</span><span class="o">-</span><span class="mi">1023</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Call this ONLY on the result of two non-NaN numbers.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.wrap_float = </span><span class="nf">(a) -&gt;</span>
  <span class="k">return</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="mf">3.40282346638528860</span><span class="nx">e</span><span class="o">+</span><span class="mi">38</span>
  <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="mf">1.40129846432481707</span><span class="nx">e</span><span class="o">-</span><span class="mi">45</span>
  <span class="k">return</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">NEGATIVE_INFINITY</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">3.40282346638528860</span><span class="nx">e</span><span class="o">+</span><span class="mi">38</span>
  <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1.40129846432481707</span><span class="nx">e</span><span class="o">-</span><span class="mi">45</span>
  <span class="nx">a</span>

<span class="nv">root.cmp = </span><span class="nf">(a,b) -&gt;</span>
  <span class="k">return</span> <span class="mi">0</span>  <span class="k">if</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span>
  <span class="k">return</span> <span class="mi">1</span>  <span class="k">if</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span>
  <span class="k">return</span> <span class="kc">null</span> <span class="c1"># this will occur if either a or b is NaN</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>implements x&lt;<n without the braindead javascript &lt;&lt; operator
(see http://stackoverflow.com/questions/337355/javascript-bitwise-shift-of-long-long-number)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.lshift = </span><span class="nf">(x,n) -&gt;</span> <span class="nx">x</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">n</span><span class="p">)</span>

<span class="nv">root.read_uint = </span><span class="nf">(bytes) -&gt;</span>
  <span class="nv">n = </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>sum up the byte values shifted left to the right alignment.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sum = </span><span class="mi">0</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">n</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
    <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">lshift</span><span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="nx">n</span><span class="o">-</span><span class="nx">i</span><span class="p">))</span>
  <span class="nx">sum</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Convert :count chars starting from :offset in a Java character array into a JS string</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.chars2js_str = </span><span class="nf">(jvm_carr, offset, count) -&gt;</span>
  <span class="nx">root</span><span class="p">.</span><span class="nx">bytes2str</span><span class="p">(</span><span class="nx">jvm_carr</span><span class="p">.</span><span class="nx">array</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="nx">offset</span> <span class="o">?</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span>

<span class="nv">root.bytestr_to_array = </span><span class="nf">(bytecode_string) -&gt;</span>
  <span class="p">(</span><span class="nx">bytecode_string</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">bytecode_string</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span><span class="p">)</span>

<span class="nv">root.array_to_bytestr = </span><span class="nf">(bytecode_array) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>XXX: We'd like to use String.fromCharCode(bytecode_array...)
 but that fails on Webkit with arrays longer than 2^31. See issue #129 for details.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span> <span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">bytecode_array</span><span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span>

<span class="nv">root.parse_flags = </span><span class="nf">(flag_byte) -&gt;</span> <span class="p">{</span>
    <span class="nv">public: </span>      <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x1</span>
    <span class="nv">private: </span>     <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x2</span>
    <span class="nv">protected: </span>   <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x4</span>
    <span class="nv">static: </span>      <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x8</span>
    <span class="nv">final: </span>       <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x10</span>
    <span class="nv">synchronized: </span><span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x20</span>
    <span class="k">super</span><span class="o">:</span>        <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x20</span>
    <span class="nv">volatile: </span>    <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x40</span>
    <span class="nv">transient: </span>   <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span>
    <span class="nv">native: </span>      <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x100</span>
    <span class="nv">interface: </span>   <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x200</span>
    <span class="nv">abstract: </span>    <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x400</span>
    <span class="nv">strict: </span>      <span class="nx">flag_byte</span> <span class="o">&amp;</span> <span class="mh">0x800</span>
  <span class="p">}</span>

<span class="nv">root.escape_whitespace = </span><span class="nf">(str) -&gt;</span>
  <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\s/g</span><span class="p">,</span> <span class="nf">(c) -&gt;</span>
    <span class="k">switch</span> <span class="nx">c</span>
      <span class="k">when</span> <span class="s2">&quot;\n&quot;</span> <span class="k">then</span> <span class="s2">&quot;\\n&quot;</span>
      <span class="k">when</span> <span class="s2">&quot;\r&quot;</span> <span class="k">then</span> <span class="s2">&quot;\\r&quot;</span>
      <span class="k">when</span> <span class="s2">&quot;\t&quot;</span> <span class="k">then</span> <span class="s2">&quot;\\t&quot;</span>
      <span class="k">when</span> <span class="s2">&quot;\v&quot;</span> <span class="k">then</span> <span class="s2">&quot;\\v&quot;</span>
      <span class="k">when</span> <span class="s2">&quot;\f&quot;</span> <span class="k">then</span> <span class="s2">&quot;\\f&quot;</span>
      <span class="k">else</span> <span class="nx">c</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>if :entry is a reference, display its referent in a comment</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.format_extra_info = </span><span class="nf">(entry) -&gt;</span>
  <span class="nv">type = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span>
  <span class="nv">info = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">deref</span><span class="o">?</span><span class="p">()</span>
  <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="nx">unless</span> <span class="nx">info</span>
  <span class="k">switch</span> <span class="nx">type</span>
    <span class="k">when</span> <span class="s1">&#39;Method&#39;</span><span class="p">,</span> <span class="s1">&#39;InterfaceMethod&#39;</span>
      <span class="s2">&quot;\t//  #{info.class}.#{info.sig}&quot;</span>
    <span class="k">when</span> <span class="s1">&#39;Field&#39;</span>
      <span class="s2">&quot;\t//  #{info.class}.#{info.name}:#{info.type}&quot;</span>
    <span class="k">when</span> <span class="s1">&#39;NameAndType&#39;</span> <span class="k">then</span> <span class="s2">&quot;//  #{info.name}:#{info.type}&quot;</span>
    <span class="k">else</span> <span class="s2">&quot;\t//  &quot;</span> <span class="o">+</span> <span class="nx">root</span><span class="p">.</span><span class="nx">escape_whitespace</span> <span class="nx">info</span> <span class="k">if</span> <span class="nx">root</span><span class="p">.</span><span class="nx">is_string</span> <span class="nx">info</span>

<span class="k">class</span> <span class="nx">root</span><span class="p">.</span><span class="nx">BytesArray</span>
  <span class="nv">constructor: </span><span class="nf">(@raw_array, @start=0, @end=@raw_array.length) -&gt;</span>
    <span class="vi">@_index = </span><span class="mi">0</span>

  <span class="nv">rewind: </span><span class="o">-&gt;</span> <span class="vi">@_index = </span><span class="mi">0</span>

  <span class="nv">pos: </span><span class="o">-&gt;</span> <span class="nx">@_index</span>

  <span class="nv">skip: </span><span class="nf">(bytes_count) -&gt;</span> <span class="nx">@_index</span> <span class="o">+=</span> <span class="nx">bytes_count</span>

  <span class="nv">has_bytes: </span><span class="o">-&gt;</span> <span class="nx">@start</span> <span class="o">+</span> <span class="nx">@_index</span> <span class="o">&lt;</span> <span class="nx">@end</span>

  <span class="nv">get_uint: </span><span class="nf">(bytes_count) -&gt;</span>
    <span class="nv">rv = </span><span class="nx">root</span><span class="p">.</span><span class="nx">read_uint</span> <span class="nx">@raw_array</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">@start</span> <span class="o">+</span> <span class="nx">@_index</span><span class="p">,</span> <span class="nx">@start</span> <span class="o">+</span> <span class="nx">@_index</span> <span class="o">+</span> <span class="nx">bytes_count</span><span class="p">)</span>
    <span class="nx">@_index</span> <span class="o">+=</span> <span class="nx">bytes_count</span>
    <span class="k">return</span> <span class="nx">rv</span>

  <span class="nv">get_int: </span><span class="nf">(bytes_count) -&gt;</span>
    <span class="nv">bytes_to_set = </span><span class="mi">32</span> <span class="o">-</span> <span class="nx">bytes_count</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="nx">@get_uint</span><span class="p">(</span><span class="nx">bytes_count</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="nx">bytes_to_set</span> <span class="o">&gt;&gt;</span> <span class="nx">bytes_to_set</span>

  <span class="nv">read: </span><span class="nf">(bytes_count) -&gt;</span>
    <span class="nv">rv = </span><span class="nx">@raw_array</span><span class="p">[</span><span class="nx">@start</span><span class="o">+</span><span class="nx">@_index</span><span class="p">...</span><span class="nx">@start</span><span class="o">+</span><span class="nx">@_index</span><span class="o">+</span><span class="nx">bytes_count</span><span class="p">]</span>
    <span class="nx">@_index</span> <span class="o">+=</span> <span class="nx">bytes_count</span>
    <span class="nx">rv</span>

  <span class="nv">peek: </span><span class="o">-&gt;</span> <span class="nx">@raw_array</span><span class="p">[</span><span class="nx">@start</span><span class="o">+</span><span class="nx">@_index</span><span class="p">]</span>

  <span class="nv">size: </span><span class="o">-&gt;</span> <span class="nx">@end</span> <span class="o">-</span> <span class="nx">@start</span> <span class="o">-</span> <span class="nx">@_index</span>

  <span class="nv">splice: </span><span class="nf">(len) -&gt;</span>
    <span class="nv">arr = </span><span class="k">new</span> <span class="nx">root</span><span class="p">.</span><span class="nx">BytesArray</span> <span class="nx">@raw_array</span><span class="p">,</span> <span class="nx">@start</span><span class="o">+</span><span class="nx">@_index</span><span class="p">,</span> <span class="nx">@start</span><span class="o">+</span><span class="nx">@_index</span><span class="o">+</span><span class="nx">len</span>
    <span class="nx">@_index</span> <span class="o">+=</span> <span class="nx">len</span>
    <span class="nx">arr</span>

<span class="nv">root.initial_value = </span><span class="nf">(type_str) -&gt;</span>
  <span class="k">if</span> <span class="nx">type_str</span> <span class="o">is</span> <span class="s1">&#39;J&#39;</span> <span class="k">then</span> <span class="nx">gLong</span><span class="p">.</span><span class="nx">ZERO</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">type_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;L&#39;</span><span class="p">]</span> <span class="k">then</span> <span class="kc">null</span>
  <span class="k">else</span> <span class="mi">0</span>

<span class="nv">root.is_string = </span><span class="nf">(obj) -&gt;</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="o">or</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">String</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Walks up the prototype chain of :object looking for an entry in the :handlers
dict that match its constructor's name.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.lookup_handler = </span><span class="nf">(handlers, object) -&gt;</span>
  <span class="nv">obj = </span><span class="nx">object</span>
  <span class="k">while</span> <span class="nx">obj</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>XXX: this will break on IE (due to constructor.name being undefined)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">handler = </span><span class="nx">handlers</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">handler</span> <span class="k">if</span> <span class="nx">handler</span>
    <span class="nv">obj = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span> <span class="nx">obj</span>
  <span class="k">return</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Java classes are represented internally using slashes as delimiters.
These helper functions convert between the two representations.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.ext_classname = </span><span class="nf">(str) -&gt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\//g</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span>
<span class="nv">root.int_classname = </span><span class="nf">(str) -&gt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\./g</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Parse Java's pseudo-UTF-8 strings. (spec 4.4.7)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.bytes2str = </span><span class="nf">(bytes) -&gt;</span>
  <span class="nv">idx = </span><span class="mi">0</span>
  <span class="nv">char_array =</span>
    <span class="k">while</span> <span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>cast to an unsigned byte</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">x = </span><span class="nx">bytes</span><span class="p">[</span><span class="nx">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
      <span class="k">break</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span>
        <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="mh">0x7f</span>
          <span class="nx">x</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="mh">0xdf</span>
          <span class="nv">y = </span><span class="nx">bytes</span><span class="p">[</span><span class="nx">idx</span><span class="o">++</span><span class="p">]</span>
          <span class="p">((</span><span class="nx">x</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">y = </span><span class="nx">bytes</span><span class="p">[</span><span class="nx">idx</span><span class="o">++</span><span class="p">]</span>
          <span class="nv">z = </span><span class="nx">bytes</span><span class="p">[</span><span class="nx">idx</span><span class="o">++</span><span class="p">]</span>
          <span class="p">((</span><span class="nx">x</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="nx">y</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">z</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span>
      <span class="p">)</span>
  <span class="nx">char_array</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span>

<span class="nv">root.last = </span><span class="nf">(array) -&gt;</span> <span class="nx">array</span><span class="p">[</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">class</span> <span class="nx">root</span><span class="p">.</span><span class="nx">SafeMap</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@cache = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="kc">null</span> <span class="c1"># has no defined properties aside from __proto__</span>
    <span class="vi">@proto_cache = </span><span class="kc">undefined</span>

  <span class="nv">get: </span><span class="nf">(key) -&gt;</span>
    <span class="k">return</span> <span class="nx">@cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span> <span class="c1"># don&#39;t use `isnt undefined` -- __proto__ is null!</span>
    <span class="k">return</span> <span class="nx">@proto_cache</span> <span class="k">if</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;__proto__&#39;</span> <span class="o">and</span> <span class="nx">@proto_cache</span> <span class="o">isnt</span> <span class="kc">undefined</span>
    <span class="kc">undefined</span>

  <span class="nv">set: </span><span class="nf">(key, value) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>toString() converts key to a primitive, so strict comparison works</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;__proto__&#39;</span>
      <span class="nx">@cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="k">else</span>
      <span class="vi">@proto_cache = </span><span class="nx">value</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 