<!DOCTYPE html>

<html>
<head>
  <title>util.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>util.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>pull in external modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>gLong = require <span class="string">'../vendor/gLong.js'</span>
{trace,vtrace,error,debug} = require <span class="string">'./logging'</span>

<span class="string">"use strict"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>things assigned to root will be available outside this module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root = exports ? window.util ?= {}

root.INT_MAX = Math.pow(<span class="number">2</span>, <span class="number">31</span>) - <span class="number">1</span>
root.INT_MIN = -root.INT_MAX - <span class="number">1</span> <span class="comment"># -2^31</span>

root.FLOAT_POS_INFINITY = Math.pow(<span class="number">2</span>,<span class="number">128</span>)
root.FLOAT_NEG_INFINITY = -<span class="number">1</span>*root.FLOAT_POS_INFINITY
root.FLOAT_POS_INFINITY_AS_INT = <span class="number">0x7F800000</span>
root.FLOAT_NEG_INFINITY_AS_INT = -<span class="number">8388608</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>We use the JavaScript NaN as our NaN value, and convert it to
a NaN value in the SNaN range when an int equivalent is requested.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.FLOAT_NaN_AS_INT = <span class="number">0x7fc00000</span>

root.<span class="function"><span class="title">int_mod</span></span> = (rs, a, b) -&gt;
  rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ArithmeticException;'</span>), <span class="string">'/ by zero'</span> <span class="keyword">if</span> b == <span class="number">0</span>
  a % b

root.<span class="function"><span class="title">int_div</span></span> = (rs, a, b) -&gt;
  rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ArithmeticException;'</span>), <span class="string">'/ by zero'</span> <span class="keyword">if</span> b == <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>spec: &quot;if the dividend is the negative integer of largest possible magnitude
for the int type, and the divisor is -1, then overflow occurs, and the
result is equal to the dividend.&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> a <span class="keyword">if</span> a == root.INT_MIN <span class="keyword">and</span> b == -<span class="number">1</span>
  (a / b) | <span class="number">0</span>

root.<span class="function"><span class="title">long_mod</span></span> = (rs, a, b) -&gt;
  rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ArithmeticException;'</span>), <span class="string">'/ by zero'</span> <span class="keyword">if</span> b.isZero()
  a.modulo(b)

root.<span class="function"><span class="title">long_div</span></span> = (rs, a, b) -&gt;
  rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ArithmeticException;'</span>), <span class="string">'/ by zero'</span> <span class="keyword">if</span> b.isZero()
  a.div(b)

root.<span class="function"><span class="title">float2int</span></span> = (a) -&gt;
  <span class="keyword">if</span> a &gt; root.INT_MAX <span class="keyword">then</span> root.INT_MAX
  <span class="keyword">else</span> <span class="keyword">if</span> a &lt; root.INT_MIN <span class="keyword">then</span> root.INT_MIN
  <span class="keyword">else</span> a|<span class="number">0</span>

root.<span class="function"><span class="title">intbits2float</span></span> = (int32) -&gt;
  <span class="keyword">if</span> Int32Array?
    i_view = <span class="keyword">new</span> Int32Array [int32]
    f_view = <span class="keyword">new</span> Float32Array i_view.buffer
    <span class="keyword">return</span> f_view[<span class="number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Fallback for older JS engines</p>
<p>Map +/- infinity to JavaScript equivalents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> int32 == root.FLOAT_POS_INFINITY_AS_INT
    <span class="keyword">return</span> Number.POSITIVE_INFINITY
  <span class="keyword">else</span> <span class="keyword">if</span> int32 == root.FLOAT_NEG_INFINITY_AS_INT
    <span class="keyword">return</span> Number.NEGATIVE_INFINITY

  sign = (int32 &amp;       <span class="number">0x80000000</span>)&gt;&gt;&gt;<span class="number">31</span>
  exponent = (int32 &amp;   <span class="number">0x7F800000</span>)&gt;&gt;&gt;<span class="number">23</span>
  significand = int32 &amp; <span class="number">0x007FFFFF</span>
  <span class="keyword">if</span> exponent <span class="keyword">is</span> <span class="number">0</span>  <span class="comment"># we must denormalize!</span>
    value = Math.pow(-<span class="number">1</span>,sign)*significand*Math.pow(<span class="number">2</span>,-<span class="number">149</span>)
  <span class="keyword">else</span>
    value = Math.pow(-<span class="number">1</span>,sign)*(<span class="number">1</span>+significand*Math.pow(<span class="number">2</span>,-<span class="number">23</span>))*Math.pow(<span class="number">2</span>,exponent-<span class="number">127</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>NaN check</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> value &lt; root.FLOAT_NEG_INFINITY <span class="keyword">or</span> value &gt; root.FLOAT_POS_INFINITY
    value = NaN

  <span class="keyword">return</span> value

root.<span class="function"><span class="title">longbits2double</span></span> = (uint32_a, uint32_b) -&gt;
  <span class="keyword">if</span> Uint32Array?
    i_view = <span class="keyword">new</span> Uint32Array <span class="number">2</span>
    i_view[<span class="number">0</span>] = uint32_b
    i_view[<span class="number">1</span>] = uint32_a
    d_view = <span class="keyword">new</span> Float64Array i_view.buffer
    <span class="keyword">return</span> d_view[<span class="number">0</span>]

  sign     = (uint32_a &amp; <span class="number">0x80000000</span>)&gt;&gt;&gt;<span class="number">31</span>
  exponent = (uint32_a &amp; <span class="number">0x7FF00000</span>)&gt;&gt;&gt;<span class="number">20</span>
  significand = root.lshift(uint32_a &amp; <span class="number">0x000FFFFF</span>, <span class="number">32</span>) + uint32_b</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Special values!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> exponent <span class="keyword">is</span> <span class="number">0</span> <span class="keyword">and</span> significand <span class="keyword">is</span> <span class="number">0</span>
  <span class="keyword">if</span> exponent <span class="keyword">is</span> <span class="number">2047</span>
    <span class="keyword">if</span> significand <span class="keyword">is</span> <span class="number">0</span>
      <span class="keyword">if</span> sign <span class="keyword">is</span> <span class="number">1</span>
        <span class="keyword">return</span> Number.NEGATIVE_INFINITY
      <span class="keyword">return</span> Number.POSITIVE_INFINITY
    <span class="keyword">else</span> <span class="keyword">return</span> NaN

  <span class="keyword">if</span> exponent <span class="keyword">is</span> <span class="number">0</span>  <span class="comment"># we must denormalize!</span>
    value = Math.pow(-<span class="number">1</span>,sign)*significand*Math.pow(<span class="number">2</span>,-<span class="number">1074</span>)
  <span class="keyword">else</span>
    value = Math.pow(-<span class="number">1</span>,sign)*(<span class="number">1</span>+significand*Math.pow(<span class="number">2</span>,-<span class="number">52</span>))*Math.pow(<span class="number">2</span>,exponent-<span class="number">1023</span>)
  <span class="keyword">return</span> value</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Call this ONLY on the result of two non-NaN numbers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">wrap_float</span></span> = (a) -&gt;
  <span class="keyword">return</span> Number.POSITIVE_INFINITY <span class="keyword">if</span> a &gt; <span class="number">3.40282346638528860e+38</span>
  <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> <span class="number">0</span> &lt; a &lt; <span class="number">1.40129846432481707e-45</span>
  <span class="keyword">return</span> Number.NEGATIVE_INFINITY <span class="keyword">if</span> a &lt; -<span class="number">3.40282346638528860e+38</span>
  <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">if</span> <span class="number">0</span> &gt; a &gt; -<span class="number">1.40129846432481707e-45</span>
  a

root.<span class="function"><span class="title">cmp</span></span> = (a,b) -&gt;
  <span class="keyword">return</span> <span class="number">0</span>  <span class="keyword">if</span> a == b
  <span class="keyword">return</span> -<span class="number">1</span> <span class="keyword">if</span> a &lt; b
  <span class="keyword">return</span> <span class="number">1</span>  <span class="keyword">if</span> a &gt; b
  <span class="keyword">return</span> <span class="literal">null</span> <span class="comment"># this will occur if either a or b is NaN</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>implements x&lt;&lt;n without the braindead javascript &lt;&lt; operator
(see <a href="http://stackoverflow.com/questions/337355/javascript-bitwise-shift-of-long-long-number">http://stackoverflow.com/questions/337355/javascript-bitwise-shift-of-long-long-number</a>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">lshift</span></span> = (x,n) -&gt; x*Math.pow(<span class="number">2</span>,n)

root.<span class="function"><span class="title">read_uint</span></span> = (bytes) -&gt;
  n = bytes.length-<span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>sum up the byte values shifted left to the right alignment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sum = <span class="number">0</span>
  <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>.n] <span class="keyword">by</span> <span class="number">1</span>
    sum += root.lshift(bytes[i],<span class="number">8</span>*(n-i))
  sum</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Convert :count chars starting from :offset in a Java character array into a JS string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">chars2js_str</span></span> = (jvm_carr, offset, count) -&gt;
  root.bytes2str(jvm_carr.array).substr(offset ? <span class="number">0</span>, count)

root.<span class="function"><span class="title">bytestr_to_array</span></span> = (bytecode_string) -&gt;
  (bytecode_string.charCodeAt(i) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..bytecode_string.length] <span class="keyword">by</span> <span class="number">1</span>)

root.<span class="function"><span class="title">array_to_bytestr</span></span> = (bytecode_array) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>XXX: We&#39;d like to use String.fromCharCode(bytecode_array...)
 but that fails on Webkit with arrays longer than 2^31. See issue #129 for details.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> (String.fromCharCode(b) <span class="keyword">for</span> b <span class="keyword">in</span> bytecode_array).join <span class="string">''</span>

root.<span class="function"><span class="title">parse_flags</span></span> = (flag_byte) -&gt; {
  public:       flag_byte &amp; <span class="number">0x1</span>
  private:      flag_byte &amp; <span class="number">0x2</span>
  protected:    flag_byte &amp; <span class="number">0x4</span>
  static:       flag_byte &amp; <span class="number">0x8</span>
  final:        flag_byte &amp; <span class="number">0x10</span>
  synchronized: flag_byte &amp; <span class="number">0x20</span>
  <span class="keyword">super</span>:        flag_byte &amp; <span class="number">0x20</span>
  volatile:     flag_byte &amp; <span class="number">0x40</span>
  transient:    flag_byte &amp; <span class="number">0x80</span>
  <span class="reserved">native</span>:       flag_byte &amp; <span class="number">0x100</span>
  interface:    flag_byte &amp; <span class="number">0x200</span>
  abstract:     flag_byte &amp; <span class="number">0x400</span>
  strict:       flag_byte &amp; <span class="number">0x800</span>
}

root.<span class="function"><span class="title">escape_whitespace</span></span> = (str) -&gt;
  str.replace <span class="regexp">/\s/g</span>, (c) -&gt;
    <span class="keyword">switch</span> c
      <span class="keyword">when</span> <span class="string">"\n"</span> <span class="keyword">then</span> <span class="string">"\\n"</span>
      <span class="keyword">when</span> <span class="string">"\r"</span> <span class="keyword">then</span> <span class="string">"\\r"</span>
      <span class="keyword">when</span> <span class="string">"\t"</span> <span class="keyword">then</span> <span class="string">"\\t"</span>
      <span class="keyword">when</span> <span class="string">"\v"</span> <span class="keyword">then</span> <span class="string">"\\v"</span>
      <span class="keyword">when</span> <span class="string">"\f"</span> <span class="keyword">then</span> <span class="string">"\\f"</span>
      <span class="keyword">else</span> c</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>if :entry is a reference, display its referent in a comment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">format_extra_info</span></span> = (entry) -&gt;
  type = entry.type
  info = entry.deref?()
  <span class="keyword">return</span> <span class="string">""</span> <span class="keyword">unless</span> info
  <span class="keyword">switch</span> type
    <span class="keyword">when</span> <span class="string">'Method'</span>, <span class="string">'InterfaceMethod'</span>
      <span class="string">"\t//  <span class="subst">#{info.class}</span>.<span class="subst">#{info.sig}</span>"</span>
    <span class="keyword">when</span> <span class="string">'Field'</span>
      <span class="string">"\t//  <span class="subst">#{info.class}</span>.<span class="subst">#{info.name}</span>:<span class="subst">#{info.type}</span>"</span>
    <span class="keyword">when</span> <span class="string">'NameAndType'</span> <span class="keyword">then</span> <span class="string">"//  <span class="subst">#{info.name}</span>:<span class="subst">#{info.type}</span>"</span>
    <span class="keyword">else</span> <span class="string">"\t//  "</span> + root.escape_whitespace info <span class="keyword">if</span> root.is_string info

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">BytesArray</span></span>
  constructor: (<span class="property">@raw_array</span>, <span class="property">@start</span>=<span class="number">0</span>, <span class="property">@end</span>=<span class="property">@raw_array</span>.length) -&gt;
    <span class="property">@_index</span> = <span class="number">0</span>

  rewind: -&gt; <span class="property">@_index</span> = <span class="number">0</span>

  pos: -&gt; <span class="property">@_index</span>

  skip: (bytes_count) -&gt; <span class="property">@_index</span> += bytes_count

  has_bytes: -&gt; <span class="property">@start</span> + <span class="property">@_index</span> &lt; <span class="property">@end</span>

  get_uint: (bytes_count) -&gt;
    rv = root.read_uint <span class="property">@raw_array</span>.slice(<span class="property">@start</span> + <span class="property">@_index</span>, <span class="property">@start</span> + <span class="property">@_index</span> + bytes_count)
    <span class="property">@_index</span> += bytes_count
    <span class="keyword">return</span> rv

  get_int: (bytes_count) -&gt;
    bytes_to_set = <span class="number">32</span> - bytes_count * <span class="number">8</span>
    <span class="property">@get_uint</span>(bytes_count) &lt;&lt; bytes_to_set &gt;&gt; bytes_to_set

  read: (bytes_count) -&gt;
    rv = <span class="property">@raw_array</span>[<span class="property">@start</span>+<span class="property">@_index</span>...<span class="property">@start</span>+<span class="property">@_index</span>+bytes_count]
    <span class="property">@_index</span> += bytes_count
    rv

  peek: -&gt; <span class="property">@raw_array</span>[<span class="property">@start</span>+<span class="property">@_index</span>]

  size: -&gt; <span class="property">@end</span> - <span class="property">@start</span> - <span class="property">@_index</span>

  splice: (len) -&gt;
    arr = <span class="keyword">new</span> root.BytesArray <span class="property">@raw_array</span>, <span class="property">@start</span>+<span class="property">@_index</span>, <span class="property">@start</span>+<span class="property">@_index</span>+len
    <span class="property">@_index</span> += len
    arr

root.<span class="function"><span class="title">initial_value</span></span> = (type_str) -&gt;
  <span class="keyword">if</span> type_str <span class="keyword">is</span> <span class="string">'J'</span> <span class="keyword">then</span> gLong.ZERO
  <span class="keyword">else</span> <span class="keyword">if</span> type_str[<span class="number">0</span>] <span class="keyword">in</span> [<span class="string">'['</span>,<span class="string">'L'</span>] <span class="keyword">then</span> <span class="literal">null</span>
  <span class="keyword">else</span> <span class="number">0</span>

root.<span class="function"><span class="title">is_string</span></span> = (obj) -&gt; <span class="keyword">typeof</span> obj == <span class="string">'string'</span> <span class="keyword">or</span> obj <span class="keyword">instanceof</span> String</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Java classes are represented internally using slashes as delimiters.
These helper functions convert between the two representations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.ext_classname = (str) -&gt; root.descriptor2typestr(str).replace /\//g, '.'
root.int_classname = (str) -&gt; root.typestr2descriptor(str).replace /\./g, '/'

root.internal2external =
  B: 'byte'
  C: 'char'
  D: 'double'
  F: 'float'
  I: 'int'
  J: 'long'
  S: 'short'
  V: 'void'
  Z: 'boolean'

external2internal = {}
external2internal[v]=k for k,v of root.internal2external</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Get the component type of an array type string. Cut off the [L and ; for
arrays of classes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">get_component_type</span></span> = (type_str) -&gt; type_str[<span class="number">1.</span>..]
root.<span class="function"><span class="title">is_array_type</span></span> = (type_str) -&gt; type_str[<span class="number">0</span>] == <span class="string">'['</span>
root.<span class="function"><span class="title">is_primitive_type</span></span> = (type_str) -&gt; type_str <span class="keyword">of</span> root.internal2external
root.<span class="function"><span class="title">is_reference_type</span></span> = (type_str) -&gt; type_str[<span class="number">0</span>] == <span class="string">'L'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Converts type descriptors into standardized internal type strings.
Ljava/lang/Class; =&gt; java/lang/Class   Reference types
[Ljava/lang/Class; is unchanged        Array types
C =&gt; char                              Primitive types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">descriptor2typestr</span></span> = (type_str) -&gt;
  c = type_str[<span class="number">0</span>]
  <span class="keyword">if</span> c <span class="keyword">of</span> root.internal2external
    root.internal2external[c]
  <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'L'</span>
    type_str[<span class="number">1.</span>..-<span class="number">1</span>]
  <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'['</span>
    type_str
  <span class="keyword">else</span>
    <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Unrecognized type string: <span class="subst">#{type_str}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Takes a character array of concatenated type descriptors and returns/removes the first one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">carr2descriptor</span></span> = (carr) -&gt;
  c = carr.shift()
  <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> c?
  <span class="keyword">if</span> c <span class="keyword">of</span> root.internal2external
    c
  <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'L'</span>
    <span class="string">"L<span class="subst">#{(c <span class="keyword">while</span> (c = carr.shift()) != ';').join('')}</span>;"</span>
  <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'['</span>
    <span class="string">"[<span class="subst">#{root.carr2descriptor(carr)}</span>"</span>
  <span class="keyword">else</span>
    carr.unshift c
    <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Unrecognized descriptor: <span class="subst">#{carr.join ''}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Converts internal type strings into type descriptors. Reverse of descriptor2typestr.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">typestr2descriptor</span></span> = (type_str) -&gt;
  c = type_str[<span class="number">0</span>]
  <span class="keyword">if</span> type_str <span class="keyword">of</span> external2internal
    external2internal[type_str]
  <span class="keyword">else</span> <span class="keyword">if</span> c == <span class="string">'['</span>
    type_str
  <span class="keyword">else</span>
    <span class="string">"L<span class="subst">#{type_str}</span>;"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Parse Java&#39;s pseudo-UTF-8 strings. (spec 4.4.7)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">bytes2str</span></span> = (bytes, null_terminate=<span class="literal">false</span>) -&gt;
  idx = <span class="number">0</span>
  char_array =
    <span class="keyword">while</span> idx &lt; bytes.length</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>cast to an unsigned byte</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      x = bytes[idx++] &amp; <span class="number">0xff</span>
      <span class="keyword">break</span> <span class="keyword">if</span> null_terminate <span class="keyword">and</span> x <span class="keyword">is</span> <span class="number">0</span>
      String.fromCharCode(
        <span class="keyword">if</span> x &lt;= <span class="number">0x7f</span>
          x
        <span class="keyword">else</span> <span class="keyword">if</span> x &lt;= <span class="number">0xdf</span>
          y = bytes[idx++]
          ((x &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">6</span>) + (y &amp; <span class="number">0x3f</span>)
        <span class="keyword">else</span>
          y = bytes[idx++]
          z = bytes[idx++]
          ((x &amp; <span class="number">0xf</span>) &lt;&lt; <span class="number">12</span>) + ((y &amp; <span class="number">0x3f</span>) &lt;&lt; <span class="number">6</span>) + (z &amp; <span class="number">0x3f</span>)
      )
  char_array.join <span class="string">''</span>

root.<span class="function"><span class="title">last</span></span> = (array) -&gt; array[array.length-<span class="number">1</span>]

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">SafeMap</span></span>

  constructor: -&gt;
    <span class="property">@cache</span> = Object.create <span class="literal">null</span> <span class="comment"># has no defined properties aside from __proto__</span>
    <span class="property">@proto_cache</span> = <span class="literal">undefined</span>

  get: (key) -&gt;
    <span class="keyword">return</span> <span class="property">@cache</span>[key] <span class="keyword">if</span> <span class="property">@cache</span>[key]? <span class="comment"># don't use `isnt undefined` -- __proto__ is null!</span>
    <span class="keyword">return</span> <span class="property">@proto_cache</span> <span class="keyword">if</span> key.toString() <span class="keyword">is</span> <span class="string">'__proto__'</span> <span class="keyword">and</span> <span class="property">@proto_cache</span> <span class="keyword">isnt</span> <span class="literal">undefined</span>
    <span class="literal">undefined</span>

  has: (key) -&gt; <span class="property">@get</span>(key) <span class="keyword">isnt</span> <span class="literal">undefined</span>

  set: (key, value) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>toString() converts key to a primitive, so strict comparison works</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">unless</span> key.toString() <span class="keyword">is</span> <span class="string">'__proto__'</span>
      <span class="property">@cache</span>[key] = value
    <span class="keyword">else</span>
      <span class="property">@proto_cache</span> = value</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
