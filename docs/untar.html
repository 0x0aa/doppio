<!DOCTYPE html>

<html>
<head>
  <title>untar.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>untar.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>root = <span class="keyword">this</span>

util = require <span class="string">'../src/util'</span>

asyncExecute = <span class="keyword">this</span>.asyncExecute ? (require <span class="string">'./util'</span>).asyncExecute

<span class="string">"use strict"</span>

root.<span class="function"><span class="title">untar</span></span> = (bytes, cb, done_cb) -&gt;
  <span class="function"><span class="title">next_file</span></span> = -&gt;
    [path,body] = shift_file(bytes)
    percent = bytes.pos() / bytes.size()
    cb percent, path, body
    <span class="keyword">if</span> bytes.peek() != <span class="number">0</span>
      asyncExecute next_file
    <span class="keyword">else</span>
      done_cb?()
  asyncExecute next_file, <span class="number">0</span>

<span class="function"><span class="title">shift_file</span></span> = (bytes) -&gt;
  header = bytes.read(<span class="number">512</span>)
  fname = util.bytes2str header[<span class="number">0.</span>.<span class="number">.100</span>], <span class="literal">true</span>
  size = octal2num header[<span class="number">124.</span>.<span class="number">.124</span>+<span class="number">11</span>]
  prefix = util.bytes2str header[<span class="number">345.</span>.<span class="number">.345</span>+<span class="number">155</span>], <span class="literal">true</span>
  fullname = <span class="keyword">if</span> prefix <span class="keyword">then</span> <span class="string">"<span class="subst">#{prefix}</span>/<span class="subst">#{fname}</span>"</span> <span class="keyword">else</span> fname

  body = bytes.read(Math.ceil(size/<span class="number">512</span>)*<span class="number">512</span>)
  file = body[<span class="number">0.</span>..size]
  [fullname, file]

<span class="function"><span class="title">octal2num</span></span> = (bytes) -&gt;
  num = <span class="number">0</span>
  msd = bytes.length - <span class="number">1</span>
  <span class="keyword">for</span> b, idx <span class="keyword">in</span> bytes
    digit = parseInt String.fromCharCode b
    num += digit * Math.pow <span class="number">8</span>, (msd - idx)
  num

<span class="keyword">if</span> module? <span class="keyword">and</span> <span class="keyword">not</span> module.parent
  fs = require <span class="string">'fs'</span>
  data = <span class="keyword">new</span> util.BytesArray util.bytestr_to_array fs.readFileSync <span class="string">'/dev/stdin'</span>, <span class="string">'binary'</span>
  root.untar data, (percent, path, file) -&gt;
    console.log path</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
