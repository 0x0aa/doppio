<!DOCTYPE html>

<html>
<head>
  <title>node.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>node.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>win = window
<span class="string">"use strict"</span>

root = win.node = {}
<span class="function"><span class="title">basename</span></span> = (path) -&gt; path.split(<span class="string">'/'</span>).pop()
win.<span class="function"><span class="title">require</span></span> = (path, herp) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>XXX: Hackfix for Ace Editor. The Ace Editor clobbers our require definiton,
but recalls it with an empty first argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> herp? <span class="keyword">then</span> path = herp
  [name, ext] = basename(path).split <span class="string">'.'</span>
  window[name] ?= {}

_ = require <span class="string">'../vendor/_.js'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>IE9 and below only: Injects a VBScript function that converts the
&#39;responseBody&#39; attribute of an XMLHttpRequest into a bytestring.
Credit: <a href="http://miskun.com/javascript/internet-explorer-and-binary-files-data-access/#comment-11">http://miskun.com/javascript/internet-explorer-and-binary-files-data-access/#comment-11</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">inject_vbscript</span></span> = -&gt;
  IEBinaryToArray_ByteStr_Script =
    <span class="string">"&lt;!-- IEBinaryToArray_ByteStr --&gt;\r\n"</span>+
    <span class="string">"&lt;script type='text/vbscript'&gt;\r\n"</span>+
    <span class="string">"Function IEBinaryToArray_ByteStr(Binary)\r\n"</span>+
    <span class="string">"   IEBinaryToArray_ByteStr = CStr(Binary)\r\n"</span>+
    <span class="string">"End Function\r\n"</span>+
    <span class="string">"Function IEBinaryToArray_ByteStr_Last(Binary)\r\n"</span>+
    <span class="string">"   Dim lastIndex\r\n"</span>+
    <span class="string">"   lastIndex = LenB(Binary)\r\n"</span>+
    <span class="string">"   if lastIndex mod 2 Then\r\n"</span>+
    <span class="string">"       IEBinaryToArray_ByteStr_Last = Chr( AscB( MidB( Binary, lastIndex, 1 ) ) )\r\n"</span>+
    <span class="string">"   Else\r\n"</span>+
    <span class="string">"       IEBinaryToArray_ByteStr_Last = "</span>+<span class="string">'""'</span>+<span class="string">"\r\n"</span>+
    <span class="string">"   End If\r\n"</span>+
    <span class="string">"End Function\r\n"</span>+
    <span class="string">"&lt;/script&gt;\r\n"</span>

  document.write(IEBinaryToArray_ByteStr_Script)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Run once at JavaScript load time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> $.browser.msie <span class="keyword">and</span> <span class="keyword">not</span> window.Blob
  inject_vbscript()</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Converts &#39;responseBody&#39; in IE into the equivalent &#39;responseText&#39; that other
browsers would generate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">GetIEByteArray_ByteStr</span></span> = (IEByteArray) -&gt;
  rawBytes = IEBinaryToArray_ByteStr(IEByteArray)
  lastChr = IEBinaryToArray_ByteStr_Last(IEByteArray)
  <span class="keyword">return</span> rawBytes.replace(<span class="regexp">/[\s\S]/g</span>,
    ((match) -&gt;
      v = match.charCodeAt(<span class="number">0</span>)
      <span class="keyword">return</span> String.fromCharCode(v&amp;<span class="number">0xff</span>, v&gt;&gt;<span class="number">8</span>)
    )) + lastChr</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Used for process.nextTick(). Using postMessage is <em>much</em> faster than using
setTimeout(fn, 0).
Credit for idea and example implementation goes to:
<a href="http://dbaron.org/log/20100309-faster-timeouts">http://dbaron.org/log/20100309-faster-timeouts</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>timeouts = []
messageName = <span class="string">"zero-timeout-message"</span>

<span class="function"><span class="title">setZeroTimeout</span></span> = (fn) -&gt;
  timeouts.push(fn)
  window.postMessage(messageName, <span class="string">"*"</span>)

<span class="function"><span class="title">handleMessage</span></span> = (event) -&gt;
  <span class="keyword">if</span> (event.source == window &amp;&amp; event.data == messageName)
    event.stopPropagation()
    <span class="keyword">if</span> (timeouts.length &gt; <span class="number">0</span>)
      fn = timeouts.shift()
      fn()

window.addEventListener(<span class="string">"message"</span>, handleMessage, <span class="literal">true</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Our &#39;file descriptor&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">DoppioFile</span></span>
  <span class="property">@fromJSON</span>: (path, rawData) -&gt;
    data = JSON.parse rawData
    <span class="keyword">new</span> DoppioFile(path, data.data, data.mtime, <span class="literal">false</span>, data.mode)

  constructor: (<span class="property">@path</span>, <span class="property">@data</span> = <span class="string">""</span>, <span class="property">@mtime</span> = (<span class="keyword">new</span> Date).getTime(), <span class="property">@mod</span> = <span class="literal">false</span>, <span class="property">@mode</span> = <span class="number">0</span>o644) -&gt;

  read: (length, pos) -&gt;
    <span class="keyword">return</span> <span class="property">@data</span> <span class="keyword">unless</span> length?
    <span class="property">@data</span>.substr(pos, length)

  write: (newData, pos) -&gt;
    <span class="property">@mod</span> = <span class="literal">true</span>
    <span class="keyword">if</span> pos? <span class="keyword">and</span> pos &lt; <span class="property">@data</span>.length
      <span class="property">@data</span> = <span class="property">@data</span>.slice(<span class="number">0</span>,pos) + newData + <span class="property">@data</span>.slice(pos+newData.length)
    <span class="keyword">else</span>
      <span class="property">@data</span> += newData
    <span class="keyword">return</span> @

  toJSON: -&gt;
    JSON.stringify
      data: <span class="property">@data</span>
      mtime: <span class="property">@mtime</span>
      mode: <span class="property">@mode</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Helper object. Used by some FileSources to maintain an index of files.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">FileIndex</span></span>
  constructor: (<span class="property">@index</span> = {}) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Get subcomponents of the given path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _subcomponents: (path) -&gt;
    components = path.split <span class="string">'/'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Get rid of first slash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    components.shift()</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Special case: Root</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> components.length == <span class="number">1</span> <span class="keyword">and</span> components[<span class="number">0</span>] == <span class="string">''</span> <span class="keyword">then</span> [] <span class="keyword">else</span> components
  _add_file: (components, fname, file) -&gt;
    dir = <span class="property">@_mkdir</span>(components)
    dir[fname] = file
    <span class="keyword">return</span>
  _mkdir: (components) -&gt;
    cur_dir = <span class="property">@index</span>
    <span class="keyword">for</span> c <span class="keyword">in</span> components
      cur_dir[c] ?= {}
      cur_dir = cur_dir[c]
    <span class="keyword">return</span> cur_dir
  _get: (components) -&gt;
    cur_dir = <span class="property">@index</span>
    <span class="keyword">for</span> c <span class="keyword">in</span> components
      <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> c <span class="keyword">of</span> cur_dir
      cur_dir = cur_dir[c]
    <span class="keyword">return</span> cur_dir
  _is_directory: (obj) -&gt; obj? <span class="keyword">and</span> !(obj <span class="keyword">instanceof</span> DoppioFile)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Add the given file to the index. Implicitly creates directories if needed
and overwrites things without checking.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  add_file: (path, file) -&gt;
    components = <span class="property">@_subcomponents</span>(path)
    fname = components.pop()
    <span class="property">@_add_file</span>(components, fname, file)
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Retrieves the given file. Returns &#39;false&#39; if the file does not exist, or if
it is a directory. Otherwise, returns the file (which may be null).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get_file: (path) -&gt;
    components = <span class="property">@_subcomponents</span>(path)
    f = <span class="property">@_get</span>(components)
    <span class="keyword">return</span> f <span class="keyword">unless</span> f <span class="keyword">is</span> <span class="literal">false</span> <span class="keyword">or</span> <span class="property">@_is_directory</span>(f)
    <span class="keyword">return</span> <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Returns a directory listing, or null if the directory does not exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ls: (path) -&gt;
    components = <span class="property">@_subcomponents</span>(path)
    dir = <span class="property">@_get</span>(components)
    <span class="keyword">return</span> Object.keys(dir) <span class="keyword">unless</span> dir <span class="keyword">is</span> <span class="literal">false</span> <span class="keyword">or</span> !<span class="property">@_is_directory</span>(dir)
    <span class="keyword">return</span> <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Makes the given directory. Implicitly creates needed subdirectories.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mkdir: (path) -&gt;
    components = <span class="property">@_subcomponents</span>(path)
    <span class="property">@_mkdir</span>(components)
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Returns the parent directory of path or false.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parent: (path) -&gt;
    components = <span class="property">@_subcomponents</span>(path)
    components.pop()
    <span class="keyword">return</span> <span class="property">@_get</span> components</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Removes the given path, directory or not, from the index. This is a
recursive delete. Returns the paths to the files that were deleted if this
was a directory, otherwise returns true if a file was deleted, false if
the path did not exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rm: (path) -&gt;
    components = <span class="property">@_subcomponents</span>(path)
    name = components.pop()
    parent = <span class="property">@_get</span>(components)
    ret = <span class="literal">false</span>
    <span class="keyword">if</span> parent? <span class="keyword">and</span> parent != <span class="literal">false</span>
      <span class="keyword">if</span> name <span class="keyword">of</span> parent
        obj = parent[name]
        ret = <span class="keyword">if</span> <span class="property">@_is_directory</span>(obj) <span class="keyword">then</span> Object.keys(obj) <span class="keyword">else</span> <span class="literal">true</span>
        <span class="keyword">delete</span> parent[name]
    <span class="keyword">return</span> ret</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Interface for a FileSource. Somewhat of a misnomer, as they are also sinks...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">FileSource</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Set to &#39;true&#39; if this FileSource is redundant to another in some way.
This signals that it should be written to / deleted from, even if another
applicable source has an identical file or directory path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  redundant_storage: <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>A handy method for sources that store/retrieve data using a relative file
name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _trim_mnt_pt: (path) -&gt; path.slice(<span class="property">@mnt_pt</span>.length)

  constructor: (<span class="property">@mnt_pt</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>INTERFACE METHODS
Fetches file at path; DoppioFile for success, null for failure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fetch: (path) -&gt; <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Stores file to path; true for success, false for failure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  store: (path, file) -&gt; <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Removes the file or folder at the given path. Returns true for success.
If there are files in the folder, it automatically recurses.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rm: (path) -&gt; <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Returns a directory listing for the given path, or null if it does not
exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ls: (path) -&gt; <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Moves a file or directory from path1 to path2. Returns true on success,
false otherwise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mv: (path1, path2, isFile = <span class="literal">true</span>) -&gt; <span class="literal">false</span>
  mkdir: (path1) -&gt; <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Composes multiple file sources into one file source. Prioritizes file sources
in the order in which they are added.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">CompositedFileSource</span> <span class="keyword">extends</span> <span class="title">FileSource</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Returns &#39;true&#39; if the given path is in the given mount point.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _in_mnt_pt: (path, mnt_pt) -&gt; mnt_pt == <span class="string">'/'</span> <span class="keyword">or</span> path == mnt_pt <span class="keyword">or</span>
    (path.slice(<span class="number">0</span>, mnt_pt.length) == mnt_pt <span class="keyword">and</span> path[mnt_pt.length] == <span class="string">'/'</span>)
  _get_applicable_sources: (path) -&gt;
    applicable = []
    <span class="keyword">for</span> a_mnt_pt <span class="keyword">in</span> <span class="property">@mnt_pts</span>
      applicable.push(<span class="property">@sources</span>[a_mnt_pt]) <span class="keyword">if</span> <span class="property">@_in_mnt_pt</span>(path, a_mnt_pt)
    <span class="keyword">return</span> applicable

  constructor: (mnt_pt, inpt_sources = []) -&gt;
    <span class="keyword">super</span>(mnt_pt)
    <span class="property">@sources</span> = {}
    <span class="property">@mnt_pts</span> = []
    <span class="property">@redundant_storage</span> = <span class="literal">false</span>
    <span class="keyword">for</span> source <span class="keyword">in</span> inpt_sources
      <span class="property">@add_source</span>(source)

  add_source: (source) -&gt;
    <span class="property">@sources</span>[source.mnt_pt] = source
    <span class="property">@mnt_pts</span>.push(source.mnt_pt)
    <span class="property">@redundant_storage</span> ||= source.redundant_storage
    <span class="keyword">return</span>

  fetch: (path) -&gt;
    applicable = <span class="property">@_get_applicable_sources</span>(path)
    <span class="keyword">for</span> parent <span class="keyword">in</span> applicable
      f = parent.fetch(path)
      <span class="keyword">return</span> f <span class="keyword">if</span> f?
    <span class="keyword">return</span> <span class="literal">null</span>

  store: (path, file) -&gt;
    applicable = <span class="property">@_get_applicable_sources</span>(path)
    stored = <span class="literal">false</span>
    <span class="keyword">for</span> source <span class="keyword">in</span> applicable
      stored = source.store(path, file) || stored <span class="keyword">unless</span> stored <span class="keyword">and</span> !source.redundant_storage
    <span class="keyword">return</span> stored

  rm: (path) -&gt;
    applicable = <span class="property">@_get_applicable_sources</span>(path)
    removed = <span class="literal">false</span>
    <span class="keyword">for</span> source <span class="keyword">in</span> applicable
      removed = source.rm(path) || removed <span class="keyword">unless</span> removed <span class="keyword">and</span> !source.redundant_storage
    <span class="keyword">return</span> removed

  ls: (path) -&gt;
    applicable = <span class="property">@_get_applicable_sources</span>(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Initialize to &#39;null&#39; so that we return &#39;null&#39; if the path is not present
in any applicable FileSources. Note that &#39;null&#39; != [], as the latter is
an existing-but-empty directory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    list = <span class="literal">null</span>
    <span class="keyword">for</span> source <span class="keyword">in</span> applicable
      src_list = source.ls(path)
      <span class="keyword">if</span> src_list?
        list = <span class="keyword">if</span> list? <span class="keyword">then</span> _.union(list, src_list) <span class="keyword">else</span> src_list
    <span class="keyword">return</span> list

  mv: (path1, path2, isFile = <span class="literal">true</span>) -&gt;
    applicable = <span class="property">@_get_applicable_sources</span>(path1)
    moved = <span class="literal">false</span>
    <span class="keyword">for</span> source <span class="keyword">in</span> applicable
      moved = source.mv(path1, path2, isFile) || moved
    <span class="keyword">return</span> moved

  mkdir: (path) -&gt;
    applicable = <span class="property">@_get_applicable_sources</span> path
    dirmade = <span class="literal">false</span>
    <span class="keyword">for</span> source <span class="keyword">in</span> applicable
      dirmade ||= source.mkdir path
    <span class="keyword">return</span> dirmade

<span class="class"><span class="keyword">class</span> <span class="title">LocalStorageSource</span> <span class="keyword">extends</span> <span class="title">FileSource</span></span>
  redundant_storage: <span class="literal">true</span>
  constructor: (mnt_pt) -&gt;
    <span class="keyword">super</span>(mnt_pt)</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Index of all files in LS.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@index</span> = <span class="keyword">new</span> FileIndex()</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Initialize index w/ LS files and directories.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..localStorage.length]
      <span class="property">@index</span>.add_file(localStorage.key(i), <span class="literal">null</span>)

  fetch: (path) -&gt;
    data = localStorage.getItem path
    <span class="keyword">if</span> data? <span class="keyword">then</span> DoppioFile.fromJSON(path, data) <span class="keyword">else</span> <span class="literal">null</span>
  store: (path, file) -&gt;
    <span class="keyword">try</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>XXX: Don&#39;t store if a temporary file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> file.mod <span class="keyword">and</span> <span class="keyword">not</span> file.temp
        localStorage.setItem path, file.toJSON()
      <span class="property">@index</span>.add_file(path, file)
      <span class="keyword">return</span> <span class="literal">true</span>
    <span class="keyword">catch</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Probably out of space.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">return</span> <span class="literal">false</span>
  rm: (path) -&gt;
    listing = <span class="property">@index</span>.rm(path)
    <span class="keyword">if</span> <span class="keyword">typeof</span> listing != <span class="string">'boolean'</span>
      <span class="keyword">for</span> item <span class="keyword">in</span> listing
        itPath = path + <span class="string">'/'</span> + item
        localStorage.removeItem itPath
    <span class="keyword">else</span> <span class="keyword">if</span> localStorage.getItem(path)?
      localStorage.removeItem(path)
    <span class="keyword">else</span>
      <span class="keyword">return</span> <span class="literal">false</span>
    <span class="keyword">return</span> <span class="literal">true</span>

  ls: (path) -&gt; <span class="property">@index</span>.ls(path)
  mv: (path1, path2, isFile = <span class="literal">true</span>) -&gt;
    <span class="keyword">if</span> isFile
      file1_obj = <span class="property">@fetch</span>(path1)
      <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> file1_obj? <span class="keyword">and</span> <span class="property">@rm</span> path1
      file1_obj.path = path2</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>XXX: Bit of a hack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      file1_obj.mod = <span class="literal">true</span>
      <span class="property">@store</span> path2, file1_obj
    <span class="keyword">else</span>
      file1_ls = <span class="property">@index</span>.ls(path1)
      <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> file1_ls?</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Make path2.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@index</span>.mkdir path2</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Move every file from p1 to p2.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> f_name <span class="keyword">in</span> file1_ls
        <span class="property">@mv</span> f_name, path2 + f_name.substr(path1.length), <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Delete p1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@index</span>.rm path1
    <span class="keyword">return</span> <span class="literal">true</span>
  mkdir: (path) -&gt;
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> <span class="property">@index</span>.parent path
    <span class="property">@index</span>.mkdir(path)
    <span class="keyword">return</span> <span class="literal">true</span>

<span class="class"><span class="keyword">class</span> <span class="title">WebserverSource</span> <span class="keyword">extends</span> <span class="title">FileSource</span></span>
  _download_file: (path) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Ensure the file is in the index.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">if</span> <span class="property">@index</span>? <span class="keyword">and</span> <span class="property">@index</span>.get_file(<span class="property">@mnt_pt</span> + path) == <span class="literal">false</span>
    data = <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>The below code is complicated because we can&#39;t do a &#39;text&#39; request in IE;
it truncates the response at the first NULL character.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="keyword">not</span> $.browser.msie
      $.ajax path, {
        type: <span class="string">'GET'</span>
        dataType: <span class="string">'text'</span>
        async: <span class="literal">false</span>
        beforeSend: (jqXHR) -&gt; jqXHR.overrideMimeType(<span class="string">'text/plain; charset=x-user-defined'</span>)
        success: (theData, status, jqxhr) -&gt; data = theData
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>IE 10+ path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span> <span class="keyword">if</span> window.Blob</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>In IE10, we can do a &#39;blob&#39; request to get a binary blob that we can
convert into a string.
jQuery&#39;s &#39;ajax&#39; function does not support blob requests, so we&#39;re going
to use XMLHttpRequest directly.
Furthermore, the code below will <em>NOT</em> work in Firefox or Chrome, since
they do not allow synchronous blob or arraybuffer requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      req = <span class="keyword">new</span> XMLHttpRequest()
      req.open(<span class="string">'GET'</span>, path, <span class="literal">false</span>)
      req.responseType = <span class="string">'arraybuffer'</span>
      req.send()
      <span class="keyword">if</span> req.status == <span class="number">200</span>
        typed_array = <span class="keyword">new</span> Uint8Array(req.response)
        array = []
        <span class="keyword">for</span> char, i <span class="keyword">in</span> typed_array
          array[i] = String.fromCharCode(char)
        data = array.join(<span class="string">""</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>IE &lt; 10 path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>In earlier versions of IE, we can retrieve the &#39;responseBody&#39;
attribute of the response (which contains the <em>entire</em> response).
Since it&#39;s an unsigned array, JavaScript can&#39;t touch it, so we
pass it to VBScript code that can convert it into something
JavaScript can process.
Note that this approach also works in IE10 for x86 platforms, but
not for ARM platforms which do not have VBScript support.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      req = <span class="keyword">new</span> XMLHttpRequest()
      req.open(<span class="string">'GET'</span>, path, <span class="literal">false</span>)
      req.setRequestHeader(<span class="string">"Accept-Charset"</span>, <span class="string">"x-user-defined"</span>)
      req.send()
      <span class="keyword">if</span> req.status == <span class="number">200</span>
        data = GetIEByteArray_ByteStr(req.responseBody)

    <span class="keyword">return</span> data
  constructor: (mnt_pt, listings_path) -&gt;
    <span class="keyword">super</span>(mnt_pt)
    <span class="keyword">if</span> listings_path?
      idx_data = <span class="property">@_download_file</span>(listings_path)
    <span class="property">@index</span> = <span class="keyword">new</span> FileIndex(<span class="keyword">if</span> idx_data? <span class="keyword">then</span> JSON.parse(idx_data) <span class="keyword">else</span> )
  fetch: (path) -&gt;
    f = <span class="property">@index</span>.get_file(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>File does not exist on the webserver according to the index, or has been
&quot;deleted&quot;.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">if</span> f <span class="keyword">is</span> <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Fetch the file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    trim_path = <span class="property">@_trim_mnt_pt</span>(path)
    data = <span class="property">@_download_file</span>(trim_path)
    <span class="keyword">return</span> <span class="keyword">if</span> data? <span class="keyword">then</span> <span class="keyword">new</span> DoppioFile(path, data) <span class="keyword">else</span> <span class="literal">null</span>
  ls: (path) -&gt; <span class="property">@index</span>.ls(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Deletions occur only on our index to make the files &#39;invisible&#39; to the
application.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rm: (path) -&gt; <span class="property">@index</span>.rm(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Wraps another FileSource and acts as its cache.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">CacheSource</span> <span class="keyword">extends</span> <span class="title">FileSource</span></span>
  constructor: (mnt_pt, src) -&gt;
    <span class="keyword">super</span>(mnt_pt)
    <span class="property">@src</span> = src
    <span class="property">@redundant_storage</span> = src.redundant_storage
    <span class="property">@index</span> = <span class="keyword">new</span> FileIndex()
  fetch: (path) -&gt;
    f = <span class="property">@index</span>.get_file(path)
    <span class="keyword">if</span> f == <span class="literal">false</span>
      f = <span class="property">@src</span>.fetch(path)
      <span class="property">@index</span>.add_file(path, f) <span class="keyword">if</span> f?
    <span class="keyword">return</span> f
  store: (path, file) -&gt;
    <span class="keyword">if</span> <span class="property">@src</span>.store(path, file)
      <span class="property">@index</span>.add_file(path, file)
      <span class="keyword">return</span> <span class="literal">true</span>
    <span class="keyword">return</span> <span class="literal">false</span>
  rm: (path) -&gt;
    <span class="keyword">if</span> <span class="property">@src</span>.rm(path)
      <span class="property">@index</span>.rm(path)
      <span class="keyword">return</span> <span class="literal">true</span>
    <span class="keyword">return</span> <span class="literal">false</span>
  ls: (path) -&gt; <span class="property">@src</span>.ls(path)
  mkdir: (path) -&gt; <span class="property">@src</span>.mkdir(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>ignoreSrc is used internally only.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mv: (file1, file2, isFile = <span class="literal">true</span>, ignoreSrc = <span class="literal">false</span>) -&gt;
    success = <span class="keyword">if</span> ignoreSrc <span class="keyword">then</span> <span class="literal">true</span> <span class="keyword">else</span> <span class="property">@src</span>.mv file1, file2, isFile</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Move any cached copies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> isFile
      f = <span class="property">@index</span>.get_file file1
      <span class="keyword">if</span> f
        f.path = file2
        <span class="property">@index</span>.rm file1
        <span class="property">@index</span>.add_file file2, f
    <span class="keyword">else</span>
      ls = <span class="property">@index</span>.ls file1
      <span class="keyword">for</span> f_name <span class="keyword">in</span> ls
        <span class="property">@mv</span> f_name, path2 + f_name.substr(path1.length), <span class="literal">true</span>, <span class="literal">true</span>
      <span class="property">@index</span>.rm file1
    <span class="keyword">return</span> success</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Stores the File System&#39;s current state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">FSState</span></span>
  constructor: -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Files fetched from webserver are always represented internally as relative
to home.
(mnt_pt, inpt_sources = [])</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@home</span> = <span class="string">'/home/doppio'</span>
    <span class="property">@pwd</span> = <span class="property">@home</span>
    mainSource = <span class="keyword">new</span> CompositedFileSource(<span class="string">'/'</span>, [<span class="keyword">new</span> LocalStorageSource(<span class="string">'/'</span>),
      <span class="keyword">new</span> WebserverSource(<span class="string">'/home/doppio'</span>, <span class="string">'/browser/listings.json'</span>)])
    <span class="property">@files</span> = <span class="keyword">new</span> CacheSource(<span class="string">'/'</span>, mainSource)</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Slight cheat; ensures that / and /home exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    f = <span class="keyword">new</span> DoppioFile(<span class="string">'/home/doppio/Hello.txt'</span>, <span class="string">"Welcome to Doppio!"</span>)
    f.mod = <span class="literal">true</span>
    <span class="property">@files</span>.store <span class="string">'/home/doppio/Hello.txt'</span>, f</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Canonicalizes the given path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resolve: (path) -&gt;
    components = path.split <span class="string">'/'</span>
    absolute = path[<span class="number">0</span>] == <span class="string">'/'</span>
    <span class="keyword">for</span> c, idx <span class="keyword">in</span> components
      components[idx] = <span class="string">''</span> <span class="keyword">if</span> c == <span class="string">'.'</span>
      components[idx] = <span class="property">@home</span> <span class="keyword">if</span> c == <span class="string">'~'</span>
    <span class="keyword">if</span> !absolute
      <span class="keyword">for</span> pwdCmp <span class="keyword">in</span> <span class="property">@pwd</span>.split(<span class="string">'/'</span>) <span class="keyword">by</span> -<span class="number">1</span>
        components.unshift(pwdCmp)
    <span class="keyword">for</span> c, idx <span class="keyword">in</span> components
      <span class="keyword">if</span> c == <span class="string">'..'</span>
        processed = <span class="literal">false</span>
        i = idx-<span class="number">1</span>
        <span class="keyword">while</span> !processed
          <span class="keyword">if</span> i &lt; <span class="number">0</span> <span class="keyword">then</span> processed = <span class="literal">true</span>
          <span class="keyword">if</span> components[i] != <span class="string">''</span>
            components[i] = <span class="string">''</span>
            components[idx] = <span class="string">''</span>
            processed = <span class="literal">true</span>
          i--</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>remove repeated //s</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    path = (c <span class="keyword">for</span> c, idx <span class="keyword">in</span> components <span class="keyword">when</span> c != <span class="string">''</span>).join <span class="string">'/'</span>
    <span class="keyword">if</span> path[<span class="number">0</span>] != <span class="string">'/'</span>
      path = <span class="string">'/'</span> + path
    <span class="keyword">return</span> path</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Retrieves a file from the file system. Creates a new one if needed.
Mode is &#39;r&#39; for read, &#39;w&#39; for write+read, &#39;a&#39; for append+read
Returns &#39;null&#39; if file does not exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  open: (path, mode = <span class="string">'r'</span>) -&gt;
    path = <span class="property">@resolve</span> path
    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">if</span> <span class="property">@is_directory</span>(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Start fresh.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> mode == <span class="string">'w'</span>
      f = <span class="keyword">new</span> DoppioFile(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Ensure writeback when closed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      f.mod = <span class="literal">true</span>
      <span class="keyword">return</span> f
    <span class="keyword">return</span> <span class="property">@files</span>.fetch path

  close: (file) -&gt; <span class="property">@files</span>.store(file.path, file); file.mod = <span class="literal">false</span>; <span class="keyword">return</span>

  list: (path) -&gt; <span class="property">@files</span>.ls(<span class="property">@resolve</span> path)

  is_file: (path) -&gt; <span class="property">@files</span>.fetch(<span class="property">@resolve</span> path)?

  is_directory: (path) -&gt; <span class="property">@list</span>(path)?

  rm: (path, isDir = <span class="literal">false</span>) -&gt;
    path = <span class="property">@resolve</span> path
    <span class="keyword">if</span> <span class="property">@is_directory</span>(path) != isDir <span class="keyword">then</span> <span class="literal">false</span> <span class="keyword">else</span> <span class="property">@files</span>.rm(path)

  chdir: (dir) -&gt;
    dir = <span class="property">@resolve</span>(dir)
    <span class="keyword">if</span> <span class="property">@is_directory</span> dir
      <span class="property">@pwd</span> = dir
      dir
    <span class="keyword">else</span>
      <span class="literal">null</span>

  mkdir: (dir) -&gt;
    dir = <span class="property">@resolve</span>(dir)
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> <span class="property">@is_directory</span> dir <span class="keyword">or</span> <span class="property">@is_file</span> dir
    <span class="keyword">return</span> <span class="property">@files</span>.mkdir dir

  mv: (file1, file2) -&gt;
    file1 = <span class="property">@resolve</span> file1
    file2 = <span class="property">@resolve</span> file2
    <span class="keyword">return</span> <span class="property">@files</span>.mv file1, file2</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Currently a singleton.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>fs_state = <span class="keyword">new</span> FSState()</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap for-h6">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <h6>#</h6>
<p>NODE EMULATION</p>
<h6>#</h6>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Stat</span></span>
  <span class="property">@fromPath</span>: (path) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>XXX: Hack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">if</span> path == <span class="string">''</span>
    <span class="keyword">if</span> fs_state.is_directory path
      stat = <span class="keyword">new</span> Stat
      stat.size = <span class="number">1</span>
      stat.mtime = (<span class="keyword">new</span> Date).getTime()
      stat.is_file = <span class="literal">false</span>
      stat.is_directory = <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>XXX: Shhhh...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      stat.mode = <span class="number">0</span>o644
      stat
    <span class="keyword">else</span>
      file = fs_state.open path, <span class="string">'r'</span>
      <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> file?
      <span class="keyword">new</span> Stat file

  constructor: (<span class="property">@file</span>) -&gt;
    <span class="keyword">if</span> <span class="property">@file</span>?
      <span class="property">@size</span> = <span class="property">@file</span>.data.length
      <span class="property">@mtime</span> = <span class="property">@file</span>.mtime
      <span class="property">@is_file</span> = <span class="literal">true</span>
      <span class="property">@is_directory</span> = <span class="literal">false</span>
      <span class="property">@mode</span> = <span class="property">@file</span>.mode

  isFile: -&gt; <span class="property">@is_file</span>

  isDirectory: -&gt; <span class="property">@is_directory</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>This is a global in Node.JS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">win</span>.<span class="title">Buffer</span></span>
  constructor: (obj) -&gt;
    <span class="keyword">if</span> obj <span class="keyword">instanceof</span> Array
      <span class="property">@array</span> = obj
    <span class="keyword">else</span> <span class="comment"># assume num</span>
      <span class="property">@array</span> = <span class="keyword">new</span> Array obj

  readUInt8: (i) -&gt; <span class="property">@array</span>[i] &amp; <span class="number">0xFF</span>  <span class="comment"># cast to unsigned byte</span>
  readInt8: (i) -&gt; <span class="property">@array</span>[i]</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Node&#39;s filesystem API, implemented as a wrapper around FSState.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.fs =
  statSync: (path) -&gt; Stat.fromPath path
  stat: (path, cb) -&gt;
    stat = root.fs.statSync path
    <span class="keyword">if</span> stat?
      cb <span class="literal">null</span>, stat
    <span class="keyword">else</span>
      cb <span class="keyword">new</span> Error <span class="string">"Invalid file: <span class="subst">#{path}</span>"</span>, <span class="literal">null</span>

  fstatSync: (fp) -&gt; <span class="keyword">new</span> Stat(fp)

  openSync: (path, mode) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>&#39;r&#39; - Open file for reading. An exception occurs if the file does not exist.
&#39;w&#39; - Open file for writing. The file is created (if it does not exist) or truncated (if it exists).
&#39;a&#39; - Open file for appending. The file is created if it does not exist.
Normalize &#39;mode&#39; to the three we care about</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="string">'w'</span> <span class="keyword">in</span> mode <span class="keyword">then</span> mode = <span class="string">'w'</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">'a'</span> <span class="keyword">in</span> mode <span class="keyword">then</span> mode = <span class="string">'a'</span>
    <span class="keyword">else</span> mode = <span class="string">'r'</span>
    f = fs_state.open(path, mode)
    <span class="keyword">unless</span> f?
      err = <span class="keyword">new</span> Error
      err.code = <span class="string">'ENOENT'</span>
      <span class="keyword">throw</span> err
    f

  open: (path, mode, cb) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>mode is optional</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">unless</span> cb?
      cb = mode
      mode = <span class="string">'r'</span>

    <span class="keyword">try</span>
      f = root.fs.openSync path, mode
      cb <span class="literal">null</span>, f
    <span class="keyword">catch</span> e
      cb e

  readSync: (fd, buf, offset, length, pos) -&gt;
    data = fd.read(length, pos)
    <span class="keyword">for</span> d, i <span class="keyword">in</span> data
      buf.array[offset+i] = data.charCodeAt(i) &amp; <span class="number">0xFF</span>
    data.length

  readFileSync: (path) -&gt;
    f = fs_state.open(path, <span class="string">'r'</span>)
    <span class="keyword">throw</span> <span class="string">"File does not exist."</span> <span class="keyword">unless</span> f?
    <span class="keyword">return</span> f.data

  readFile: (path, cb) -&gt;
    <span class="keyword">try</span>
      data = root.fs.readFileSync path
      cb <span class="literal">null</span>, data
    <span class="keyword">catch</span> e
      cb e</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>XXX: Temp option prevents writeback to permanent storage. This is not in the
     Node API, and is used as a way for the browser to create temp files.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  writeFileSync: (path, data, encoding, temp) -&gt;
    f = fs_state.open(path, <span class="string">'w'</span>)
    f.temp = temp == <span class="literal">true</span>
    f.write(data)
    fs_state.close(f)

  writeFile: (path, data, cb) -&gt;
    cb <span class="literal">null</span>, root.fs.writeFileSync(path, data)

  writeSync: (fd, buffer, offset, len, pos) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>TODO flush occasionally?
structure borrowed from the Node.js source</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> buffer.readUInt8?
      str = (String.fromCharCode(buffer.readUInt8(i)) <span class="keyword">for</span> i <span class="keyword">in</span> [offset...offset+len] <span class="keyword">by</span> <span class="number">1</span>).join <span class="string">''</span>
    <span class="keyword">else</span>  <span class="comment"># old-style API where buffer is a string</span>
      str = <span class="string">''</span> + buffer
      pos = offset
    fd.write(str, pos)

  closeSync: (fd) -&gt; fs_state.close(fd)
  close: (fd, cb) -&gt; root.fs.closeSync fd; cb()

  readdirSync: (path) -&gt;
    dir_contents = fs_state.list(path)
    <span class="keyword">throw</span> <span class="string">"Could not read directory '<span class="subst">#{path}</span>'"</span> <span class="keyword">unless</span> dir_contents? <span class="keyword">and</span> path != <span class="string">''</span>
    <span class="keyword">return</span> dir_contents

  readdir: (path, cb) -&gt;
    <span class="keyword">try</span>
      files = root.fs.readdirSync path
      cb <span class="literal">null</span>, files
    <span class="keyword">catch</span> e
      cb e

  unlinkSync: (path) -&gt; <span class="keyword">throw</span> <span class="string">"Could not unlink '<span class="subst">#{path}</span>'"</span> <span class="keyword">unless</span> fs_state.rm(path)
  unlink: (path, cb) -&gt;
    <span class="keyword">try</span>
      root.fs.unlinkSync path
      cb()
    <span class="keyword">catch</span> e
      cb e
  rmdirSync: (path) -&gt; <span class="keyword">throw</span> <span class="string">"Could not delete '<span class="subst">#{path}</span>'"</span> <span class="keyword">unless</span> fs_state.rm(path, <span class="literal">true</span>)
  rmdir: (path, cb) -&gt;
    <span class="keyword">try</span>
      root.fs.rmdirSync path
      cb()
    <span class="keyword">catch</span> e
      cb e

  existsSync: (path) -&gt; path != <span class="string">''</span> <span class="keyword">and</span> (fs_state.is_file(path) <span class="keyword">or</span> fs_state.is_directory(path))
  exists: (path, cb) -&gt;
    cb <span class="literal">null</span>, root.fs.existsSync(path)

  mkdirSync: (path) -&gt; <span class="keyword">throw</span> <span class="string">"Could not make directory <span class="subst">#{path}</span>"</span> <span class="keyword">unless</span> fs_state.mkdir path
  mkdir: (path, cb) -&gt;
    <span class="keyword">try</span>
      root.fs.mkdirSync path
      cb()
    <span class="keyword">catch</span> e
      cb e

  renameSync: (path1, path2) -&gt; <span class="keyword">throw</span> <span class="string">"Could not rename <span class="subst">#{path1}</span> to <span class="subst">#{path2}</span>"</span> <span class="keyword">unless</span> fs_state.mv path1, path2
  rename: (path1, path2, cb) -&gt;
    <span class="keyword">try</span>
      root.fs.renameSync path1, path2
      cb()
    <span class="keyword">catch</span> e
      cb e</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>XXX: Does not work for directory permissions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  chmodSync: (path, access) -&gt;
    <span class="keyword">throw</span> <span class="string">"File <span class="subst">#{path1}</span> does not exist."</span> <span class="keyword">unless</span> fs_state.is_file path
    f = fs_state.open path, <span class="string">'r'</span>
    f.mod = <span class="literal">true</span>
    f.mode = access
    fs_state.close f
    <span class="keyword">return</span> <span class="literal">true</span>
  chmod: (path, access, cb) -&gt;
    <span class="keyword">try</span>
      rv = root.fs.chmodSync path, access
      cb <span class="literal">null</span>, rv
    <span class="keyword">catch</span> e
      cb e

  utimesSync: (path, atime, mtime) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>XXX: this is a NOP, but it shouldn&#39;t be. We need to fix the way we stat files first</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  utimes: (path, atime, mtime, cb) -&gt; cb()</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Node&#39;s Path API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.path =
  normalize: (path) -&gt; fs_state.resolve path
  resolve: (parts...) -&gt; fs_state.resolve parts.join <span class="string">'/'</span>
  basename: (path, ext) -&gt;
    base = path.replace(<span class="regexp">/^.*[\/\\]/</span>, <span class="string">''</span>)
    <span class="keyword">if</span> ext?.length? <span class="keyword">and</span> base[base.length-ext.length..] == ext
      base = base[...base.length-ext.length]
    base
  extname: (path) -&gt; path.replace(<span class="regexp">/^.*(\..*)/</span>, <span class="string">'$1'</span>)

root.process =
  cwd: -&gt; fs_state.pwd
  chdir: (dir) -&gt;
    absdir = fs_state.chdir dir
    <span class="keyword">throw</span> <span class="string">"Invalid directory"</span> <span class="keyword">unless</span> absdir?
    absdir
  nextTick: (fn) -&gt; setZeroTimeout fn</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
