<!DOCTYPE html>  <html> <head>   <title>node.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="frontend.html">                 frontend.coffee               </a>                                           <a class="source" href="node.html">                 node.coffee               </a>                                           <a class="source" href="untar.html">                 untar.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                                           <a class="source" href="ClassFile.html">                 ClassFile.coffee               </a>                                           <a class="source" href="ConstantPool.html">                 ConstantPool.coffee               </a>                                           <a class="source" href="attributes.html">                 attributes.coffee               </a>                                           <a class="source" href="disassembler.html">                 disassembler.coffee               </a>                                           <a class="source" href="exceptions.html">                 exceptions.coffee               </a>                                           <a class="source" href="java_object.html">                 java_object.coffee               </a>                                           <a class="source" href="jvm.html">                 jvm.coffee               </a>                                           <a class="source" href="logging.html">                 logging.coffee               </a>                                           <a class="source" href="methods.html">                 methods.coffee               </a>                                           <a class="source" href="natives.html">                 natives.coffee               </a>                                           <a class="source" href="opcodes.html">                 opcodes.coffee               </a>                                           <a class="source" href="runtime.html">                 runtime.coffee               </a>                                           <a class="source" href="testing.html">                 testing.coffee               </a>                                           <a class="source" href="types.html">                 types.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               node.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">win = </span><span class="nb">window</span>

<span class="nv">root = win.node = </span><span class="p">{}</span>
<span class="nv">basename = </span><span class="nf">(path) -&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span>
<span class="nv">win.require = </span><span class="nf">(path) -&gt;</span>
  <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">ext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">basename</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">split</span> <span class="s1">&#39;.&#39;</span>
  <span class="nb">window</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">?=</span> <span class="p">{}</span>

<span class="nv">_ = </span><span class="nx">require</span> <span class="s1">&#39;../vendor/_.js&#39;</span>

<span class="s2">&quot;use strict&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>IE9 and below only: Injects a VBScript function that converts the
'responseBody' attribute of an XMLHttpRequest into a bytestring.
Credit: http://miskun.com/javascript/internet-explorer-and-binary-files-data-access/#comment-11</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">inject_vbscript = </span><span class="o">-&gt;</span>
  <span class="nv">IEBinaryToArray_ByteStr_Script =</span>
    <span class="s2">&quot;&lt;!-- IEBinaryToArray_ByteStr --&gt;\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;&lt;script type=&#39;text/vbscript&#39;&gt;\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;Function IEBinaryToArray_ByteStr(Binary)\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;   IEBinaryToArray_ByteStr = CStr(Binary)\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;End Function\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;Function IEBinaryToArray_ByteStr_Last(Binary)\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;   Dim lastIndex\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;   lastIndex = LenB(Binary)\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;   if lastIndex mod 2 Then\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;       IEBinaryToArray_ByteStr_Last = Chr( AscB( MidB( Binary, lastIndex, 1 ) ) )\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;   Else\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;       IEBinaryToArray_ByteStr_Last = &quot;</span><span class="o">+</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="o">+</span><span class="s2">&quot;\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;   End If\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;End Function\r\n&quot;</span><span class="o">+</span>
    <span class="s2">&quot;&lt;/script&gt;\r\n&quot;</span>

  <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">IEBinaryToArray_ByteStr_Script</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Run once at JavaScript load time.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">msie</span> <span class="o">and</span> <span class="o">not</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Blob</span>
  <span class="nx">inject_vbscript</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Converts 'responseBody' in IE into the equivalent 'responseText' that other
browsers would generate.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">GetIEByteArray_ByteStr = </span><span class="nf">(IEByteArray) -&gt;</span>
  <span class="nv">rawBytes = </span><span class="nx">IEBinaryToArray_ByteStr</span><span class="p">(</span><span class="nx">IEByteArray</span><span class="p">);</span>
  <span class="nv">lastChr = </span><span class="nx">IEBinaryToArray_ByteStr_Last</span><span class="p">(</span><span class="nx">IEByteArray</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">rawBytes</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\s\S]/g</span><span class="p">,</span>
    <span class="p">(</span><span class="nf">(match) -&gt;</span>
      <span class="nv">v = </span><span class="nx">match</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">v</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span> <span class="nx">v</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span>
    <span class="p">))</span> <span class="o">+</span> <span class="nx">lastChr</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Our 'file descriptor'</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">DoppioFile</span>
  <span class="vi">@fromJSON: </span><span class="nf">(path, rawData) -&gt;</span>
    <span class="nv">data = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">rawData</span>
    <span class="k">new</span> <span class="nx">DoppioFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">mtime</span><span class="p">)</span>

  <span class="nv">constructor: </span><span class="p">(</span><span class="nx">@path</span><span class="p">,</span> <span class="vi">@data = </span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="vi">@mtime = </span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">getTime</span><span class="p">(),</span> <span class="vi">@mod = </span><span class="kc">false</span><span class="p">,</span> <span class="vi">@mode = </span><span class="mi">0</span><span class="nx">o644</span><span class="p">)</span> <span class="o">-&gt;</span>

  <span class="nv">read: </span><span class="nf">(length, pos) -&gt;</span>
    <span class="k">return</span> <span class="nx">@data</span> <span class="nx">unless</span> <span class="nx">length</span><span class="o">?</span>
    <span class="nx">@data</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>TODO: We only append to the end of files...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">write: </span><span class="nf">(newData) -&gt;</span> <span class="vi">@mod = </span><span class="kc">true</span><span class="p">;</span> <span class="nx">@data</span> <span class="o">+=</span> <span class="nx">newData</span><span class="p">;</span> <span class="err">@</span>

  <span class="nv">toJSON: </span><span class="o">-&gt;</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span>
      <span class="nv">data: </span><span class="nx">@data</span>
      <span class="nv">mtime: </span><span class="nx">@mtime</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Helper object. Used by some FileSources to maintain an index of files.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">FileIndex</span>
  <span class="nv">constructor: </span><span class="nf">(@index = {}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Get subcomponents of the given path.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_subcomponents: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">components = </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;/&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Get rid of first slash</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">components</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Special case: Root</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">components</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">then</span> <span class="p">[]</span> <span class="k">else</span> <span class="nx">components</span>
  <span class="nv">_add_file: </span><span class="nf">(components, fname, file) -&gt;</span>
    <span class="nv">dir = </span><span class="nx">@_mkdir</span><span class="p">(</span><span class="nx">components</span><span class="p">)</span>
    <span class="nx">dir</span><span class="p">[</span><span class="nx">fname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">file</span>
    <span class="k">return</span>
  <span class="nv">_mkdir: </span><span class="nf">(components) -&gt;</span>
    <span class="nv">cur_dir = </span><span class="nx">@index</span>
    <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">components</span>
      <span class="nx">cur_dir</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="o">?=</span> <span class="p">{}</span>
      <span class="nv">cur_dir = </span><span class="nx">cur_dir</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">cur_dir</span>
  <span class="nv">_get: </span><span class="nf">(components) -&gt;</span>
    <span class="nv">cur_dir = </span><span class="nx">@index</span>
    <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">components</span>
      <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">c</span> <span class="k">of</span> <span class="nx">cur_dir</span>
      <span class="nv">cur_dir = </span><span class="nx">cur_dir</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">cur_dir</span>
  <span class="nv">_is_directory: </span><span class="nf">(obj) -&gt;</span> <span class="nx">obj</span><span class="o">?</span> <span class="o">and</span> <span class="o">!</span><span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">DoppioFile</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Add the given file to the index. Implicitly creates directories if needed
and overwrites things without checking.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add_file: </span><span class="nf">(path, file) -&gt;</span>
    <span class="nv">components = </span><span class="nx">@_subcomponents</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">fname = </span><span class="nx">components</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nx">@_add_file</span><span class="p">(</span><span class="nx">components</span><span class="p">,</span> <span class="nx">fname</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Retrieves the given file. Returns 'false' if the file does not exist, or if
it is a directory. Otherwise, returns the file (which may be null).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_file: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">components = </span><span class="nx">@_subcomponents</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">f = </span><span class="nx">@_get</span><span class="p">(</span><span class="nx">components</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">f</span> <span class="nx">unless</span> <span class="nx">f</span> <span class="o">is</span> <span class="kc">false</span> <span class="o">or</span> <span class="nx">@_is_directory</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Returns a directory listing, or null if the directory does not exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ls: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">components = </span><span class="nx">@_subcomponents</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">dir = </span><span class="nx">@_get</span><span class="p">(</span><span class="nx">components</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">dir</span> <span class="o">is</span> <span class="kc">false</span> <span class="o">or</span> <span class="o">!</span><span class="nx">@_is_directory</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Makes the given directory. Implicitly creates needed subdirectories.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mkdir: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">components = </span><span class="nx">@_subcomponents</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nx">@_mkdir</span><span class="p">(</span><span class="nx">components</span><span class="p">)</span>
    <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Returns the parent directory of path or false.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parent: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">components = </span><span class="nx">@_subcomponents</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nx">components</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">@_get</span> <span class="nx">components</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Removes the given path, directory or not, from the index. This is a
recursive delete. Returns the paths to the files that were deleted if this
was a directory, otherwise returns true if a file was deleted, false if
the path did not exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rm: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">components = </span><span class="nx">@_subcomponents</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">name = </span><span class="nx">components</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nv">parent = </span><span class="nx">@_get</span><span class="p">(</span><span class="nx">components</span><span class="p">)</span>
    <span class="nv">ret = </span><span class="kc">false</span>
    <span class="k">if</span> <span class="nx">parent</span><span class="o">?</span> <span class="o">and</span> <span class="nx">parent</span> <span class="o">!=</span> <span class="kc">false</span>
      <span class="k">if</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span>
        <span class="nv">obj = </span><span class="nx">parent</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
        <span class="nv">ret = </span><span class="k">if</span> <span class="nx">@_is_directory</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="k">then</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="k">else</span> <span class="kc">true</span>
        <span class="k">delete</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">ret</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Interface for a FileSource. Somewhat of a misnomer, as they are also sinks...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">FileSource</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Set to 'true' if this FileSource is redundant to another in some way.
This signals that it should be written to / deleted from, even if another
applicable source has an identical file or directory path</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">redundant_storage: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>A handy method for sources that store/retrieve data using a relative file
name.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_trim_mnt_pt: </span><span class="nf">(path) -&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">@mnt_pt</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>

  <span class="nv">constructor: </span><span class="nf">(@mnt_pt) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>INTERFACE METHODS
Fetches file at path; DoppioFile for success, null for failure.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fetch: </span><span class="nf">(path) -&gt;</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Stores file to path; true for success, false for failure.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">store: </span><span class="nf">(path, file) -&gt;</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Removes the file or folder at the given path. Returns true for success.
If there are files in the folder, it automatically recurses.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rm: </span><span class="nf">(path) -&gt;</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Returns a directory listing for the given path, or null if it does not
exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ls: </span><span class="nf">(path) -&gt;</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Moves a file or directory from path1 to path2. Returns true on success,
false otherwise.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mv: </span><span class="nf">(path1, path2, isFile = true) -&gt;</span> <span class="kc">false</span>
  <span class="nv">mkdir: </span><span class="nf">(path1) -&gt;</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Composes multiple file sources into one file source. Prioritizes file sources
in the order in which they are added.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">CompositedFileSource</span> <span class="k">extends</span> <span class="nx">FileSource</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Returns 'true' if the given path is in the given mount point.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_in_mnt_pt: </span><span class="nf">(path, mnt_pt) -&gt;</span> <span class="nx">mnt_pt</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="o">or</span> <span class="nx">path</span> <span class="o">==</span> <span class="nx">mnt_pt</span> <span class="o">or</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">mnt_pt</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">==</span> <span class="nx">mnt_pt</span> <span class="o">and</span> <span class="nx">path</span><span class="p">[</span><span class="nx">mnt_pt</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
  <span class="nv">_get_applicable_sources: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">applicable = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">a_mnt_pt</span> <span class="k">in</span> <span class="nx">@mnt_pts</span>
      <span class="nx">applicable</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@sources</span><span class="p">[</span><span class="nx">a_mnt_pt</span><span class="p">])</span> <span class="k">if</span> <span class="nx">@_in_mnt_pt</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">a_mnt_pt</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">applicable</span>

  <span class="nv">constructor: </span><span class="nf">(mnt_pt, inpt_sources = []) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">mnt_pt</span><span class="p">)</span>
    <span class="vi">@sources = </span><span class="p">{}</span>
    <span class="vi">@mnt_pts = </span><span class="p">[]</span>
    <span class="vi">@redundant_storage = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">source</span> <span class="k">in</span> <span class="nx">inpt_sources</span>
      <span class="nx">@add_source</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>

  <span class="nv">add_source: </span><span class="nf">(source) -&gt;</span>
    <span class="nx">@sources</span><span class="p">[</span><span class="nx">source</span><span class="p">.</span><span class="nx">mnt_pt</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span>
    <span class="nx">@mnt_pts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">mnt_pt</span><span class="p">)</span>
    <span class="nx">@redundant_storage</span> <span class="o">||=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">redundant_storage</span>
    <span class="k">return</span>

  <span class="nv">fetch: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">applicable = </span><span class="nx">@_get_applicable_sources</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">parent</span> <span class="k">in</span> <span class="nx">applicable</span>
      <span class="nv">f = </span><span class="nx">parent</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">f</span> <span class="k">if</span> <span class="nx">f</span><span class="o">?</span>
    <span class="k">return</span> <span class="kc">null</span>

  <span class="nv">store: </span><span class="nf">(path, file) -&gt;</span>
    <span class="nv">applicable = </span><span class="nx">@_get_applicable_sources</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">stored = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">source</span> <span class="k">in</span> <span class="nx">applicable</span>
      <span class="nv">stored = </span><span class="nx">source</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="o">||</span> <span class="nx">stored</span> <span class="nx">unless</span> <span class="nx">stored</span> <span class="o">and</span> <span class="o">!</span><span class="nx">source</span><span class="p">.</span><span class="nx">redundant_storage</span>
    <span class="k">return</span> <span class="nx">stored</span>

  <span class="nv">rm: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">applicable = </span><span class="nx">@_get_applicable_sources</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">removed = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">source</span> <span class="k">in</span> <span class="nx">applicable</span>
      <span class="nv">removed = </span><span class="nx">source</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">||</span> <span class="nx">removed</span> <span class="nx">unless</span> <span class="nx">removed</span> <span class="o">and</span> <span class="o">!</span><span class="nx">source</span><span class="p">.</span><span class="nx">redundant_storage</span>
    <span class="k">return</span> <span class="nx">removed</span>

  <span class="nv">ls: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">applicable = </span><span class="nx">@_get_applicable_sources</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Initialize to 'null' so that we return 'null' if the path is not present
in any applicable FileSources. Note that 'null' != [], as the latter is
an existing-but-empty directory.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">list = </span><span class="kc">null</span>
    <span class="k">for</span> <span class="nx">source</span> <span class="k">in</span> <span class="nx">applicable</span>
      <span class="nv">src_list = </span><span class="nx">source</span><span class="p">.</span><span class="nx">ls</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">src_list</span><span class="o">?</span>
        <span class="nv">list = </span><span class="k">if</span> <span class="nx">list</span><span class="o">?</span> <span class="k">then</span> <span class="nx">_</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">src_list</span><span class="p">)</span> <span class="k">else</span> <span class="nx">src_list</span>
    <span class="k">return</span> <span class="nx">list</span>

  <span class="nv">mv: </span><span class="nf">(path1, path2, isFile = true) -&gt;</span>
    <span class="nv">applicable = </span><span class="nx">@_get_applicable_sources</span><span class="p">(</span><span class="nx">path1</span><span class="p">)</span>
    <span class="nv">moved = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">source</span> <span class="k">in</span> <span class="nx">applicable</span>
      <span class="nv">moved = </span><span class="nx">source</span><span class="p">.</span><span class="nx">mv</span><span class="p">(</span><span class="nx">path1</span><span class="p">,</span> <span class="nx">path2</span><span class="p">,</span> <span class="nx">isFile</span><span class="p">)</span> <span class="o">||</span> <span class="nx">moved</span>
    <span class="k">return</span> <span class="nx">moved</span>

  <span class="nv">mkdir: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">applicable = </span><span class="nx">@_get_applicable_sources</span> <span class="nx">path</span>
    <span class="nv">dirmade = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">source</span> <span class="k">in</span> <span class="nx">applicable</span>
      <span class="nx">dirmade</span> <span class="o">||=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">mkdir</span> <span class="nx">path</span>
    <span class="k">return</span> <span class="nx">dirmade</span>

<span class="k">class</span> <span class="nx">LocalStorageSource</span> <span class="k">extends</span> <span class="nx">FileSource</span>
  <span class="nv">redundant_storage: </span><span class="kc">true</span>
  <span class="nv">constructor: </span><span class="nf">(mnt_pt) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">mnt_pt</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Index of all files in LS.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@index = </span><span class="k">new</span> <span class="nx">FileIndex</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Initialize index w/ LS files and directories.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">path</span> <span class="k">of</span> <span class="nx">localStorage</span>
      <span class="nx">@index</span><span class="p">.</span><span class="nx">add_file</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>

  <span class="nv">fetch: </span><span class="nf">(path) -&gt;</span> <span class="k">if</span> <span class="nx">localStorage</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">DoppioFile</span><span class="p">.</span><span class="nx">fromJSON</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">localStorage</span><span class="p">[</span><span class="nx">path</span><span class="p">])</span> <span class="k">else</span> <span class="kc">null</span>
  <span class="nv">store: </span><span class="nf">(path, file) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>XXX: Don't store if a temporary file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">mod</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">file</span><span class="p">.</span><span class="nx">temp</span>
      <span class="nx">localStorage</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
      <span class="nx">@index</span><span class="p">.</span><span class="nx">add_file</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span>
    <span class="kc">true</span>
  <span class="nv">rm: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">listing = </span><span class="nx">@index</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">listing</span> <span class="o">!=</span> <span class="s1">&#39;boolean&#39;</span>
      <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">listing</span>
        <span class="nv">itPath = </span><span class="nx">path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">item</span>
        <span class="k">delete</span> <span class="nx">localStorage</span><span class="p">[</span><span class="nx">itPath</span><span class="p">]</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">localStorage</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="o">?</span>
      <span class="k">delete</span> <span class="nx">localStorage</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="kc">true</span>

  <span class="nv">ls: </span><span class="nf">(path) -&gt;</span> <span class="nx">@index</span><span class="p">.</span><span class="nx">ls</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="nv">mv: </span><span class="nf">(path1, path2, isFile = true) -&gt;</span>
    <span class="k">if</span> <span class="nx">isFile</span>
      <span class="nv">file1_obj = </span><span class="nx">@fetch</span><span class="p">(</span><span class="nx">path1</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">file1_obj</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@rm</span> <span class="nx">path1</span>
      <span class="nv">file1_obj.path = </span><span class="nx">path2</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>XXX: Bit of a hack.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">file1_obj.mod = </span><span class="kc">true</span>
      <span class="nx">@store</span> <span class="nx">path2</span><span class="p">,</span> <span class="nx">file1_obj</span>
    <span class="k">else</span>
      <span class="nv">file1_ls = </span><span class="nx">@index</span><span class="p">.</span><span class="nx">ls</span><span class="p">(</span><span class="nx">path1</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">file1_ls</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Make path2.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@index</span><span class="p">.</span><span class="nx">mkdir</span> <span class="nx">path2</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Move every file from p1 to p2.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">f_name</span> <span class="k">in</span> <span class="nx">file1_ls</span>
        <span class="nx">@mv</span> <span class="nx">f_name</span><span class="p">,</span> <span class="nx">path2</span> <span class="o">+</span> <span class="nx">f_name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">path1</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Delete p1.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@index</span><span class="p">.</span><span class="nx">rm</span> <span class="nx">path1</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="nv">mkdir: </span><span class="nf">(path) -&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">@index</span><span class="p">.</span><span class="nx">parent</span> <span class="nx">path</span>
    <span class="nx">@index</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">true</span>

<span class="k">class</span> <span class="nx">WebserverSource</span> <span class="k">extends</span> <span class="nx">FileSource</span>
  <span class="nv">_download_file: </span><span class="nf">(path) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Ensure the file is in the index.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">@index</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@index</span><span class="p">.</span><span class="nx">get_file</span><span class="p">(</span><span class="nx">@mnt_pt</span> <span class="o">+</span> <span class="nx">path</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span>
    <span class="nv">data = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>The below code is complicated because we can't do a 'text' request in IE;
it truncates the response at the first NULL character.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">$</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">msie</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">path</span><span class="p">,</span> <span class="p">{</span>
        <span class="nv">type: </span><span class="s1">&#39;GET&#39;</span>
        <span class="nv">dataType: </span><span class="s1">&#39;text&#39;</span>
        <span class="nv">async: </span><span class="kc">false</span>
        <span class="nv">beforeSend: </span><span class="nf">(jqXHR) -&gt;</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">(</span><span class="s1">&#39;text/plain; charset=x-user-defined&#39;</span><span class="p">)</span>
        <span class="nv">success: </span><span class="nf">(theData, status, jqxhr) -&gt;</span> <span class="nv">data = </span><span class="nx">theData</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>IE 10+ path</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Blob</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>In IE10, we can do a 'blob' request to get a binary blob that we can
convert into a string.
jQuery's 'ajax' function does not support blob requests, so we're going
to use XMLHttpRequest directly.
Furthermore, the code below will <em>NOT</em> work in Firefox or Chrome, since
they do not allow synchronous blob or arraybuffer requests.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">req = </span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
      <span class="nv">req.responseType = </span><span class="s1">&#39;arraybuffer&#39;</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="nv">typed_array = </span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span>
        <span class="nv">array = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">char</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">typed_array</span>
          <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">char</span><span class="p">)</span>
        <span class="nv">data = </span><span class="nx">array</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>IE &lt; 10 path</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>In earlier versions of IE, we can retrieve the 'responseBody'
attribute of the response (which contains the <em>entire</em> response).
Since it's an unsigned array, JavaScript can't touch it, so we
pass it to VBScript code that can convert it into something
JavaScript can process.
Note that this approach also works in IE10 for x86 platforms, but
not for ARM platforms which do not have VBScript support.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">req = </span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Accept-Charset&quot;</span><span class="p">,</span> <span class="s2">&quot;x-user-defined&quot;</span><span class="p">)</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="nv">data = </span><span class="nx">GetIEByteArray_ByteStr</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseBody</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">data</span>
  <span class="nv">constructor: </span><span class="nf">(mnt_pt, listings_path) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">mnt_pt</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">listings_path</span><span class="o">?</span>
      <span class="nv">idx_data = </span><span class="nx">@_download_file</span><span class="p">(</span><span class="nx">listings_path</span><span class="p">)</span>
    <span class="vi">@index = </span><span class="k">new</span> <span class="nx">FileIndex</span><span class="p">(</span><span class="k">if</span> <span class="nx">idx_data</span><span class="o">?</span> <span class="k">then</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">idx_data</span><span class="p">)</span> <span class="k">else</span> <span class="p">)</span>
  <span class="nv">fetch: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">trim_path = </span><span class="nx">@_trim_mnt_pt</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nv">data = </span><span class="nx">@_download_file</span><span class="p">(</span><span class="nx">trim_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">data</span><span class="o">?</span> <span class="k">then</span> <span class="k">new</span> <span class="nx">DoppioFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="k">else</span> <span class="kc">null</span>
  <span class="nv">ls: </span><span class="nf">(path) -&gt;</span> <span class="nx">@index</span><span class="p">.</span><span class="nx">ls</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Wraps another FileSource and acts as its cache.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">CacheSource</span> <span class="k">extends</span> <span class="nx">FileSource</span>
  <span class="nv">constructor: </span><span class="nf">(mnt_pt, src) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">mnt_pt</span><span class="p">)</span>
    <span class="vi">@src = </span><span class="nx">src</span>
    <span class="vi">@redundant_storage = </span><span class="nx">src</span><span class="p">.</span><span class="nx">redundant_storage</span>
    <span class="vi">@index = </span><span class="k">new</span> <span class="nx">FileIndex</span><span class="p">()</span>
  <span class="nv">fetch: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">f = </span><span class="nx">@index</span><span class="p">.</span><span class="nx">get_file</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">f</span> <span class="o">==</span> <span class="kc">false</span>
      <span class="nv">f = </span><span class="nx">@src</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
      <span class="nx">@index</span><span class="p">.</span><span class="nx">add_file</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="k">if</span> <span class="nx">f</span><span class="o">?</span>
    <span class="k">return</span> <span class="nx">f</span>
  <span class="nv">store: </span><span class="nf">(path, file) -&gt;</span>
    <span class="k">if</span> <span class="nx">@src</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span>
      <span class="nx">@index</span><span class="p">.</span><span class="nx">add_file</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="nv">rm: </span><span class="nf">(path) -&gt;</span>
    <span class="k">if</span> <span class="nx">@src</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
      <span class="nx">@index</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="nv">ls: </span><span class="nf">(path) -&gt;</span> <span class="nx">@src</span><span class="p">.</span><span class="nx">ls</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="nv">mkdir: </span><span class="nf">(path) -&gt;</span> <span class="nx">@src</span><span class="p">.</span><span class="nx">mkdir</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>ignoreSrc is used internally only.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mv: </span><span class="nf">(file1, file2, isFile = true, ignoreSrc = false) -&gt;</span>
    <span class="nv">success = </span><span class="k">if</span> <span class="nx">ignoreSrc</span> <span class="k">then</span> <span class="kc">true</span> <span class="k">else</span> <span class="nx">@src</span><span class="p">.</span><span class="nx">mv</span> <span class="nx">file1</span><span class="p">,</span> <span class="nx">file2</span><span class="p">,</span> <span class="nx">isFile</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Move any cached copies.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">isFile</span>
      <span class="nv">f = </span><span class="nx">@index</span><span class="p">.</span><span class="nx">get_file</span> <span class="nx">file1</span>
      <span class="k">if</span> <span class="nx">f</span>
        <span class="nv">f.path = </span><span class="nx">file2</span>
        <span class="nx">@index</span><span class="p">.</span><span class="nx">rm</span> <span class="nx">file1</span>
        <span class="nx">@index</span><span class="p">.</span><span class="nx">add_file</span> <span class="nx">file2</span><span class="p">,</span> <span class="nx">f</span>
    <span class="k">else</span>
      <span class="nv">ls = </span><span class="nx">@index</span><span class="p">.</span><span class="nx">ls</span> <span class="nx">file1</span>
      <span class="k">for</span> <span class="nx">f_name</span> <span class="k">in</span> <span class="nx">ls</span>
        <span class="nx">@mv</span> <span class="nx">f_name</span><span class="p">,</span> <span class="nx">path2</span> <span class="o">+</span> <span class="nx">f_name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">path1</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span>
      <span class="nx">@index</span><span class="p">.</span><span class="nx">rm</span> <span class="nx">file1</span>
    <span class="k">return</span> <span class="nx">success</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Stores the File System's current state.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">FSState</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Files fetched from webserver are always represented internally as relative
to home.
(mnt<em>pt, inpt</em>sources = [])</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@home = </span><span class="s1">&#39;/home/doppio&#39;</span>
    <span class="vi">@pwd = </span><span class="nx">@home</span>
    <span class="nv">mainSource = </span><span class="k">new</span> <span class="nx">CompositedFileSource</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">[</span><span class="k">new</span> <span class="nx">LocalStorageSource</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="k">new</span> <span class="nx">WebserverSource</span><span class="p">(</span><span class="s1">&#39;/home/doppio&#39;</span><span class="p">,</span> <span class="s1">&#39;/browser/listings.json&#39;</span><span class="p">)])</span>
    <span class="vi">@files = </span><span class="k">new</span> <span class="nx">CacheSource</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">mainSource</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Slight cheat; ensures that / and /home exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">f = </span><span class="k">new</span> <span class="nx">DoppioFile</span><span class="p">(</span><span class="s1">&#39;/home/doppio/Hello.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;Welcome to Doppio!&quot;</span><span class="p">)</span>
    <span class="nv">f.mod = </span><span class="kc">true</span>
    <span class="nx">@files</span><span class="p">.</span><span class="nx">store</span> <span class="s1">&#39;/home/doppio/Hello.txt&#39;</span><span class="p">,</span> <span class="nx">f</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Canonicalizes the given path.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolve: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">components = </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;/&#39;</span>
    <span class="nv">absolute = </span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">for</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">components</span>
      <span class="nx">components</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span>
      <span class="nx">components</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@home</span> <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="s1">&#39;~&#39;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">absolute</span>
      <span class="nv">pwdCmps = </span><span class="nx">@pwd</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;/&#39;</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">pwdCmps</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">..</span><span class="mi">0</span><span class="p">]</span> <span class="k">by</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">components</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">pwdCmps</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="k">for</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">components</span>
      <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="s1">&#39;..&#39;</span>
        <span class="nv">processed = </span><span class="kc">false</span>
        <span class="nv">i = </span><span class="nx">idx</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="o">!</span><span class="nx">processed</span>
          <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nv">processed = </span><span class="kc">true</span>
          <span class="k">if</span> <span class="nx">components</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
            <span class="nx">components</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="nx">components</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="nv">processed = </span><span class="kc">true</span>
          <span class="nx">i</span><span class="o">--</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>remove repeated //s</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">path = </span><span class="p">(</span><span class="nx">c</span> <span class="k">for</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">components</span> <span class="k">when</span> <span class="nx">c</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">if</span> <span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span>
      <span class="nv">path = </span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span>
    <span class="k">return</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Retrieves a file from the file system. Creates a new one if needed.
Mode is 'r' for read, 'w' for write+read, 'a' for append+read
Returns 'null' if file does not exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">open: </span><span class="nf">(path, mode = &#39;r&#39;) -&gt;</span>
    <span class="nv">path = </span><span class="nx">@resolve</span> <span class="nx">path</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">@is_directory</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Start fresh.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span>
      <span class="nv">f = </span><span class="k">new</span> <span class="nx">DoppioFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Ensure writeback when closed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">f.mod = </span><span class="kc">true</span>
      <span class="k">return</span> <span class="nx">f</span>
    <span class="k">return</span> <span class="nx">@files</span><span class="p">.</span><span class="nx">fetch</span> <span class="nx">path</span>

  <span class="nv">close: </span><span class="nf">(file) -&gt;</span> <span class="nx">@files</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span> <span class="nv">file.mod = </span><span class="kc">false</span><span class="p">;</span> <span class="k">return</span>

  <span class="nv">list: </span><span class="nf">(path) -&gt;</span> <span class="nx">@files</span><span class="p">.</span><span class="nx">ls</span><span class="p">(</span><span class="nx">@resolve</span> <span class="nx">path</span><span class="p">)</span>

  <span class="nv">is_file: </span><span class="nf">(path) -&gt;</span> <span class="nx">@files</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">@resolve</span> <span class="nx">path</span><span class="p">)</span><span class="o">?</span>

  <span class="nv">is_directory: </span><span class="nf">(path) -&gt;</span> <span class="nx">@list</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="o">?</span>

  <span class="nv">rm: </span><span class="nf">(path, isDir = false) -&gt;</span>
    <span class="nv">path = </span><span class="nx">@resolve</span> <span class="nx">path</span>
    <span class="k">if</span> <span class="nx">@is_directory</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">isDir</span> <span class="k">then</span> <span class="kc">false</span> <span class="k">else</span> <span class="nx">@files</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>

  <span class="nv">chdir: </span><span class="nf">(dir) -&gt;</span>
    <span class="nv">dir = </span><span class="nx">@resolve</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">@is_directory</span> <span class="nx">dir</span>
      <span class="vi">@pwd = </span><span class="nx">dir</span>
      <span class="nx">dir</span>
    <span class="k">else</span>
      <span class="kc">null</span>

  <span class="nv">mkdir: </span><span class="nf">(dir) -&gt;</span>
    <span class="nv">dir = </span><span class="nx">@resolve</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@is_directory</span> <span class="nx">dir</span> <span class="o">or</span> <span class="nx">@is_file</span> <span class="nx">dir</span>
    <span class="k">return</span> <span class="nx">@files</span><span class="p">.</span><span class="nx">mkdir</span> <span class="nx">dir</span>

  <span class="nv">mv: </span><span class="nf">(file1, file2) -&gt;</span>
    <span class="nv">file1 = </span><span class="nx">@resolve</span> <span class="nx">file1</span>
    <span class="nv">file2 = </span><span class="nx">@resolve</span> <span class="nx">file2</span>
    <span class="k">return</span> <span class="nx">@files</span><span class="p">.</span><span class="nx">mv</span> <span class="nx">file1</span><span class="p">,</span> <span class="nx">file2</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Currently a singleton.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fs_state = </span><span class="k">new</span> <span class="nx">FSState</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h6>#</h6>

<p>NODE EMULATION</p>

<h6>#</h6>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Stat</span>
  <span class="vi">@fromPath: </span><span class="nf">(path) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>XXX: Hack.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">path</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">is_directory</span> <span class="nx">path</span>
      <span class="nv">stat = </span><span class="k">new</span> <span class="nx">Stat</span>
      <span class="nv">stat.size = </span><span class="mi">1</span>
      <span class="nv">stat.mtime = </span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span>
      <span class="nv">stat.is_file = </span><span class="kc">false</span>
      <span class="nv">stat.is_directory = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>XXX: Shhhh...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">stat.mode = </span><span class="mi">0</span><span class="nx">o644</span>
      <span class="nx">stat</span>
    <span class="k">else</span>
      <span class="nv">file = </span><span class="nx">fs_state</span><span class="p">.</span><span class="nx">open</span> <span class="nx">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span>
      <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">file</span><span class="o">?</span>
      <span class="k">new</span> <span class="nx">Stat</span> <span class="nx">file</span>

  <span class="nv">constructor: </span><span class="nf">(@file) -&gt;</span>
    <span class="k">if</span> <span class="nx">@file</span><span class="o">?</span>
      <span class="vi">@size = </span><span class="nx">@file</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span>
      <span class="vi">@mtime = </span><span class="nx">@file</span><span class="p">.</span><span class="nx">mtime</span>
      <span class="vi">@is_file = </span><span class="kc">true</span>
      <span class="vi">@is_directory = </span><span class="kc">false</span>
      <span class="vi">@mode = </span><span class="nx">@file</span><span class="p">.</span><span class="nx">mode</span>

  <span class="nv">isFile: </span><span class="o">-&gt;</span> <span class="nx">@is_file</span>

  <span class="nv">isDirectory: </span><span class="o">-&gt;</span> <span class="nx">@is_directory</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>This is a global in Node.JS</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">win</span><span class="p">.</span><span class="nx">Buffer</span>
  <span class="nv">constructor: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">if</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">Array</span>
      <span class="vi">@array = </span><span class="nx">obj</span>
    <span class="k">else</span> <span class="c1"># assume num</span>
      <span class="vi">@array = </span><span class="k">new</span> <span class="nb">Array</span> <span class="nx">obj</span>

  <span class="nv">readUInt8: </span><span class="nf">(i) -&gt;</span> <span class="nx">@array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>  <span class="c1"># cast to unsigned byte</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Node's filesystem API, implemented as a wrapper around FSState.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.fs =</span>
  <span class="nv">statSync: </span><span class="nf">(path) -&gt;</span> <span class="nx">Stat</span><span class="p">.</span><span class="nx">fromPath</span> <span class="nx">path</span>

  <span class="nv">fstatSync: </span><span class="nf">(fp) -&gt;</span> <span class="k">new</span> <span class="nx">Stat</span><span class="p">(</span><span class="nx">fp</span><span class="p">)</span>

  <span class="nv">openSync: </span><span class="nf">(path, mode) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>'r' - Open file for reading. An exception occurs if the file does not exist.
'w' - Open file for writing. The file is created (if it does not exist) or truncated (if it exists).
'a' - Open file for appending. The file is created if it does not exist.
Normalize 'mode' to the three we care about</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="s1">&#39;w&#39;</span> <span class="k">in</span> <span class="nx">mode</span> <span class="k">then</span> <span class="nv">mode = </span><span class="s1">&#39;w&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="s1">&#39;a&#39;</span> <span class="k">in</span> <span class="nx">mode</span> <span class="k">then</span> <span class="nv">mode = </span><span class="s1">&#39;a&#39;</span>
    <span class="k">else</span> <span class="nv">mode = </span><span class="s1">&#39;r&#39;</span>
    <span class="nv">f = </span><span class="nx">fs_state</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span>
    <span class="nx">unless</span> <span class="nx">f</span><span class="o">?</span>
      <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span>
      <span class="nv">err.code = </span><span class="s1">&#39;ENOENT&#39;</span>
      <span class="k">throw</span> <span class="nx">err</span>
    <span class="nx">f</span>

  <span class="nv">readSync: </span><span class="nf">(fd, buf, offset, length, pos) -&gt;</span>
    <span class="nv">data = </span><span class="nx">fd</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">data</span>
      <span class="nx">buf</span><span class="p">.</span><span class="nx">array</span><span class="p">[</span><span class="nx">offset</span><span class="o">+</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">length</span>

  <span class="nv">readFileSync: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">f = </span><span class="nx">fs_state</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">throw</span> <span class="s2">&quot;File does not exist.&quot;</span> <span class="nx">unless</span> <span class="nx">f</span><span class="o">?</span>
    <span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>XXX: Temp option prevents writeback to permanent storage. This is not in the
     Node API, and is used as a way for the browser to create temp files.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">writeFileSync: </span><span class="nf">(path, data, temp) -&gt;</span>
    <span class="nv">f = </span><span class="nx">fs_state</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="nv">f.temp = </span><span class="nx">temp</span> <span class="o">==</span> <span class="kc">true</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">fs_state</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>

  <span class="nv">writeSync: </span><span class="nf">(fd, buffer, offset, len) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>TODO flush occasionally?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fd</span><span class="p">.</span><span class="nx">write</span><span class="p">((</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">readUInt8</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">offset</span><span class="p">...</span><span class="nx">offset</span><span class="o">+</span><span class="nx">len</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

  <span class="nv">closeSync: </span><span class="nf">(fd) -&gt;</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>

  <span class="nv">readdirSync: </span><span class="nf">(path) -&gt;</span>
    <span class="nv">dir_contents = </span><span class="nx">fs_state</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">throw</span> <span class="s2">&quot;Could not read directory &#39;#{path}&#39;&quot;</span> <span class="nx">unless</span> <span class="nx">dir_contents</span><span class="o">?</span> <span class="o">and</span> <span class="nx">path</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="nx">dir_contents</span>

  <span class="nv">unlinkSync: </span><span class="nf">(path) -&gt;</span> <span class="k">throw</span> <span class="s2">&quot;Could not unlink &#39;#{path}&#39;&quot;</span> <span class="nx">unless</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
  <span class="nv">rmdirSync: </span><span class="nf">(path) -&gt;</span> <span class="k">throw</span> <span class="s2">&quot;Could not delete &#39;#{path}&#39;&quot;</span> <span class="nx">unless</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">rm</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>

  <span class="nv">existsSync: </span><span class="nf">(path) -&gt;</span> <span class="nx">path</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="o">and</span> <span class="p">(</span><span class="nx">fs_state</span><span class="p">.</span><span class="nx">is_file</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">or</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">is_directory</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>

  <span class="nv">mkdirSync: </span><span class="nf">(path) -&gt;</span> <span class="k">throw</span> <span class="s2">&quot;Could not make directory #{path}&quot;</span> <span class="nx">unless</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">mkdir</span> <span class="nx">path</span>

  <span class="nv">renameSync: </span><span class="nf">(path1, path2) -&gt;</span> <span class="k">throw</span> <span class="s2">&quot;Could not rename #{path1} to #{path2}&quot;</span> <span class="nx">unless</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">mv</span> <span class="nx">path1</span><span class="p">,</span> <span class="nx">path2</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>XXX: Does not work for directory permissions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">chmodSync: </span><span class="nf">(path, access) -&gt;</span>
    <span class="k">throw</span> <span class="s2">&quot;File #{path1} does not exist.&quot;</span> <span class="nx">unless</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">is_file</span> <span class="nx">path</span>
    <span class="nv">f = </span><span class="nx">fs_state</span><span class="p">.</span><span class="nx">open</span> <span class="nx">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span>
    <span class="nv">f.mod = </span><span class="kc">true</span>
    <span class="nv">f.mode = </span><span class="nx">access</span>
    <span class="nx">fs_state</span><span class="p">.</span><span class="nx">close</span> <span class="nx">f</span>
    <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Node's Path API</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root.path =</span>
  <span class="nv">normalize: </span><span class="nf">(path) -&gt;</span> <span class="nx">path</span>
  <span class="nv">resolve: </span><span class="nf">(parts...) -&gt;</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;/&#39;</span>
  <span class="nv">basename: </span><span class="nf">(path, ext) -&gt;</span>
    <span class="nv">base = </span><span class="nx">path</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^.*[\/\\]/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">ext</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span> <span class="o">and</span> <span class="nx">base</span><span class="p">[</span><span class="nx">base</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">ext</span><span class="p">.</span><span class="nx">length</span><span class="p">..]</span> <span class="o">==</span> <span class="nx">ext</span>
      <span class="nv">base = </span><span class="nx">base</span><span class="p">[...</span><span class="nx">base</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">ext</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
    <span class="nx">base</span>
  <span class="nv">extname: </span><span class="nf">(path) -&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^.*(\..*)/</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span><span class="p">)</span>

<span class="nv">root.process =</span>
  <span class="nv">cwd: </span><span class="o">-&gt;</span> <span class="nx">fs_state</span><span class="p">.</span><span class="nx">pwd</span>
  <span class="nv">chdir: </span><span class="nf">(dir) -&gt;</span>
    <span class="nv">absdir = </span><span class="nx">fs_state</span><span class="p">.</span><span class="nx">chdir</span> <span class="nx">dir</span>
    <span class="k">throw</span> <span class="s2">&quot;Invalid directory&quot;</span> <span class="nx">unless</span> <span class="nx">absdir</span><span class="o">?</span>
    <span class="nx">absdir</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 