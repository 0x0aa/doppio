<!DOCTYPE html>

<html>
<head>
  <title>attributes.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>attributes.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>pull in external modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>util = require <span class="string">'./util'</span>
opcodes = require <span class="string">'./opcodes'</span>

<span class="string">"use strict"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>things assigned to root will be available outside this module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root = exports ? window.attributes ?= {}

<span class="class"><span class="keyword">class</span> <span class="title">ExceptionHandler</span></span>
  name: <span class="string">'ExceptionHandler'</span>
  parse: (bytes_array,constant_pool) -&gt;
    <span class="property">@start_pc</span>   = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@end_pc</span>     = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@handler_pc</span> = bytes_array.get_uint <span class="number">2</span>
    cti = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@catch_type</span> =
      <span class="keyword">if</span> cti <span class="keyword">is</span> <span class="number">0</span>
        <span class="string">"&lt;any&gt;"</span>
      <span class="keyword">else</span>
        constant_pool.get(cti).deref()

<span class="class"><span class="keyword">class</span> <span class="title">Code</span></span>
  name: <span class="string">'Code'</span>
  parse: (bytes_array,<span class="property">@constant_pool</span>) -&gt;
    <span class="property">@max_stack</span> = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@max_locals</span> = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@code_len</span> = bytes_array.get_uint <span class="number">4</span>
    RELEASE? || <span class="keyword">throw</span> <span class="string">"Code.parse error: Code length is zero"</span> <span class="keyword">if</span> <span class="property">@code_len</span> == <span class="number">0</span>
    <span class="property">@_code_array</span> = bytes_array.splice(<span class="property">@code_len</span>)
    <span class="property">@opcodes</span> = <span class="literal">null</span>
    except_len = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@exception_handlers</span> = (<span class="keyword">new</span> ExceptionHandler <span class="keyword">for</span> [<span class="number">0.</span>..except_len])
    <span class="keyword">for</span> eh <span class="keyword">in</span> <span class="property">@exception_handlers</span>
      eh.parse bytes_array, constant_pool</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>yes, there are even attrs on attrs. BWOM... BWOM...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@attrs</span> = root.make_attributes(bytes_array,constant_pool)
    <span class="property">@run_stamp</span> = <span class="number">0</span>

  parse_code: -&gt;
    <span class="property">@opcodes</span> = <span class="keyword">new</span> Array <span class="property">@code_len</span>
    <span class="keyword">while</span> <span class="property">@_code_array</span>.has_bytes()
      op_index = <span class="property">@_code_array</span>.pos()
      c = <span class="property">@_code_array</span>.get_uint <span class="number">1</span>
      wide = c == <span class="number">196</span>
      <span class="keyword">if</span> wide <span class="comment"># wide opcode needs to be handled specially</span>
        c = <span class="property">@_code_array</span>.get_uint <span class="number">1</span>
      RELEASE? || <span class="keyword">throw</span> <span class="string">"unknown opcode code: <span class="subst">#{c}</span>"</span> <span class="keyword">unless</span> opcodes.opcodes[c]?
      op = Object.create opcodes.opcodes[c]
      op.take_args <span class="property">@_code_array</span>, <span class="property">@constant_pool</span>, wide
      <span class="property">@opcodes</span>[op_index] = op
    <span class="property">@_code_array</span>.rewind()
    <span class="keyword">return</span>

  each_opcode: (fn) -&gt;
    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>.<span class="property">@code_len</span>] <span class="keyword">when</span> i <span class="keyword">of</span> <span class="property">@opcodes</span>
      fn(i, <span class="property">@opcodes</span>[i])

  get_attribute: (name) -&gt;
    <span class="keyword">for</span> attr <span class="keyword">in</span> <span class="property">@attrs</span> <span class="keyword">then</span> <span class="keyword">if</span> attr.name <span class="keyword">is</span> name <span class="keyword">then</span> <span class="keyword">return</span> attr
    <span class="keyword">return</span> <span class="literal">null</span>

<span class="class"><span class="keyword">class</span> <span class="title">LineNumberTable</span></span>
  name: <span class="string">'LineNumberTable'</span>
  parse: (bytes_array,constant_pool) -&gt;
    <span class="property">@entries</span> = []
    lnt_len = bytes_array.get_uint <span class="number">2</span>
    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..lnt_len] <span class="keyword">by</span> <span class="number">1</span>
      spc = bytes_array.get_uint <span class="number">2</span>
      ln = bytes_array.get_uint <span class="number">2</span>
      <span class="property">@entries</span>.push {<span class="string">'start_pc'</span>: spc,<span class="string">'line_number'</span>: ln}

  disassemblyOutput: -&gt;
    rv = <span class="string">"  LineNumberTable:\n"</span>
    rv += <span class="string">"   line <span class="subst">#{entry.line_number}</span>: <span class="subst">#{entry.start_pc}</span>\n"</span> <span class="keyword">for</span> entry <span class="keyword">in</span> <span class="property">@entries</span>
    rv

<span class="class"><span class="keyword">class</span> <span class="title">SourceFile</span></span>
  name: <span class="string">'SourceFile'</span>
  parse: (bytes_array,constant_pool) -&gt;
    <span class="property">@filename</span> = constant_pool.get(bytes_array.get_uint <span class="number">2</span>).value

<span class="class"><span class="keyword">class</span> <span class="title">StackMapTable</span></span>
  name: <span class="string">'StackMapTable'</span>
  parse: (bytes_array, constant_pool) -&gt;
    <span class="property">@num_entries</span> = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@entries</span> = (parse_entries(bytes_array, constant_pool) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@num_entries</span>] <span class="keyword">by</span> <span class="number">1</span>)

  <span class="function"><span class="title">parse_entries</span></span> = (bytes_array, constant_pool) -&gt;
    frame_type = bytes_array.get_uint <span class="number">1</span>
    <span class="keyword">if</span> <span class="number">0</span> &lt;= frame_type &lt; <span class="number">64</span>
      { frame_type: frame_type, frame_name: <span class="string">'same'</span> }
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">64</span> &lt;= frame_type &lt; <span class="number">128</span>
      {
        frame_type: frame_type
        frame_name: <span class="string">'same_locals_1_stack_item'</span>
        stack: [parse_verification_type_info(bytes_array, constant_pool)]
      }
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">128</span> &lt;= frame_type &lt; <span class="number">247</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>reserve for future use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span> <span class="keyword">if</span> frame_type == <span class="number">247</span>
      {
        frame_type: frame_type
        frame_name: <span class="string">'same_locals_1_stack_item_frame_extended'</span>
        offset_delta: bytes_array.get_uint <span class="number">2</span>
        stack: [parse_verification_type_info(bytes_array, constant_pool)]
      }
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">248</span> &lt;= frame_type &lt; <span class="number">251</span>
      {
        frame_type: frame_type
        frame_name: <span class="string">'chop'</span>
        offset_delta: [bytes_array.get_uint <span class="number">2</span>]
      }
    <span class="keyword">else</span> <span class="keyword">if</span> frame_type == <span class="number">251</span>
      {
        frame_type: frame_type
        frame_name: <span class="string">'same_frame_extended'</span>
        offset_delta: [bytes_array.get_uint <span class="number">2</span>]
      }
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">252</span> &lt;= frame_type &lt; <span class="number">255</span>
      {
        frame_type: frame_type
        frame_name: <span class="string">'append'</span>
        offset_delta: bytes_array.get_uint <span class="number">2</span>
        locals: parse_verification_type_info(bytes_array, constant_pool) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..frame_type-<span class="number">251</span>] <span class="keyword">by</span> <span class="number">1</span>
      }
    <span class="keyword">else</span> <span class="keyword">if</span> frame_type == <span class="number">255</span>
      {
        frame_type: frame_type
        frame_name: <span class="string">'full_frame'</span>
        offset_delta: bytes_array.get_uint <span class="number">2</span>
        num_locals: num_locals = bytes_array.get_uint <span class="number">2</span>
        locals: parse_verification_type_info(bytes_array, constant_pool) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_locals] <span class="keyword">by</span> <span class="number">1</span>
        num_stack_items: num_stack_items = bytes_array.get_uint <span class="number">2</span>
        stack: parse_verification_type_info(bytes_array, constant_pool) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_stack_items] <span class="keyword">by</span> <span class="number">1</span>
      }

  <span class="function"><span class="title">parse_verification_type_info</span></span> = (bytes_array, constant_pool) -&gt;
    tag = bytes_array.get_uint <span class="number">1</span>
    <span class="keyword">if</span> tag == <span class="number">7</span>
      cls = constant_pool.get(bytes_array.get_uint <span class="number">2</span>).deref()
      <span class="string">'class '</span> + (<span class="keyword">if</span> <span class="regexp">/\w/</span>.test cls[<span class="number">0</span>] <span class="keyword">then</span> util.descriptor2typestr(cls) <span class="keyword">else</span> <span class="string">"\"<span class="subst">#{cls}</span>\""</span>)
    <span class="keyword">else</span>
      tag_to_type = [ <span class="string">'bogus'</span>, <span class="string">'int'</span>, <span class="string">'float'</span>, <span class="string">'double'</span>, <span class="string">'long'</span>, <span class="string">'null'</span>, <span class="string">'this'</span>, <span class="string">'object'</span>, <span class="string">'uninitialized'</span> ]
      tag_to_type[tag]

  disassemblyOutput: -&gt;
    rv = <span class="string">"  StackMapTable: number_of_entries = <span class="subst">#{@num_entries}</span>\n"</span>
    <span class="keyword">for</span> entry <span class="keyword">in</span> <span class="property">@entries</span>
      rv += <span class="string">"   frame_type = <span class="subst">#{entry.frame_type}</span> /* <span class="subst">#{entry.frame_name}</span> */\n"</span>
      rv += <span class="string">"     offset_delta = <span class="subst">#{entry.offset_delta}</span>\n"</span> <span class="keyword">if</span> entry.offset_delta?
      rv += <span class="string">"     locals = [ <span class="subst">#{entry.locals.join(', ')}</span> ]\n"</span> <span class="keyword">if</span> entry.locals?
      rv += <span class="string">"     stack = [ <span class="subst">#{entry.stack.join(', ')}</span> ]\n"</span> <span class="keyword">if</span> entry.stack?
    rv

<span class="class"><span class="keyword">class</span> <span class="title">LocalVariableTable</span></span>
  name: <span class="string">'LocalVariableTable'</span>
  parse: (bytes_array, constant_pool) -&gt;
    <span class="property">@num_entries</span> = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@entries</span> = (<span class="property">@parse_entries</span> bytes_array, constant_pool <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@num_entries</span>] <span class="keyword">by</span> <span class="number">1</span>)

  parse_entries: (bytes_array, constant_pool) -&gt;
    {
      start_pc: bytes_array.get_uint <span class="number">2</span>
      length: bytes_array.get_uint <span class="number">2</span>
      name: constant_pool.get(bytes_array.get_uint <span class="number">2</span>).value
      descriptor: constant_pool.get(bytes_array.get_uint <span class="number">2</span>).value
      ref: bytes_array.get_uint <span class="number">2</span>
    }

  disassemblyOutput: -&gt;
    rv = <span class="string">"  LocalVariableTable:\n   Start  Length  Slot  Name   Signature\n"</span>
    <span class="keyword">for</span> entry <span class="keyword">in</span> <span class="property">@entries</span>
      rv += <span class="string">"   <span class="subst">#{entry.start_pc}</span>      <span class="subst">#{entry.length}</span>      <span class="subst">#{entry.ref}</span>"</span>
      rv += <span class="string">"<span class="subst">#{entry.name}</span>      <span class="subst">#{entry.descriptor}</span>\n"</span>
    rv

<span class="class"><span class="keyword">class</span> <span class="title">Exceptions</span></span>
  name: <span class="string">'Exceptions'</span>
  parse: (bytes_array, constant_pool) -&gt;
    <span class="property">@num_exceptions</span> = bytes_array.get_uint <span class="number">2</span>
    exc_refs = (bytes_array.get_uint <span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@num_exceptions</span>] <span class="keyword">by</span> <span class="number">1</span>)
    <span class="property">@exceptions</span> = (constant_pool.get(ref).deref() <span class="keyword">for</span> ref <span class="keyword">in</span> exc_refs)

<span class="class"><span class="keyword">class</span> <span class="title">InnerClasses</span></span>
  name: <span class="string">'InnerClasses'</span>
  parse: (bytes_array, constant_pool) -&gt;
    num_classes = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@classes</span> = (<span class="property">@parse_class</span> bytes_array, constant_pool <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_classes] <span class="keyword">by</span> <span class="number">1</span>)

  parse_class: (bytes_array, constant_pool) -&gt;
    {
      inner_info_index: bytes_array.get_uint <span class="number">2</span>
      outer_info_index: bytes_array.get_uint <span class="number">2</span>
      inner_name_index: bytes_array.get_uint <span class="number">2</span>
      inner_access_flags: bytes_array.get_uint <span class="number">2</span>
    }

<span class="class"><span class="keyword">class</span> <span class="title">ConstantValue</span></span>
  name: <span class="string">'ConstantValue'</span>
  parse: (bytes_array, constant_pool) -&gt;
    <span class="property">@ref</span> = bytes_array.get_uint <span class="number">2</span>
    valref = constant_pool.get(<span class="property">@ref</span>)
    <span class="property">@value</span> = valref.deref?() <span class="keyword">or</span> valref.value

<span class="class"><span class="keyword">class</span> <span class="title">Synthetic</span></span>
  name: <span class="string">'Synthetic'</span>
  parse: () -&gt;  <span class="comment"># NOP</span>

<span class="class"><span class="keyword">class</span> <span class="title">Deprecated</span></span>
  name: <span class="string">'Deprecated'</span>
  parse: () -&gt;  <span class="comment"># NOP</span>

<span class="class"><span class="keyword">class</span> <span class="title">Signature</span></span>
  name: <span class="string">'Signature'</span>
  parse: (bytes_array, constant_pool, attr_len) -&gt;
    <span class="property">@raw_bytes</span> = bytes_array.read attr_len
    ref = util.read_uint <span class="property">@raw_bytes</span>
    <span class="property">@sig</span> = constant_pool.get(ref).value

<span class="class"><span class="keyword">class</span> <span class="title">RuntimeVisibleAnnotations</span></span>
  name: <span class="string">'RuntimeVisibleAnnotations'</span>
  parse: (bytes_array, constant_pool, attr_len) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>num_annotations = bytes_array.get_uint 2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@raw_bytes</span> = bytes_array.read attr_len

<span class="class"><span class="keyword">class</span> <span class="title">AnnotationDefault</span></span>
  name: <span class="string">'AnnotationDefault'</span>
  parse: (bytes_array, constant_pool, attr_len) -&gt;
    <span class="property">@raw_bytes</span> = bytes_array.read attr_len

<span class="class"><span class="keyword">class</span> <span class="title">EnclosingMethod</span></span>
  name: <span class="string">'EnclosingMethod'</span>
  parse: (bytes_array, constant_pool) -&gt;
    <span class="property">@enc_class</span> = constant_pool.get(bytes_array.get_uint <span class="number">2</span>).deref()
    method_ref = bytes_array.get_uint <span class="number">2</span>
    <span class="keyword">if</span> method_ref &gt; <span class="number">0</span>
      <span class="property">@enc_method</span> = constant_pool.get(method_ref).deref()


root.<span class="function"><span class="title">make_attributes</span></span> = (bytes_array,constant_pool) -&gt;
  attr_types = {
    <span class="string">'Code'</span>: Code, <span class="string">'LineNumberTable'</span>: LineNumberTable, <span class="string">'SourceFile'</span>: SourceFile,
    <span class="string">'StackMapTable'</span>: StackMapTable, <span class="string">'LocalVariableTable'</span>: LocalVariableTable,
    <span class="string">'ConstantValue'</span>: ConstantValue, <span class="string">'Exceptions'</span>: Exceptions,
    <span class="string">'InnerClasses'</span>: InnerClasses, <span class="string">'Synthetic'</span>: Synthetic,
    <span class="string">'Deprecated'</span>: Deprecated, <span class="string">'Signature'</span>: Signature,
    <span class="string">'RuntimeVisibleAnnotations'</span>: RuntimeVisibleAnnotations,
    <span class="string">'AnnotationDefault'</span>: AnnotationDefault,
    <span class="string">'EnclosingMethod'</span>: EnclosingMethod,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>NYI: LocalVariableTypeTable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
  num_attrs = bytes_array.get_uint <span class="number">2</span>
  attrs = []
  <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..num_attrs] <span class="keyword">by</span> <span class="number">1</span>
    name = constant_pool.get(bytes_array.get_uint <span class="number">2</span>).value
    attr_len = bytes_array.get_uint <span class="number">4</span>
    <span class="keyword">if</span> attr_types[name]?
      attr = <span class="keyword">new</span> attr_types[name]
      old_len = bytes_array.size()
      attr.parse bytes_array, constant_pool, attr_len
      new_len = bytes_array.size()
      <span class="keyword">if</span> old_len - new_len != attr_len</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>throw new Error &quot;#{name} attribute didn&#39;t consume all bytes&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        bytes_array.skip attr_len - old_len + new_len
      attrs.push attr
    <span class="keyword">else</span> <span class="comment"># we must silently ignore other attrs</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>console.log &quot;ignoring #{attr_len} bytes for attr #{name}&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      bytes_array.skip attr_len
  <span class="keyword">return</span> attrs</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
