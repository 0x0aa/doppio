<!DOCTYPE html>

<html>
<head>
  <title>ConstantPool.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ConstantPool.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Export a single &#39;ConstantPool&#39; constructor.</p>
<p>pull in external modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>gLong = require <span class="string">'../vendor/gLong.js'</span>
util = require <span class="string">'./util'</span>

<span class="string">"use strict"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>All objects in the constant pool have the properties @type and @value.
*Reference and NameAndType objects all have a @deref method, which resolves
all child references to their values (i.e. discarding @type).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">SimpleReference</span></span>
  constructor: (<span class="property">@constant_pool</span>, <span class="property">@value</span>) -&gt;

  <span class="property">@size</span>: <span class="number">1</span>

  <span class="property">@from_bytes</span>: (bytes_array, constant_pool) -&gt;
    value = bytes_array.get_uint <span class="number">2</span>
    ref = <span class="keyword">new</span> @ constant_pool, value
    <span class="keyword">return</span> ref

  deref: -&gt;
    pool_obj = <span class="property">@constant_pool</span>[<span class="property">@value</span>]
    pool_obj.deref?() <span class="keyword">or</span> pool_obj.value

<span class="class"><span class="keyword">class</span> <span class="title">ClassReference</span> <span class="keyword">extends</span> <span class="title">SimpleReference</span></span>
  constructor: (<span class="property">@constant_pool</span>, <span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'class'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>the ConstantPool stores class names without the L...; descriptor stuff</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deref: -&gt;
    pool_obj = <span class="property">@constant_pool</span>[<span class="property">@value</span>]
    pool_obj.deref?() <span class="keyword">or</span> util.typestr2descriptor(pool_obj.value)

<span class="class"><span class="keyword">class</span> <span class="title">StringReference</span> <span class="keyword">extends</span> <span class="title">SimpleReference</span></span>
  constructor: (<span class="property">@constant_pool</span>, <span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'String'</span>

<span class="class"><span class="keyword">class</span> <span class="title">AbstractMethodFieldReference</span></span>
  <span class="property">@size</span>: <span class="number">1</span>

  <span class="property">@from_bytes</span>: (bytes_array, constant_pool) -&gt;
    class_ref = ClassReference.from_bytes bytes_array, constant_pool
    sig = SimpleReference.from_bytes bytes_array, constant_pool
    ref = <span class="keyword">new</span> @ constant_pool, { class_ref: class_ref, sig: sig }
    <span class="keyword">return</span> ref

  deref: -&gt;
    sig = <span class="property">@value</span>.sig.deref()
    {
      class: <span class="property">@value</span>.class_ref.deref()
      sig: sig.name + sig.type
    }

<span class="class"><span class="keyword">class</span> <span class="title">MethodReference</span> <span class="keyword">extends</span> <span class="title">AbstractMethodFieldReference</span></span>
  constructor: (<span class="property">@constant_pool</span>, <span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'Method'</span>

<span class="class"><span class="keyword">class</span> <span class="title">InterfaceMethodReference</span> <span class="keyword">extends</span> <span class="title">AbstractMethodFieldReference</span></span>
  constructor: (<span class="property">@constant_pool</span>, <span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'InterfaceMethod'</span>

<span class="class"><span class="keyword">class</span> <span class="title">FieldReference</span> <span class="keyword">extends</span> <span class="title">AbstractMethodFieldReference</span></span>
  constructor: (<span class="property">@constant_pool</span>, <span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'Field'</span>

  deref: -&gt;
    sig = <span class="property">@value</span>.sig.deref()
    {
      class: <span class="property">@value</span>.class_ref.deref()
      name: sig.name
      type: sig.type
    }

<span class="class"><span class="keyword">class</span> <span class="title">MethodSignature</span></span>
  constructor: (<span class="property">@constant_pool</span>, <span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'NameAndType'</span>

  <span class="property">@size</span>: <span class="number">1</span>

  <span class="property">@from_bytes</span>: (bytes_array, constant_pool) -&gt;
    meth_ref = StringReference.from_bytes bytes_array, constant_pool
    type_ref = StringReference.from_bytes bytes_array, constant_pool
    ref = <span class="keyword">new</span> @ constant_pool, { meth_ref: meth_ref, type_ref: type_ref }
    <span class="keyword">return</span> ref

  deref: -&gt;
    {
      name: <span class="property">@value</span>.meth_ref.deref()
      type: <span class="property">@value</span>.type_ref.deref()
    }

<span class="class"><span class="keyword">class</span> <span class="title">ConstString</span></span>
  constructor: (<span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'Asciz'</span>

  <span class="property">@size</span>: <span class="number">1</span>

  <span class="property">@from_bytes</span>: (bytes_array) -&gt;
    strlen = bytes_array.get_uint <span class="number">2</span>
    value = util.bytes2str bytes_array.read(strlen)
    const_string = <span class="keyword">new</span> @ value
    <span class="keyword">return</span> const_string

<span class="class"><span class="keyword">class</span> <span class="title">ConstInt32</span></span>
  constructor: (<span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'int'</span>

  <span class="property">@size</span>: <span class="number">1</span>

  <span class="property">@from_bytes</span>: (bytes_array) -&gt;
    uint32 = bytes_array.get_uint <span class="number">4</span>
    value = -(<span class="number">1</span> + ~uint32)  <span class="comment"># convert to signed integer ONLY FOR 32 BITS</span>
    int32 = <span class="keyword">new</span> @ value
    <span class="keyword">return</span> int32

<span class="class"><span class="keyword">class</span> <span class="title">ConstFloat</span></span>
  constructor: (<span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'float'</span>

  <span class="property">@size</span>: <span class="number">1</span>

  <span class="property">@from_bytes</span>: (bytes_array) -&gt;
    uint32 = bytes_array.get_uint <span class="number">4</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We OR with 0 to convert to a signed int.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    value = util.intbits2float(uint32|<span class="number">0</span>)
    float = <span class="keyword">new</span> @ value
    <span class="keyword">return</span> float

<span class="class"><span class="keyword">class</span> <span class="title">ConstLong</span></span>
  constructor: (<span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'long'</span>

  <span class="property">@size</span>: <span class="number">2</span>

  <span class="property">@from_bytes</span>: (bytes_array) -&gt;
    high = bytes_array.get_uint <span class="number">4</span>
    low = bytes_array.get_uint <span class="number">4</span>
    value = gLong.fromBits(low,high)
    long = <span class="keyword">new</span> @ value
    <span class="keyword">return</span> long

<span class="class"><span class="keyword">class</span> <span class="title">ConstDouble</span></span>
  constructor: (<span class="property">@value</span>) -&gt; <span class="property">@type</span> = <span class="string">'double'</span>

  <span class="property">@size</span>: <span class="number">2</span>

  <span class="property">@from_bytes</span>: (bytes_array) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>a hack since bitshifting in js is 32bit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    uint32_a = bytes_array.get_uint <span class="number">4</span>
    uint32_b = bytes_array.get_uint <span class="number">4</span>
    double = <span class="keyword">new</span> @ util.longbits2double(uint32_a, uint32_b)
    <span class="keyword">return</span> double

<span class="class"><span class="keyword">class</span> <span class="title">ConstantPool</span></span>
  parse: (bytes_array) -&gt;
    constant_tags = {
      <span class="number">1</span>: ConstString, <span class="number">3</span>: ConstInt32, <span class="number">4</span>: ConstFloat, <span class="number">5</span>: ConstLong,
      <span class="number">6</span>: ConstDouble, <span class="number">7</span>: ClassReference, <span class="number">8</span>: StringReference, <span class="number">9</span>: FieldReference,
      <span class="number">10</span>: MethodReference, <span class="number">11</span>: InterfaceMethodReference, <span class="number">12</span>: MethodSignature
    }
    <span class="property">@cp_count</span> = bytes_array.get_uint <span class="number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>constant_pool works like an array, but not all indices have values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@constant_pool</span> = {}
    idx = <span class="number">1</span>  <span class="comment"># CP indexing starts at zero</span>
    <span class="keyword">while</span> idx &lt; <span class="property">@cp_count</span>
      tag = bytes_array.get_uint <span class="number">1</span>
      <span class="keyword">throw</span> <span class="string">"invalid tag: <span class="subst">#{tag}</span>"</span> <span class="keyword">unless</span> <span class="number">1</span> &lt;= tag &lt;= <span class="number">12</span>
      pool_obj = constant_tags[tag].from_bytes(bytes_array, <span class="property">@constant_pool</span>)
      <span class="property">@constant_pool</span>[idx] = pool_obj
      idx += constant_tags[tag].size
    <span class="keyword">return</span> bytes_array

  get: (idx) -&gt; <span class="property">@constant_pool</span>[idx] ?
                  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Invalid constant_pool reference: <span class="subst">#{idx}</span>"</span>)

  each: (fn) -&gt;
    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>.<span class="property">@cp_count</span>] <span class="keyword">when</span> i <span class="keyword">of</span> <span class="property">@constant_pool</span>
      fn(i, <span class="property">@constant_pool</span>[i])

<span class="keyword">if</span> module?
  module.exports = ConstantPool
<span class="keyword">else</span>
  window.ConstantPool = ConstantPool</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
