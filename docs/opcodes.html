<!DOCTYPE html>

<html>
<head>
  <title>opcodes.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>opcodes.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
gLong = require <span class="string">'../vendor/gLong.js'</span>
util = require <span class="string">'./util'</span>
{ReturnException,JavaException} = require <span class="string">'./exceptions'</span>
{JavaObject,JavaArray,JavaClassLoaderObject} = require <span class="string">'./java_object'</span>

<span class="string">"use strict"</span>

root = exports ? window.opcodes = {}

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (<span class="property">@name</span>, params={}) -&gt;
    (@[prop] = val <span class="keyword">for</span> prop, val <span class="keyword">of</span> params)
    <span class="property">@execute</span> ?= <span class="property">@_execute</span>
    <span class="property">@byte_count</span> = params.byte_count ? <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Backup so we can reset caching between JVM invocations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@orig_execute</span> = <span class="property">@execute</span>

  take_args: (code_array) -&gt;
    <span class="property">@args</span> = (code_array.get_uint(<span class="number">1</span>) <span class="keyword">for</span> [<span class="number">0.</span>..<span class="property">@byte_count</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>called to provide opcode annotations for disassembly and vtrace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  annotate: -&gt; <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Used to reset any cached information between JVM invocations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset_cache: -&gt; <span class="property">@execute</span> = <span class="property">@orig_execute</span> <span class="keyword">unless</span> <span class="property">@execute</span> <span class="keyword">is</span> <span class="property">@orig_execute</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">FieldOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, params
    <span class="property">@byte_count</span> = <span class="number">2</span>

  take_args: (code_array, constant_pool) -&gt;
    <span class="property">@field_spec_ref</span> = code_array.get_uint(<span class="number">2</span>)
    <span class="property">@field_spec</span> = constant_pool.get(<span class="property">@field_spec_ref</span>).deref()

  annotate: (idx, pool) -&gt;
    <span class="string">"\t#<span class="subst">#{@field_spec_ref}</span>;<span class="subst">#{util.format_extra_info pool.get @field_spec_ref}</span>"</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">ClassOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, params
    <span class="property">@byte_count</span> = <span class="number">2</span>

  take_args: (code_array, constant_pool) -&gt;
    <span class="property">@class_ref</span> = code_array.get_uint(<span class="number">2</span>)
    <span class="property">@class</span> = constant_pool.get(<span class="property">@class_ref</span>).deref()

  annotate: (idx, pool) -&gt;
    <span class="string">"\t#<span class="subst">#{@class_ref}</span>;<span class="subst">#{util.format_extra_info pool.get @class_ref}</span>"</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">InvokeOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, params
    <span class="property">@byte_count</span> = <span class="number">2</span>

  take_args: (code_array, constant_pool) -&gt;
    <span class="property">@method_spec_ref</span> = code_array.get_uint(<span class="number">2</span>)
    <span class="property">@method_spec</span> = constant_pool.get(<span class="property">@method_spec_ref</span>).deref()

  annotate: (idx, pool) -&gt;
    <span class="string">"\t#<span class="subst">#{@method_spec_ref}</span>"</span> +
    (<span class="keyword">if</span> <span class="property">@name</span> == <span class="string">'invokeinterface'</span> <span class="keyword">then</span> <span class="string">",  <span class="subst">#{@count}</span>"</span> <span class="keyword">else</span> <span class="string">""</span>) +
    <span class="string">";<span class="subst">#{util.format_extra_info pool.get @method_spec_ref}</span>"</span>

  execute: (rs) -&gt;
    cls = rs.get_class(<span class="property">@method_spec</span>.class, <span class="literal">true</span>)
    <span class="keyword">if</span> cls?
      my_sf = rs.curr_frame()
      <span class="keyword">if</span> cls.method_lookup(rs, <span class="property">@method_spec</span>).setup_stack(rs)?
        my_sf.pc += <span class="number">1</span> + <span class="property">@byte_count</span>
        <span class="keyword">throw</span> ReturnException
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Initialize @method_spec.class and rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().initialize_class rs, <span class="property">@method_spec</span>.class,
          (-&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
    <span class="keyword">return</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">DynInvokeOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">InvokeOpcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, params
    <span class="property">@byte_count</span> = <span class="number">2</span>

  take_args: (code_array, constant_pool) -&gt;
    <span class="keyword">super</span> code_array, constant_pool</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>invokeinterface has two redundant bytes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="property">@name</span> == <span class="string">'invokeinterface'</span>
      <span class="property">@count</span> = code_array.get_uint <span class="number">1</span>
      code_array.skip <span class="number">1</span>
      <span class="property">@byte_count</span> += <span class="number">2</span>
    <span class="keyword">else</span> <span class="comment"># invokevirtual</span>
      <span class="property">@count</span> = <span class="number">1</span> + get_param_word_size <span class="property">@method_spec</span>.sig
    <span class="property">@cache</span> = Object.create <span class="literal">null</span>

  execute: (rs) -&gt;
    my_sf = rs.curr_frame()
    stack = my_sf.stack
    obj = stack[stack.length - <span class="property">@count</span>]
    cls_obj = rs.check_null(obj).cls
    cls = cls_obj.get_type()
    <span class="keyword">if</span> cls_obj.method_lookup(rs, {class: cls, sig: <span class="property">@method_spec</span>.sig}).setup_stack(rs)?
      my_sf.pc += <span class="number">1</span> + <span class="property">@byte_count</span>
      <span class="keyword">throw</span> ReturnException

  <span class="function"><span class="title">get_param_word_size</span></span> = (spec) -&gt;
    state = <span class="string">'name'</span>
    size = <span class="number">0</span>
    <span class="keyword">for</span> c <span class="keyword">in</span> spec
      <span class="keyword">switch</span> state
        <span class="keyword">when</span> <span class="string">'name'</span>
          state = <span class="string">'type'</span> <span class="keyword">if</span> c <span class="keyword">is</span> <span class="string">'('</span>
        <span class="keyword">when</span> <span class="string">'type'</span>
          <span class="keyword">if</span> c <span class="keyword">is</span> <span class="string">')'</span>
            <span class="keyword">return</span> size
          <span class="keyword">if</span> c <span class="keyword">in</span> [<span class="string">'J'</span>, <span class="string">'D'</span>]
            size += <span class="number">2</span>
          <span class="keyword">else</span>
            ++size
          <span class="keyword">if</span> c <span class="keyword">is</span> <span class="string">'L'</span>
            state = <span class="string">'class'</span>
          <span class="keyword">else</span> <span class="keyword">if</span> c <span class="keyword">is</span> <span class="string">'['</span>
            state = <span class="string">'array'</span>
        <span class="keyword">when</span> <span class="string">'class'</span>
          state = <span class="string">'type'</span> <span class="keyword">if</span> c <span class="keyword">is</span> <span class="string">';'</span>
        <span class="keyword">when</span> <span class="string">'array'</span>
          <span class="keyword">if</span> c <span class="keyword">is</span> <span class="string">'L'</span>
            state = <span class="string">'class'</span>
          <span class="keyword">else</span> <span class="keyword">unless</span> c <span class="keyword">is</span> <span class="string">'['</span>
            state = <span class="string">'type'</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">LoadConstantOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  take_args: (code_array, constant_pool) -&gt;
    <span class="property">@constant_ref</span> = code_array.get_uint <span class="property">@byte_count</span>
    <span class="property">@constant</span> = constant_pool.get <span class="property">@constant_ref</span>
    <span class="property">@str_constant</span> = constant_pool.get <span class="property">@constant</span>.value <span class="keyword">if</span> <span class="property">@constant</span>.type <span class="keyword">in</span> [<span class="string">'String'</span>, <span class="string">'class'</span>]

  annotate: (idx, pool) -&gt;
    <span class="string">"\t#<span class="subst">#{@constant_ref}</span>;\t// <span class="subst">#{@constant.type}</span> "</span> +
      <span class="keyword">if</span> <span class="property">@constant</span>.type <span class="keyword">in</span> [<span class="string">'String'</span>, <span class="string">'class'</span>]
        util.escape_whitespace <span class="property">@constant</span>.deref()
      <span class="keyword">else</span>
        <span class="property">@constant</span>.value

  _execute: (rs) -&gt;
    <span class="keyword">switch</span> <span class="property">@constant</span>.type
      <span class="keyword">when</span> <span class="string">'String'</span>
        rs.push rs.init_string(<span class="property">@str_constant</span>.value, <span class="literal">true</span>)
      <span class="keyword">when</span> <span class="string">'class'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>XXX: Make this rewrite itself to cache the jclass object.
Fetch the jclass object and push it on to the stack. Do not rerun
this opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cdesc = util.typestr2descriptor <span class="property">@str_constant</span>.value
        rs.async_op (resume_cb, except_cb) =&gt;
          rs.get_cl().resolve_class(rs, cdesc, ((cls)=&gt;resume_cb cls.get_class_object(rs), <span class="literal">undefined</span>, <span class="literal">true</span>), except_cb)
        <span class="keyword">return</span>
      <span class="keyword">else</span>
        rs.push <span class="property">@constant</span>.value
    <span class="keyword">return</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">BranchOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params={}) -&gt;
    params.byte_count ?= <span class="number">2</span>
    <span class="keyword">super</span> name, params

  take_args: (code_array) -&gt;
    <span class="property">@offset</span> = code_array.get_int <span class="property">@byte_count</span>

  annotate: (idx, pool) -&gt; <span class="string">"\t<span class="subst">#{idx + @offset}</span>"</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">UnaryBranchOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">BranchOpcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, {
      execute: (rs) -&gt;
        v = rs.pop()
        <span class="keyword">if</span> params.cmp v
          rs.inc_pc(<span class="property">@offset</span>)
          <span class="literal">false</span>
        <span class="keyword">else</span>
          <span class="literal">true</span>
    }

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">BinaryBranchOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">BranchOpcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, {
      execute: (rs) -&gt;
        v2 = rs.pop()
        v1 = rs.pop()
        <span class="keyword">if</span> params.cmp v1, v2
          rs.inc_pc(<span class="property">@offset</span>)
          <span class="literal">false</span>
        <span class="keyword">else</span>
          <span class="literal">true</span>
    }

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">PushOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  take_args: (code_array) -&gt;
    <span class="property">@value</span> = code_array.get_int <span class="property">@byte_count</span>

  annotate: (idx, pool) -&gt; <span class="string">"\t<span class="subst">#{@value}</span>"</span>

  _execute: (rs) -&gt; rs.push <span class="property">@value</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">IIncOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, params

  take_args: (code_array, constant_pool, <span class="property">@wide</span>=<span class="literal">false</span>) -&gt;
    <span class="keyword">if</span> <span class="property">@wide</span>
      <span class="property">@name</span> += <span class="string">"_w"</span>
      arg_size = <span class="number">2</span>
      <span class="property">@byte_count</span> = <span class="number">5</span>
    <span class="keyword">else</span>
      arg_size = <span class="number">1</span>
      <span class="property">@byte_count</span> = <span class="number">2</span>
    <span class="property">@index</span> = code_array.get_uint arg_size
    <span class="property">@const</span> = code_array.get_int arg_size

  annotate: (idx, pool) -&gt; <span class="string">"\t<span class="subst">#{@index}</span>, <span class="subst">#{@<span class="reserved">const</span>}</span>"</span>

  _execute: (rs) -&gt;
    v = rs.cl(<span class="property">@index</span>)+<span class="property">@const</span>
    rs.put_cl <span class="property">@index</span>, v|<span class="number">0</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">LoadOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params={}) -&gt;
    params.execute ?=
      <span class="keyword">if</span> name.match <span class="regexp">/[ld]load/</span>
        (rs) -&gt; rs.push2 rs.cl(<span class="property">@var_num</span>), <span class="literal">null</span>
      <span class="keyword">else</span>
        (rs) -&gt; rs.push rs.cl(<span class="property">@var_num</span>)
    <span class="keyword">super</span> name, params

  take_args: (code_array) -&gt;
    <span class="property">@var_num</span> = parseInt <span class="property">@name</span>[<span class="number">6</span>]  <span class="comment"># sneaky hack, works for name =~ /.load_\d/</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">LoadVarOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">LoadOpcode</span></span>
  take_args: (code_array, constant_pool, <span class="property">@wide</span>=<span class="literal">false</span>) -&gt;
    <span class="keyword">if</span> <span class="property">@wide</span>
      <span class="property">@name</span> += <span class="string">"_w"</span>
      <span class="property">@byte_count</span> = <span class="number">3</span>
      <span class="property">@var_num</span> = code_array.get_uint <span class="number">2</span>
    <span class="keyword">else</span>
      <span class="property">@byte_count</span> = <span class="number">1</span>
      <span class="property">@var_num</span> = code_array.get_uint <span class="number">1</span>

  annotate: (idx, pool) -&gt; <span class="string">"\t<span class="subst">#{@var_num}</span>"</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">StoreOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params={}) -&gt;
    params.execute ?=
      <span class="keyword">if</span> name.match <span class="regexp">/[ld]store/</span>
        (rs) -&gt; rs.put_cl2(<span class="property">@var_num</span>,rs.pop2())
      <span class="keyword">else</span>
        (rs) -&gt; rs.put_cl(<span class="property">@var_num</span>,rs.pop())
    <span class="keyword">super</span> name, params

  take_args: (code_array) -&gt;
    <span class="property">@var_num</span> = parseInt <span class="property">@name</span>[<span class="number">7</span>]  <span class="comment"># sneaky hack, works for name =~ /.store_\d/</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">StoreVarOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">StoreOpcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, params

  take_args: (code_array, constant_pool, <span class="property">@wide</span>=<span class="literal">false</span>) -&gt;
    <span class="keyword">if</span> <span class="property">@wide</span>
      <span class="property">@name</span> += <span class="string">"_w"</span>
      <span class="property">@byte_count</span> = <span class="number">3</span>
      <span class="property">@var_num</span> = code_array.get_uint <span class="number">2</span>
    <span class="keyword">else</span>
      <span class="property">@byte_count</span> = <span class="number">1</span>
      <span class="property">@var_num</span> = code_array.get_uint <span class="number">1</span>

  annotate: (idx, pool) -&gt; <span class="string">"\t<span class="subst">#{@var_num}</span>"</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">SwitchOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">BranchOpcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, params
    <span class="property">@byte_count</span> = <span class="literal">null</span>

  annotate: (idx, pool) -&gt; <span class="string">"{\n"</span> +
    (<span class="string">"\t\t<span class="subst">#{match}</span>: <span class="subst">#{idx + offset}</span>;\n"</span> <span class="keyword">for</span> match, offset <span class="keyword">of</span> <span class="property">@offsets</span>).join(<span class="string">''</span>) +
    <span class="string">"\t\tdefault: <span class="subst">#{idx + @_<span class="reserved">default</span>}</span> }"</span>

  execute: (rs) -&gt;
    key = rs.pop()
    <span class="keyword">if</span> key <span class="keyword">of</span> <span class="property">@offsets</span>
      rs.inc_pc(<span class="property">@offsets</span>[key])
    <span class="keyword">else</span>
      rs.inc_pc(<span class="property">@_default</span>)
    <span class="literal">false</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">LookupSwitchOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">SwitchOpcode</span></span>
  take_args: (code_array, constant_pool) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>account for padding that ensures alignment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    padding_size = (<span class="number">4</span> - code_array.pos() % <span class="number">4</span>) % <span class="number">4</span>
    code_array.skip padding_size
    <span class="property">@_default</span> = code_array.get_int(<span class="number">4</span>)
    <span class="property">@npairs</span> = code_array.get_int(<span class="number">4</span>)
    <span class="property">@offsets</span> = {}
    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@npairs</span>] <span class="keyword">by</span> <span class="number">1</span>
      match = code_array.get_int(<span class="number">4</span>)
      offset = code_array.get_int(<span class="number">4</span>)
      <span class="property">@offsets</span>[match] = offset
    <span class="property">@byte_count</span> = padding_size + <span class="number">8</span> * (<span class="property">@npairs</span> + <span class="number">1</span>)

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">TableSwitchOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">SwitchOpcode</span></span>
  take_args: (code_array, constant_pool) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>account for padding that ensures alignment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    padding_size = (<span class="number">4</span> - code_array.pos() % <span class="number">4</span>) % <span class="number">4</span>
    code_array.skip padding_size
    <span class="property">@_default</span> = code_array.get_int(<span class="number">4</span>)
    <span class="property">@low</span> = code_array.get_int(<span class="number">4</span>)
    <span class="property">@high</span> = code_array.get_int(<span class="number">4</span>)
    <span class="property">@offsets</span> = {}
    total_offsets = <span class="property">@high</span> - <span class="property">@low</span> + <span class="number">1</span>
    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..total_offsets] <span class="keyword">by</span> <span class="number">1</span>
      offset = code_array.get_int(<span class="number">4</span>)
      <span class="property">@offsets</span>[<span class="property">@low</span> + i] = offset
    <span class="property">@byte_count</span> = padding_size + <span class="number">12</span> + <span class="number">4</span> * total_offsets

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">NewArrayOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params) -&gt;
    <span class="keyword">super</span> name, params
    <span class="property">@byte_count</span> = <span class="number">1</span>
    <span class="property">@arr_types</span> = {<span class="number">4</span>:<span class="string">'Z'</span>,<span class="number">5</span>:<span class="string">'C'</span>,<span class="number">6</span>:<span class="string">'F'</span>,<span class="number">7</span>:<span class="string">'D'</span>,<span class="number">8</span>:<span class="string">'B'</span>,<span class="number">9</span>:<span class="string">'S'</span>,<span class="number">10</span>:<span class="string">'I'</span>,<span class="number">11</span>:<span class="string">'J'</span>}

  take_args: (code_array,constant_pool) -&gt;
    type_code = code_array.get_uint <span class="number">1</span>
    <span class="property">@element_type</span> = <span class="property">@arr_types</span>[type_code]

  annotate: (idx, pool) -&gt; <span class="string">"\t<span class="subst">#{util.internal2external[@element_type]}</span>"</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">MultiArrayOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  constructor: (name, params={}) -&gt;
    params.byte_count ?= <span class="number">3</span>
    <span class="keyword">super</span> name, params

  take_args: (code_array, constant_pool) -&gt;
    <span class="property">@class_ref</span> = code_array.get_uint <span class="number">2</span>
    <span class="property">@class</span> = constant_pool.get(<span class="property">@class_ref</span>).deref()
    <span class="property">@dim</span> = code_array.get_uint <span class="number">1</span>

  annotate: (idx, pool) -&gt; <span class="string">"\t#<span class="subst">#{@class_ref}</span>,  <span class="subst">#{@dim}</span>;"</span>

  execute: (rs) -&gt;
    cls = rs.get_class <span class="property">@class</span>, <span class="literal">true</span>
    <span class="keyword">unless</span> cls?
      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().initialize_class rs, <span class="property">@class</span>,
          ((class_file)=&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
      <span class="keyword">return</span>

    <span class="function"><span class="title">new_execute</span></span> = (rs) -&gt;
      counts = rs.curr_frame().stack.splice(-<span class="property">@dim</span>,<span class="property">@dim</span>)
      default_val = util.initial_value <span class="property">@class</span>[<span class="property">@dim</span>..]
      arr_types = (<span class="property">@class</span>[d..] <span class="keyword">for</span> d <span class="keyword">in</span> [<span class="number">0.</span>..<span class="property">@dim</span>] <span class="keyword">by</span> <span class="number">1</span>)
      <span class="function"><span class="title">init_arr</span></span> = (curr_dim) =&gt;
        len = counts[curr_dim]
        <span class="keyword">if</span> len &lt; <span class="number">0</span> <span class="keyword">then</span> rs.java_throw(rs.get_bs_class(<span class="string">'Ljava/lang/NegativeArraySizeException;'</span>),
          <span class="string">"Tried to init dimension <span class="subst">#{curr_dim}</span> of a <span class="subst">#{@dim}</span> dimensional <span class="subst">#{@class.toString()}</span> array with length <span class="subst">#{len}</span>"</span>)
        type = arr_types[curr_dim]
        <span class="keyword">if</span> curr_dim+<span class="number">1</span> == <span class="property">@dim</span>
          array = (default_val <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..len] <span class="keyword">by</span> <span class="number">1</span>)
        <span class="keyword">else</span>
          array = (init_arr(curr_dim+<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..len] <span class="keyword">by</span> <span class="number">1</span>)
        <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(type), array
      rs.push init_arr <span class="number">0</span>

    new_execute.call(@, rs)
    <span class="property">@execute</span> = new_execute
    <span class="keyword">return</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">ArrayLoadOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  execute: (rs) -&gt;
    idx = rs.pop()
    obj = rs.check_null(rs.pop())
    array = obj.array
    <span class="keyword">unless</span> <span class="number">0</span> &lt;= idx &lt; array.length
      rs.java_throw(rs.get_bs_class(<span class="string">'Ljava/lang/ArrayIndexOutOfBoundsException;'</span>),
        <span class="string">"<span class="subst">#{idx}</span> not in length <span class="subst">#{array.length}</span> array of type <span class="subst">#{obj.cls.get_type()}</span>"</span>)
    rs.push array[idx]
    rs.push <span class="literal">null</span> <span class="keyword">if</span> <span class="property">@name</span>[<span class="number">0</span>] <span class="keyword">in</span> [<span class="string">'l'</span>, <span class="string">'d'</span>]
    <span class="keyword">return</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">ArrayStoreOpcode</span> <span class="keyword">extends</span> <span class="title">root</span>.<span class="title">Opcode</span></span>
  execute: (rs) -&gt;
    value = <span class="keyword">if</span> <span class="property">@name</span>[<span class="number">0</span>] <span class="keyword">in</span> [<span class="string">'l'</span>,<span class="string">'d'</span>] <span class="keyword">then</span> rs.pop2() <span class="keyword">else</span> rs.pop()
    idx = rs.pop()
    obj = rs.check_null(rs.pop())
    array = obj.array
    <span class="keyword">unless</span> <span class="number">0</span> &lt;= idx &lt; array.length
      rs.java_throw(rs.get_bs_class(<span class="string">'Ljava/lang/ArrayIndexOutOfBoundsException;'</span>),
        <span class="string">"<span class="subst">#{idx}</span> not in length <span class="subst">#{array.length}</span> array of type <span class="subst">#{obj.cls.get_type()}</span>"</span>)
    array[idx] = value
    <span class="keyword">return</span>

<span class="function"><span class="title">jsr</span></span> = (rs) -&gt;
  rs.push(rs.curr_pc()+<span class="property">@byte_count</span>+<span class="number">1</span>); rs.inc_pc(<span class="property">@offset</span>); <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>these objects are used as prototypes for the parsed instructions in the
classfile</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.opcodes = {
  <span class="number">0</span>: <span class="keyword">new</span> root.Opcode <span class="string">'nop'</span>, { execute: -&gt; }
  <span class="number">1</span>: <span class="keyword">new</span> root.Opcode <span class="string">'aconst_null'</span>, { execute: (rs) -&gt; rs.push <span class="literal">null</span> }
  <span class="number">2</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iconst_m1'</span>, { execute: (rs) -&gt; rs.push -<span class="number">1</span> }
  <span class="number">3</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iconst_0'</span>, { execute: (rs) -&gt; rs.push <span class="number">0</span> }
  <span class="number">4</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iconst_1'</span>, { execute: (rs) -&gt; rs.push <span class="number">1</span> }
  <span class="number">5</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iconst_2'</span>, { execute: (rs) -&gt; rs.push <span class="number">2</span> }
  <span class="number">6</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iconst_3'</span>, { execute: (rs) -&gt; rs.push <span class="number">3</span> }
  <span class="number">7</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iconst_4'</span>, { execute: (rs) -&gt; rs.push <span class="number">4</span> }
  <span class="number">8</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iconst_5'</span>, { execute: (rs) -&gt; rs.push <span class="number">5</span> }
  <span class="number">9</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lconst_0'</span>, { execute: (rs) -&gt; rs.push2 gLong.ZERO, <span class="literal">null</span> }
  <span class="number">10</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lconst_1'</span>, { execute: (rs) -&gt; rs.push2 gLong.ONE, <span class="literal">null</span> }
  <span class="number">11</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fconst_0'</span>, { execute: (rs) -&gt; rs.push <span class="number">0</span> }
  <span class="number">12</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fconst_1'</span>, { execute: (rs) -&gt; rs.push <span class="number">1</span> }
  <span class="number">13</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fconst_2'</span>, { execute: (rs) -&gt; rs.push <span class="number">2</span> }
  <span class="number">14</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dconst_0'</span>, { execute: (rs) -&gt; rs.push2 <span class="number">0</span>, <span class="literal">null</span> }
  <span class="number">15</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dconst_1'</span>, { execute: (rs) -&gt; rs.push2 <span class="number">1</span>, <span class="literal">null</span> }
  <span class="number">16</span>: <span class="keyword">new</span> root.PushOpcode <span class="string">'bipush'</span>, { byte_count: <span class="number">1</span> }
  <span class="number">17</span>: <span class="keyword">new</span> root.PushOpcode <span class="string">'sipush'</span>, { byte_count: <span class="number">2</span> }
  <span class="number">18</span>: <span class="keyword">new</span> root.LoadConstantOpcode <span class="string">'ldc'</span>, { byte_count: <span class="number">1</span> }
  <span class="number">19</span>: <span class="keyword">new</span> root.LoadConstantOpcode <span class="string">'ldc_w'</span>, { byte_count: <span class="number">2</span> }
  <span class="number">20</span>: <span class="keyword">new</span> root.LoadConstantOpcode <span class="string">'ldc2_w'</span>, { byte_count: <span class="number">2</span>, execute: ((rs) -&gt; rs.push2 <span class="property">@constant</span>.value, <span class="literal">null</span>) }
  <span class="number">21</span>: <span class="keyword">new</span> root.LoadVarOpcode <span class="string">'iload'</span>
  <span class="number">22</span>: <span class="keyword">new</span> root.LoadVarOpcode <span class="string">'lload'</span>
  <span class="number">23</span>: <span class="keyword">new</span> root.LoadVarOpcode <span class="string">'fload'</span>
  <span class="number">24</span>: <span class="keyword">new</span> root.LoadVarOpcode <span class="string">'dload'</span>
  <span class="number">25</span>: <span class="keyword">new</span> root.LoadVarOpcode <span class="string">'aload'</span>
  <span class="number">26</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'iload_0'</span>
  <span class="number">27</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'iload_1'</span>
  <span class="number">28</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'iload_2'</span>
  <span class="number">29</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'iload_3'</span>
  <span class="number">30</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'lload_0'</span>
  <span class="number">31</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'lload_1'</span>
  <span class="number">32</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'lload_2'</span>
  <span class="number">33</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'lload_3'</span>
  <span class="number">34</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'fload_0'</span>
  <span class="number">35</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'fload_1'</span>
  <span class="number">36</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'fload_2'</span>
  <span class="number">37</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'fload_3'</span>
  <span class="number">38</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'dload_0'</span>
  <span class="number">39</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'dload_1'</span>
  <span class="number">40</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'dload_2'</span>
  <span class="number">41</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'dload_3'</span>
  <span class="number">42</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'aload_0'</span>
  <span class="number">43</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'aload_1'</span>
  <span class="number">44</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'aload_2'</span>
  <span class="number">45</span>: <span class="keyword">new</span> root.LoadOpcode <span class="string">'aload_3'</span>
  <span class="number">46</span>: <span class="keyword">new</span> root.ArrayLoadOpcode <span class="string">'iaload'</span>
  <span class="number">47</span>: <span class="keyword">new</span> root.ArrayLoadOpcode <span class="string">'laload'</span>
  <span class="number">48</span>: <span class="keyword">new</span> root.ArrayLoadOpcode <span class="string">'faload'</span>
  <span class="number">49</span>: <span class="keyword">new</span> root.ArrayLoadOpcode <span class="string">'daload'</span>
  <span class="number">50</span>: <span class="keyword">new</span> root.ArrayLoadOpcode <span class="string">'aaload'</span>
  <span class="number">51</span>: <span class="keyword">new</span> root.ArrayLoadOpcode <span class="string">'baload'</span>
  <span class="number">52</span>: <span class="keyword">new</span> root.ArrayLoadOpcode <span class="string">'caload'</span>
  <span class="number">53</span>: <span class="keyword">new</span> root.ArrayLoadOpcode <span class="string">'saload'</span>
  <span class="number">54</span>: <span class="keyword">new</span> root.StoreVarOpcode <span class="string">'istore'</span>, { execute: (rs) -&gt; rs.put_cl(<span class="property">@var_num</span>,rs.pop()) }
  <span class="number">55</span>: <span class="keyword">new</span> root.StoreVarOpcode <span class="string">'lstore'</span>, { execute: (rs) -&gt; rs.put_cl2(<span class="property">@var_num</span>,rs.pop2()) }
  <span class="number">56</span>: <span class="keyword">new</span> root.StoreVarOpcode <span class="string">'fstore'</span>, { execute: (rs) -&gt; rs.put_cl(<span class="property">@var_num</span>,rs.pop()) }
  <span class="number">57</span>: <span class="keyword">new</span> root.StoreVarOpcode <span class="string">'dstore'</span>, { execute: (rs) -&gt; rs.put_cl2(<span class="property">@var_num</span>,rs.pop2()) }
  <span class="number">58</span>: <span class="keyword">new</span> root.StoreVarOpcode <span class="string">'astore'</span>, { execute: (rs) -&gt; rs.put_cl(<span class="property">@var_num</span>,rs.pop()) }
  <span class="number">59</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'istore_0'</span>
  <span class="number">60</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'istore_1'</span>
  <span class="number">61</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'istore_2'</span>
  <span class="number">62</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'istore_3'</span>
  <span class="number">63</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'lstore_0'</span>
  <span class="number">64</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'lstore_1'</span>
  <span class="number">65</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'lstore_2'</span>
  <span class="number">66</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'lstore_3'</span>
  <span class="number">67</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'fstore_0'</span>
  <span class="number">68</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'fstore_1'</span>
  <span class="number">69</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'fstore_2'</span>
  <span class="number">70</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'fstore_3'</span>
  <span class="number">71</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'dstore_0'</span>
  <span class="number">72</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'dstore_1'</span>
  <span class="number">73</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'dstore_2'</span>
  <span class="number">74</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'dstore_3'</span>
  <span class="number">75</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'astore_0'</span>
  <span class="number">76</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'astore_1'</span>
  <span class="number">77</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'astore_2'</span>
  <span class="number">78</span>: <span class="keyword">new</span> root.StoreOpcode <span class="string">'astore_3'</span>
  <span class="number">79</span>: <span class="keyword">new</span> root.ArrayStoreOpcode <span class="string">'iastore'</span>
  <span class="number">80</span>: <span class="keyword">new</span> root.ArrayStoreOpcode <span class="string">'lastore'</span>
  <span class="number">81</span>: <span class="keyword">new</span> root.ArrayStoreOpcode <span class="string">'fastore'</span>
  <span class="number">82</span>: <span class="keyword">new</span> root.ArrayStoreOpcode <span class="string">'dastore'</span>
  <span class="number">83</span>: <span class="keyword">new</span> root.ArrayStoreOpcode <span class="string">'aastore'</span>
  <span class="number">84</span>: <span class="keyword">new</span> root.ArrayStoreOpcode <span class="string">'bastore'</span>
  <span class="number">85</span>: <span class="keyword">new</span> root.ArrayStoreOpcode <span class="string">'castore'</span>
  <span class="number">86</span>: <span class="keyword">new</span> root.ArrayStoreOpcode <span class="string">'sastore'</span>
  <span class="number">87</span>: <span class="keyword">new</span> root.Opcode <span class="string">'pop'</span>, { execute: (rs) -&gt; rs.pop() }
  <span class="number">88</span>: <span class="keyword">new</span> root.Opcode <span class="string">'pop2'</span>, { execute: (rs) -&gt; rs.pop2() }
  <span class="number">89</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dup'</span>, { execute: (rs) -&gt; v=rs.pop(); rs.push2(v,v) }
  <span class="number">90</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dup_x1'</span>, { execute: (rs) -&gt; v1=rs.pop(); v2=rs.pop(); rs.push_array([v1,v2,v1]) }
  <span class="number">91</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dup_x2'</span>, {execute: (rs) -&gt; [v1,v2,v3]=[rs.pop(),rs.pop(),rs.pop()];rs.push_array([v1,v3,v2,v1])}
  <span class="number">92</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dup2'</span>, {execute: (rs) -&gt; v1=rs.pop(); v2=rs.pop(); rs.push_array([v2,v1,v2,v1])}
  <span class="number">93</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dup2_x1'</span>, {execute: (rs) -&gt; [v1,v2,v3]=[rs.pop(),rs.pop(),rs.pop()];rs.push_array([v2,v1,v3,v2,v1])}
  <span class="number">94</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dup2_x2'</span>, {execute: (rs) -&gt; [v1,v2,v3,v4]=[rs.pop(),rs.pop(),rs.pop(),rs.pop()];rs.push_array([v2,v1,v4,v3,v2,v1])}
  <span class="number">95</span>: <span class="keyword">new</span> root.Opcode <span class="string">'swap'</span>, {execute: (rs) -&gt; v2=rs.pop(); v1=rs.pop(); rs.push2(v2,v1)}
  <span class="number">96</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iadd'</span>, { execute: (rs) -&gt; rs.push (rs.pop()+rs.pop())|<span class="number">0</span> }
  <span class="number">97</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ladd'</span>, { execute: (rs) -&gt; rs.push2(rs.pop2().add(rs.pop2()), <span class="literal">null</span>) }
  <span class="number">98</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fadd'</span>, { execute: (rs) -&gt; rs.push util.wrap_float(rs.pop()+rs.pop()) }
  <span class="number">99</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dadd'</span>, { execute: (rs) -&gt; rs.push2(rs.pop2()+rs.pop2(), <span class="literal">null</span>) }
  <span class="number">100</span>: <span class="keyword">new</span> root.Opcode <span class="string">'isub'</span>, { execute: (rs) -&gt; rs.push (-rs.pop()+rs.pop())|<span class="number">0</span> }
  <span class="number">101</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lsub'</span>, { execute: (rs) -&gt; rs.push2(rs.pop2().negate().add(rs.pop2()), <span class="literal">null</span>) }
  <span class="number">102</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fsub'</span>, { execute: (rs) -&gt; rs.push util.wrap_float(-rs.pop()+rs.pop()) }
  <span class="number">103</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dsub'</span>, { execute: (rs) -&gt; rs.push2(-rs.pop2()+rs.pop2(), <span class="literal">null</span>) }
  <span class="number">104</span>: <span class="keyword">new</span> root.Opcode <span class="string">'imul'</span>, { execute: (rs) -&gt; rs.push gLong.fromInt(rs.pop()).multiply(gLong.fromInt rs.pop()).toInt() }
  <span class="number">105</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lmul'</span>, { execute: (rs) -&gt; rs.push2(rs.pop2().multiply(rs.pop2()), <span class="literal">null</span>) }
  <span class="number">106</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fmul'</span>, { execute: (rs) -&gt; rs.push util.wrap_float(rs.pop()*rs.pop()) }
  <span class="number">107</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dmul'</span>, { execute: (rs) -&gt; rs.push2(rs.pop2()*rs.pop2(), <span class="literal">null</span>) }
  <span class="number">108</span>: <span class="keyword">new</span> root.Opcode <span class="string">'idiv'</span>, { execute: (rs) -&gt; v=rs.pop();rs.push(util.int_div rs, rs.pop(), v) }
  <span class="number">109</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ldiv'</span>, { execute: (rs) -&gt; v=rs.pop2();rs.push2(util.long_div(rs, rs.pop2(), v), <span class="literal">null</span>) }
  <span class="number">110</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fdiv'</span>, { execute: (rs) -&gt; a=rs.pop();rs.push util.wrap_float(rs.pop()/a) }
  <span class="number">111</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ddiv'</span>, { execute: (rs) -&gt; v=rs.pop2();rs.push2(rs.pop2()/v, <span class="literal">null</span>) }
  <span class="number">112</span>: <span class="keyword">new</span> root.Opcode <span class="string">'irem'</span>, { execute: (rs) -&gt; v2=rs.pop();  rs.push util.int_mod(rs,rs.pop(),v2) }
  <span class="number">113</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lrem'</span>, { execute: (rs) -&gt; v2=rs.pop2(); rs.push2 util.long_mod(rs,rs.pop2(),v2), <span class="literal">null</span> }
  <span class="number">114</span>: <span class="keyword">new</span> root.Opcode <span class="string">'frem'</span>, { execute: (rs) -&gt; b=rs.pop(); rs.push rs.pop()%b }
  <span class="number">115</span>: <span class="keyword">new</span> root.Opcode <span class="string">'drem'</span>, { execute: (rs) -&gt; v2=rs.pop2(); rs.push2 rs.pop2()%v2, <span class="literal">null</span> }
  <span class="number">116</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ineg'</span>, { execute: (rs) -&gt; rs.push -rs.pop()|<span class="number">0</span> }
  <span class="number">117</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lneg'</span>, { execute: (rs) -&gt; rs.push2 rs.pop2().negate(), <span class="literal">null</span> }
  <span class="number">118</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fneg'</span>, { execute: (rs) -&gt; rs.push -rs.pop() }
  <span class="number">119</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dneg'</span>, { execute: (rs) -&gt; rs.push2 -rs.pop2(), <span class="literal">null</span> }
  <span class="number">120</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ishl'</span>, { execute: (rs) -&gt; s=rs.pop(); rs.push(rs.pop()&lt;&lt;s) }
  <span class="number">121</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lshl'</span>, { execute: (rs) -&gt; s=rs.pop(); rs.push2(rs.pop2().shiftLeft(gLong.fromInt(s)),<span class="literal">null</span>) }
  <span class="number">122</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ishr'</span>, { execute: (rs) -&gt; s=rs.pop(); rs.push(rs.pop()&gt;&gt;s) }
  <span class="number">123</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lshr'</span>, { execute: (rs) -&gt; s=rs.pop(); rs.push2(rs.pop2().shiftRight(gLong.fromInt(s)), <span class="literal">null</span>) }
  <span class="number">124</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iushr'</span>, { execute: (rs) -&gt; s=rs.pop(); rs.push(rs.pop()&gt;&gt;&gt;s) }
  <span class="number">125</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lushr'</span>, { execute: (rs) -&gt; s=rs.pop(); rs.push2(rs.pop2().shiftRightUnsigned(gLong.fromInt(s)), <span class="literal">null</span>)}
  <span class="number">126</span>: <span class="keyword">new</span> root.Opcode <span class="string">'iand'</span>, { execute: (rs) -&gt; rs.push(rs.pop()&amp;rs.pop()) }
  <span class="number">127</span>: <span class="keyword">new</span> root.Opcode <span class="string">'land'</span>, { execute: (rs) -&gt; rs.push2(rs.pop2().<span class="keyword">and</span>(rs.pop2()), <span class="literal">null</span>) }
  <span class="number">128</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ior'</span>,  { execute: (rs) -&gt; rs.push(rs.pop()|rs.pop()) }
  <span class="number">129</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lor'</span>,  { execute: (rs) -&gt; rs.push2(rs.pop2().<span class="keyword">or</span>(rs.pop2()), <span class="literal">null</span>) }
  <span class="number">130</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ixor'</span>, { execute: (rs) -&gt; rs.push(rs.pop()^rs.pop()) }
  <span class="number">131</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lxor'</span>, { execute: (rs) -&gt; rs.push2(rs.pop2().xor(rs.pop2()), <span class="literal">null</span>) }
  <span class="number">132</span>: <span class="keyword">new</span> root.IIncOpcode <span class="string">'iinc'</span>
  <span class="number">133</span>: <span class="keyword">new</span> root.Opcode <span class="string">'i2l'</span>, { execute: (rs) -&gt; rs.push2 gLong.fromInt(rs.pop()), <span class="literal">null</span> }
  <span class="number">134</span>: <span class="keyword">new</span> root.Opcode <span class="string">'i2f'</span>, { execute: (rs) -&gt; }
  <span class="number">135</span>: <span class="keyword">new</span> root.Opcode <span class="string">'i2d'</span>, { execute: (rs) -&gt; rs.push <span class="literal">null</span> }
  <span class="number">136</span>: <span class="keyword">new</span> root.Opcode <span class="string">'l2i'</span>, { execute: (rs) -&gt; rs.push rs.pop2().toInt() }
  <span class="number">137</span>: <span class="keyword">new</span> root.Opcode <span class="string">'l2f'</span>, { execute: (rs) -&gt; rs.push rs.pop2().toNumber() }
  <span class="number">138</span>: <span class="keyword">new</span> root.Opcode <span class="string">'l2d'</span>, { execute: (rs) -&gt; rs.push2 rs.pop2().toNumber(), <span class="literal">null</span> }
  <span class="number">139</span>: <span class="keyword">new</span> root.Opcode <span class="string">'f2i'</span>, { execute: (rs) -&gt; rs.push util.float2int rs.pop() }
  <span class="number">140</span>: <span class="keyword">new</span> root.Opcode <span class="string">'f2l'</span>, { execute: (rs) -&gt; rs.push2 gLong.fromNumber(rs.pop()), <span class="literal">null</span> }
  <span class="number">141</span>: <span class="keyword">new</span> root.Opcode <span class="string">'f2d'</span>, { execute: (rs) -&gt; rs.push <span class="literal">null</span> }
  <span class="number">142</span>: <span class="keyword">new</span> root.Opcode <span class="string">'d2i'</span>, { execute: (rs) -&gt; rs.push util.float2int rs.pop2() }
  <span class="number">143</span>: <span class="keyword">new</span> root.Opcode <span class="string">'d2l'</span>, { execute: (rs) -&gt;
    d_val = rs.pop2()
    <span class="keyword">if</span> d_val <span class="keyword">is</span> Number.POSITIVE_INFINITY
      rs.push2 gLong.MAX_VALUE, <span class="literal">null</span>
    <span class="keyword">else</span> <span class="keyword">if</span> d_val <span class="keyword">is</span> Number.NEGATIVE_INFINITY
      rs.push2 gLong.MIN_VALUE, <span class="literal">null</span>
    <span class="keyword">else</span>
      rs.push2 gLong.fromNumber(d_val), <span class="literal">null</span> }
  <span class="number">144</span>: <span class="keyword">new</span> root.Opcode <span class="string">'d2f'</span>, { execute: (rs) -&gt; rs.push util.wrap_float rs.pop2() }
  <span class="number">145</span>: <span class="keyword">new</span> root.Opcode <span class="string">'i2b'</span>, { execute: (rs) -&gt; rs.push (rs.pop() &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">24</span> } <span class="comment"># set all high-order bits to 1</span>
  <span class="number">146</span>: <span class="keyword">new</span> root.Opcode <span class="string">'i2c'</span>, { execute: (rs) -&gt; rs.push rs.pop()&amp;<span class="number">0xFFFF</span> }  <span class="comment"># 16-bit unsigned integer</span>
  <span class="number">147</span>: <span class="keyword">new</span> root.Opcode <span class="string">'i2s'</span>, { execute: (rs) -&gt; rs.push (rs.pop() &lt;&lt; <span class="number">16</span>) &gt;&gt; <span class="number">16</span> }
  <span class="number">148</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lcmp'</span>, { execute: (rs) -&gt; v2=rs.pop2(); rs.push rs.pop2().compare(v2) }
  <span class="number">149</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fcmpl'</span>, { execute: (rs) -&gt; v2=rs.pop(); rs.push util.cmp(rs.pop(),v2) ? -<span class="number">1</span> }
  <span class="number">150</span>: <span class="keyword">new</span> root.Opcode <span class="string">'fcmpg'</span>, { execute: (rs) -&gt; v2=rs.pop(); rs.push util.cmp(rs.pop(),v2) ? <span class="number">1</span> }
  <span class="number">151</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dcmpl'</span>, { execute: (rs) -&gt; v2=rs.pop2(); rs.push util.cmp(rs.pop2(),v2) ? -<span class="number">1</span> }
  <span class="number">152</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dcmpg'</span>, { execute: (rs) -&gt; v2=rs.pop2(); rs.push util.cmp(rs.pop2(),v2) ? <span class="number">1</span> }
  <span class="number">153</span>: <span class="keyword">new</span> root.UnaryBranchOpcode <span class="string">'ifeq'</span>, { cmp: (v) -&gt; v == <span class="number">0</span> }
  <span class="number">154</span>: <span class="keyword">new</span> root.UnaryBranchOpcode <span class="string">'ifne'</span>, { cmp: (v) -&gt; v != <span class="number">0</span> }
  <span class="number">155</span>: <span class="keyword">new</span> root.UnaryBranchOpcode <span class="string">'iflt'</span>, { cmp: (v) -&gt; v &lt; <span class="number">0</span> }
  <span class="number">156</span>: <span class="keyword">new</span> root.UnaryBranchOpcode <span class="string">'ifge'</span>, { cmp: (v) -&gt; v &gt;= <span class="number">0</span> }
  <span class="number">157</span>: <span class="keyword">new</span> root.UnaryBranchOpcode <span class="string">'ifgt'</span>, { cmp: (v) -&gt; v &gt; <span class="number">0</span> }
  <span class="number">158</span>: <span class="keyword">new</span> root.UnaryBranchOpcode <span class="string">'ifle'</span>, { cmp: (v) -&gt; v &lt;= <span class="number">0</span> }
  <span class="number">159</span>: <span class="keyword">new</span> root.BinaryBranchOpcode <span class="string">'if_icmpeq'</span>, { cmp: (v1, v2) -&gt; v1 == v2 }
  <span class="number">160</span>: <span class="keyword">new</span> root.BinaryBranchOpcode <span class="string">'if_icmpne'</span>, { cmp: (v1, v2) -&gt; v1 != v2 }
  <span class="number">161</span>: <span class="keyword">new</span> root.BinaryBranchOpcode <span class="string">'if_icmplt'</span>, { cmp: (v1, v2) -&gt; v1 &lt; v2 }
  <span class="number">162</span>: <span class="keyword">new</span> root.BinaryBranchOpcode <span class="string">'if_icmpge'</span>, { cmp: (v1, v2) -&gt; v1 &gt;= v2 }
  <span class="number">163</span>: <span class="keyword">new</span> root.BinaryBranchOpcode <span class="string">'if_icmpgt'</span>, { cmp: (v1, v2) -&gt; v1 &gt; v2 }
  <span class="number">164</span>: <span class="keyword">new</span> root.BinaryBranchOpcode <span class="string">'if_icmple'</span>, { cmp: (v1, v2) -&gt; v1 &lt;= v2 }
  <span class="number">165</span>: <span class="keyword">new</span> root.BinaryBranchOpcode <span class="string">'if_acmpeq'</span>, { cmp: (v1, v2) -&gt; v1 == v2 }
  <span class="number">166</span>: <span class="keyword">new</span> root.BinaryBranchOpcode <span class="string">'if_acmpne'</span>, { cmp: (v1, v2) -&gt; v1 != v2 }
  <span class="number">167</span>: <span class="keyword">new</span> root.BranchOpcode <span class="string">'goto'</span>, { execute: (rs) -&gt; rs.inc_pc(<span class="property">@offset</span>); <span class="literal">false</span> }
  <span class="number">168</span>: <span class="keyword">new</span> root.BranchOpcode <span class="string">'jsr'</span>, { execute: jsr }
  <span class="number">169</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ret'</span>, { byte_count: <span class="number">1</span>, execute: (rs) -&gt; rs.goto_pc rs.cl <span class="property">@args</span>[<span class="number">0</span>]; <span class="literal">false</span> }
  <span class="number">170</span>: <span class="keyword">new</span> root.TableSwitchOpcode <span class="string">'tableswitch'</span>
  <span class="number">171</span>: <span class="keyword">new</span> root.LookupSwitchOpcode <span class="string">'lookupswitch'</span>
  <span class="number">172</span>: <span class="keyword">new</span> root.Opcode <span class="string">'ireturn'</span>, { execute: (rs) -&gt; cf = rs.meta_stack().pop(); rs.push cf.stack[<span class="number">0</span>]; <span class="keyword">throw</span> ReturnException }
  <span class="number">173</span>: <span class="keyword">new</span> root.Opcode <span class="string">'lreturn'</span>, { execute: (rs) -&gt; cf = rs.meta_stack().pop(); rs.push2 cf.stack[<span class="number">0</span>], <span class="literal">null</span>; <span class="keyword">throw</span> ReturnException }
  <span class="number">174</span>: <span class="keyword">new</span> root.Opcode <span class="string">'freturn'</span>, { execute: (rs) -&gt; cf = rs.meta_stack().pop(); rs.push cf.stack[<span class="number">0</span>]; <span class="keyword">throw</span> ReturnException }
  <span class="number">175</span>: <span class="keyword">new</span> root.Opcode <span class="string">'dreturn'</span>, { execute: (rs) -&gt; cf = rs.meta_stack().pop(); rs.push2 cf.stack[<span class="number">0</span>], <span class="literal">null</span>; <span class="keyword">throw</span> ReturnException }
  <span class="number">176</span>: <span class="keyword">new</span> root.Opcode <span class="string">'areturn'</span>, { execute: (rs) -&gt; cf = rs.meta_stack().pop(); rs.push cf.stack[<span class="number">0</span>]; <span class="keyword">throw</span> ReturnException }
  <span class="number">177</span>: <span class="keyword">new</span> root.Opcode <span class="string">'return'</span>, { execute: (rs) -&gt; rs.meta_stack().pop(); <span class="keyword">throw</span> ReturnException }
  <span class="number">178</span>: <span class="keyword">new</span> root.FieldOpcode <span class="string">'getstatic'</span>, {execute: (rs)-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Get the class referenced by the field_spec.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ref_cls = rs.get_class(<span class="property">@field_spec</span>.class, <span class="literal">true</span>)
    new_execute =
      <span class="keyword">if</span> <span class="property">@field_spec</span>.type <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'J'</span>,<span class="string">'D'</span>]
        (rs) -&gt; rs.push <span class="property">@cls</span>.static_get(rs, <span class="property">@field_spec</span>.name)
      <span class="keyword">else</span>
        (rs) -&gt; rs.push2 <span class="property">@cls</span>.static_get(rs, <span class="property">@field_spec</span>.name), <span class="literal">null</span>
    <span class="keyword">if</span> ref_cls?</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Get the <em>actual</em> class that owns this field.
This may not be initialized if it&#39;s an interface, so we need to check.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cls_type = ref_cls.field_lookup(rs, <span class="property">@field_spec</span>).cls.get_type()
      <span class="property">@cls</span> = rs.get_class cls_type, <span class="literal">true</span>
      <span class="keyword">if</span> <span class="property">@cls</span>?
        new_execute.call(@, rs)
        <span class="property">@execute</span> = new_execute
      <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Initialize cls_type and rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rs.async_op (resume_cb, except_cb) =&gt;
          rs.get_cl().initialize_class rs, cls_type,
            ((class_file)=&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Initialize @field_spec.class and rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().initialize_class rs, <span class="property">@field_spec</span>.class,
          ((class_file)=&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
    <span class="keyword">return</span>
  }
  <span class="number">179</span>: <span class="keyword">new</span> root.FieldOpcode <span class="string">'putstatic'</span>, {execute: (rs)-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Get the class referenced by the field_spec.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ref_cls = rs.get_class(<span class="property">@field_spec</span>.class, <span class="literal">true</span>)
    new_execute =
      <span class="keyword">if</span> <span class="property">@field_spec</span>.type <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'J'</span>, <span class="string">'D'</span>]
        (rs) -&gt; <span class="property">@cls</span>.static_put(rs, <span class="property">@field_spec</span>.name, rs.pop())
      <span class="keyword">else</span>
        (rs) -&gt; <span class="property">@cls</span>.static_put(rs, <span class="property">@field_spec</span>.name, rs.pop2())
    <span class="keyword">if</span> ref_cls?</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Get the <em>actual</em> class that owns this field.
This may not be initialized if it&#39;s an interface, so we need to check.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cls_type = ref_cls.field_lookup(rs, <span class="property">@field_spec</span>).cls.get_type()
      <span class="property">@cls</span> = rs.get_class cls_type, <span class="literal">true</span>
      <span class="keyword">if</span> <span class="property">@cls</span>?
        new_execute.call(@, rs)
        <span class="property">@execute</span> = new_execute
      <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Initialize cls_type and rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rs.async_op (resume_cb, except_cb) =&gt;
          rs.get_cl().initialize_class rs, cls_type,
            ((class_file)=&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Initialize @field_spec.class and rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().initialize_class rs, <span class="property">@field_spec</span>.class,
          ((class_file)=&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
    <span class="keyword">return</span>
  }
  <span class="number">180</span>: <span class="keyword">new</span> root.FieldOpcode <span class="string">'getfield'</span>, { execute: (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Check if the object is null; if we do not do this before get_class, then
we might try to get a class that we have not initialized!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    obj = rs.check_null(rs.peek())</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>cls is guaranteed to be in the inheritance hierarchy of obj, so it must be
initialized. However, it may not be loaded in the current class&#39;s
ClassLoader...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cls = rs.get_class <span class="property">@field_spec</span>.class, <span class="literal">true</span>
    <span class="keyword">if</span> cls?
      field = cls.field_lookup(rs, <span class="property">@field_spec</span>)
      name = field.cls.get_type() + <span class="property">@field_spec</span>.name
      new_execute =
        <span class="keyword">if</span> <span class="property">@field_spec</span>.type <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'J'</span>,<span class="string">'D'</span>]
          (rs) -&gt;
            val = rs.check_null(rs.pop()).get_field rs, name
            rs.push val
        <span class="keyword">else</span>
          (rs) -&gt;
            val = rs.check_null(rs.pop()).get_field rs, name
            rs.push2 val, <span class="literal">null</span>
      new_execute.call(@, rs)
      <span class="property">@execute</span> = new_execute
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Alright, tell this class&#39;s ClassLoader to load the class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().resolve_class rs, <span class="property">@field_spec</span>.class,
          (=&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
    <span class="keyword">return</span>
  }
  <span class="number">181</span>: <span class="keyword">new</span> root.FieldOpcode <span class="string">'putfield'</span>, { execute: (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Check if the object is null; if we do not do this before get_class, then
we might try to get a class that we have not initialized!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> <span class="property">@field_spec</span>.type <span class="keyword">in</span> [<span class="string">'J'</span>,<span class="string">'D'</span>]
      _obj = rs.check_null(rs.peek(<span class="number">2</span>))
    <span class="keyword">else</span>
      _obj = rs.check_null(rs.peek(<span class="number">1</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>cls is guaranteed to be in the inheritance hierarchy of obj, so it must be
initialized. However, it may not be loaded in the current class&#39;s
ClassLoader...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cls_obj = rs.get_class <span class="property">@field_spec</span>.class, <span class="literal">true</span>
    <span class="keyword">if</span> cls_obj?
      field = cls_obj.field_lookup(rs, <span class="property">@field_spec</span>)
      name = field.cls.get_type() + <span class="property">@field_spec</span>.name
      new_execute =
        <span class="keyword">if</span> <span class="property">@field_spec</span>.type <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'J'</span>,<span class="string">'D'</span>]
          (rs) -&gt;
            val = rs.pop()
            rs.check_null(rs.pop()).set_field rs, name, val
        <span class="keyword">else</span>
          (rs) -&gt;
            val =  rs.pop2()
            rs.check_null(rs.pop()).set_field rs, name, val
      new_execute.call(@, rs)
      <span class="property">@execute</span> = new_execute
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Alright, tell this class&#39;s ClassLoader to load the class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().resolve_class rs, <span class="property">@field_spec</span>.class,
          (=&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
    <span class="keyword">return</span>
  }
  <span class="number">182</span>: <span class="keyword">new</span> root.DynInvokeOpcode <span class="string">'invokevirtual'</span>
  <span class="number">183</span>: <span class="keyword">new</span> root.InvokeOpcode <span class="string">'invokespecial'</span>
  <span class="number">184</span>: <span class="keyword">new</span> root.InvokeOpcode <span class="string">'invokestatic'</span>
  <span class="number">185</span>: <span class="keyword">new</span> root.DynInvokeOpcode <span class="string">'invokeinterface'</span>
  <span class="number">187</span>: <span class="keyword">new</span> root.ClassOpcode <span class="string">'new'</span>, { execute: (rs) -&gt;
    <span class="property">@cls</span> = rs.get_class <span class="property">@class</span>, <span class="literal">true</span>
    <span class="keyword">if</span> <span class="property">@cls</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Check if this is a ClassLoader or not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> <span class="property">@cls</span>.is_castable rs.get_bs_cl().get_resolved_class(<span class="string">'Ljava/lang/ClassLoader;'</span>)
        rs.push <span class="keyword">new</span> JavaClassLoaderObject(rs, <span class="property">@cls</span>)
        <span class="property">@execute</span> = (rs) -&gt; rs.push <span class="keyword">new</span> JavaClassLoaderObject(rs, <span class="property">@cls</span>)
      <span class="keyword">else</span>
        rs.push <span class="keyword">new</span> JavaObject(rs, <span class="property">@cls</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Self-modify; cache the class file lookup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="property">@execute</span> = (rs) -&gt; rs.push <span class="keyword">new</span> JavaObject(rs, <span class="property">@cls</span>)
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Initialize @type, create a JavaObject for it, and push it onto the stack.
Do not rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        <span class="function"><span class="title">success_fn</span></span> = (class_file) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Check if this is a ClassLoader or not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> class_file.is_castable rs.get_bs_cl().get_resolved_class(<span class="string">'Ljava/lang/ClassLoader;'</span>)
            obj = <span class="keyword">new</span> JavaClassLoaderObject(rs, class_file)
          <span class="keyword">else</span>
            obj = <span class="keyword">new</span> JavaObject(rs, class_file)
          resume_cb(obj, <span class="literal">undefined</span>, <span class="literal">true</span>)
        rs.get_cl().initialize_class rs, <span class="property">@class</span>, success_fn, except_cb
  }
  <span class="number">188</span>: <span class="keyword">new</span> root.NewArrayOpcode <span class="string">'newarray'</span>, { execute: (rs) -&gt; rs.push rs.heap_newarray <span class="property">@element_type</span>, rs.pop() }
  <span class="number">189</span>: <span class="keyword">new</span> root.ClassOpcode <span class="string">'anewarray'</span>, { execute: (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Make sure the component class is loaded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cls = rs.get_cl().get_resolved_class <span class="property">@class</span>, <span class="literal">true</span>
    <span class="keyword">if</span> cls?
      <span class="function"><span class="title">new_execute</span></span> = (rs) -&gt;
        rs.push rs.heap_newarray <span class="property">@class</span>, rs.pop()
      new_execute.call(@, rs)
      <span class="property">@execute</span> = new_execute
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Load @class and rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().resolve_class rs, <span class="property">@class</span>,
          ((class_file)=&gt;resume_cb(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>)), except_cb
    <span class="keyword">return</span>
  }
  <span class="number">190</span>: <span class="keyword">new</span> root.Opcode <span class="string">'arraylength'</span>, { execute: (rs) -&gt; rs.push rs.check_null(rs.pop()).array.length }
  <span class="number">191</span>: <span class="keyword">new</span> root.Opcode <span class="string">'athrow'</span>, { execute: (rs) -&gt; <span class="keyword">throw</span> <span class="keyword">new</span> JavaException rs.pop() }
  <span class="number">192</span>: <span class="keyword">new</span> root.ClassOpcode <span class="string">'checkcast'</span>, { execute: (rs) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Ensure the class is loaded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@cls</span> = rs.get_cl().get_resolved_class <span class="property">@class</span>, <span class="literal">true</span>
    <span class="keyword">if</span> <span class="property">@cls</span>?
      <span class="function"><span class="title">new_execute</span></span> = (rs) -&gt;
        o = rs.peek()
        <span class="keyword">if</span> o? <span class="keyword">and</span> <span class="keyword">not</span> o.cls.is_castable <span class="property">@cls</span>
          target_class = <span class="property">@cls</span>.toExternalString() <span class="comment"># class we wish to cast to</span>
          candidate_class = o.cls.toExternalString()
          rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/ClassCastException;'</span>),
            <span class="string">"<span class="subst">#{candidate_class}</span> cannot be cast to <span class="subst">#{target_class}</span>"</span>

      new_execute.call @, rs
      <span class="property">@execute</span> = new_execute
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Fetch @class and rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().resolve_class rs, <span class="property">@class</span>, (()-&gt;
          resume_cb <span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>
        ), except_cb
  }
  <span class="number">193</span>: <span class="keyword">new</span> root.ClassOpcode <span class="string">'instanceof'</span>, { execute: (rs) -&gt;
    <span class="property">@cls</span> = rs.get_cl().get_resolved_class <span class="property">@class</span>, <span class="literal">true</span>
    <span class="keyword">if</span> <span class="property">@cls</span>?
      <span class="function"><span class="title">new_execute</span></span> = (rs) -&gt;
        o=rs.pop()
        rs.push <span class="keyword">if</span> o? <span class="keyword">then</span> o.cls.is_castable(<span class="property">@cls</span>)+<span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>
      new_execute.call @, rs
      <span class="property">@execute</span> = new_execute
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Fetch @class and rerun opcode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op (resume_cb, except_cb) =&gt;
        rs.get_cl().resolve_class rs, <span class="property">@class</span>, (()-&gt;
          resume_cb <span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">true</span>, <span class="literal">false</span>
        ), except_cb
  }
  <span class="number">194</span>: <span class="keyword">new</span> root.Opcode <span class="string">'monitorenter'</span>, { execute: (rs)-&gt;
    monitor = rs.pop()
    <span class="keyword">if</span> (locked_thread = rs.lock_refs[monitor])?
      <span class="keyword">if</span> locked_thread <span class="keyword">is</span> rs.curr_thread
        rs.lock_counts[monitor]++  <span class="comment"># increment lock counter, to only unlock at zero</span>
      <span class="keyword">else</span>
        rs.inc_pc(<span class="number">1</span>)
        rs.meta_stack().push {}  <span class="comment"># dummy, to be popped by rs.yield</span>
        rs.wait monitor
    <span class="keyword">else</span>  <span class="comment"># this lock not held by any thread</span>
      rs.lock_refs[monitor] = rs.curr_thread
      rs.lock_counts[monitor] = <span class="number">1</span>
  }
  <span class="number">195</span>: <span class="keyword">new</span> root.Opcode <span class="string">'monitorexit'</span>,  { execute: (rs)-&gt;
    monitor = rs.pop()
    <span class="keyword">return</span> <span class="keyword">unless</span> (locked_thread = rs.lock_refs[monitor])?
    <span class="keyword">if</span> locked_thread <span class="keyword">is</span> rs.curr_thread
      rs.lock_counts[monitor]--
      <span class="keyword">if</span> rs.lock_counts[monitor] == <span class="number">0</span>
        <span class="keyword">delete</span> rs.lock_refs[monitor]
    <span class="keyword">else</span>
      rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/IllegalMonitorStateException;'</span>),
        <span class="string">"Tried to monitorexit on lock not held by current thread"</span>
  }
  <span class="number">197</span>: <span class="keyword">new</span> root.MultiArrayOpcode <span class="string">'multianewarray'</span>
  <span class="number">198</span>: <span class="keyword">new</span> root.UnaryBranchOpcode <span class="string">'ifnull'</span>, { cmp: (v) -&gt; <span class="keyword">not</span> v? }
  <span class="number">199</span>: <span class="keyword">new</span> root.UnaryBranchOpcode <span class="string">'ifnonnull'</span>, { cmp: (v) -&gt; v? }
  <span class="number">200</span>: <span class="keyword">new</span> root.BranchOpcode <span class="string">'goto_w'</span>, { byte_count: <span class="number">4</span>, execute: (rs) -&gt; rs.inc_pc(<span class="property">@offset</span>); <span class="literal">false</span> }
  <span class="number">201</span>: <span class="keyword">new</span> root.BranchOpcode <span class="string">'jsr_w'</span>, { byte_count: <span class="number">4</span>, execute: jsr }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
