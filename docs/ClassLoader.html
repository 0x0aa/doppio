<!DOCTYPE html>

<html>
<head>
  <title>ClassLoader.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ClassLoader.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
{ReferenceClassData,PrimitiveClassData,ArrayClassData} = require <span class="string">'./ClassData'</span>
util = require <span class="string">'./util'</span>
{trace} = require <span class="string">'./logging'</span>
{StackFrame} = require <span class="string">'./runtime'</span>
{JavaException} = require <span class="string">'./exceptions'</span>
{JavaObject} = require <span class="string">'./java_object'</span>

<span class="string">"use strict"</span>

root = exports ? <span class="keyword">this</span>.ClassLoader = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Base ClassLoader class. Handles interacting with the raw data structure used
to store the classes.
Requires a reference to the bootstrap classloader for primitive class
references.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span></span>
  constructor: (<span class="property">@bootstrap</span>) -&gt; <span class="property">@loaded_classes</span> = Object.create <span class="literal">null</span>

  get_loaded_class_list: -&gt; <span class="keyword">return</span> Object.keys <span class="property">@loaded_classes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Remove a class. Should only be used in the event of a class loading failure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _rem_class: (type_str) -&gt;
    <span class="keyword">delete</span> <span class="property">@loaded_classes</span>[type_str]
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Adds a class to this ClassLoader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _add_class: (type_str, cdata) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>XXX: JVM appears to allow define_class to be called twice on same class.
Does it actually replace the old class???
UNSAFE? || throw new Error &quot;ClassLoader tried to overwrite class #{type_str} with a new version.&quot; if @loaded_classes[type_str]?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@loaded_classes</span>[type_str] = cdata
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Retrieves a class in this ClassLoader. Returns null if it does not exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _get_class: (type_str) -&gt;
    cdata = <span class="property">@loaded_classes</span>[type_str]
    <span class="keyword">if</span> cdata?.reset_bit == <span class="number">1</span> <span class="keyword">then</span> cdata.reset()
    <span class="keyword">return</span> <span class="keyword">if</span> cdata? <span class="keyword">then</span> cdata <span class="keyword">else</span> <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Defines a new array class with the specified component type.
Returns null if the component type is not loaded.
Returns the ClassData object for this class (array classes do not have
JavaClassObjects).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _try_define_array_class: (type_str) -&gt;
    component_type = util.get_component_type type_str
    component_cdata = <span class="property">@get_resolved_class</span>(component_type, <span class="literal">true</span>)
    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">unless</span> component_cdata?
    <span class="keyword">return</span> <span class="property">@_define_array_class</span> type_str, component_cdata</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Defines a new array class with the specified component ClassData.
If the component ClassData object comes from another ClassLoader, invoke
this method on that ClassLoader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _define_array_class: (type_str, component_cdata) -&gt;
    <span class="keyword">if</span> component_cdata.get_class_loader() != @
      <span class="keyword">return</span> component_cdata.get_class_loader()._define_array_class(type_str, component_cdata)
    <span class="keyword">else</span>
      cdata = <span class="keyword">new</span> ArrayClassData component_cdata.get_type(), @
      <span class="property">@_add_class</span> type_str, cdata
      cdata.set_resolved <span class="property">@bootstrap</span>.get_resolved_class(<span class="string">'Ljava/lang/Object;'</span>), component_cdata
      <span class="keyword">return</span> cdata</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Called by define_class to fetch all interfaces and superclasses in parallel.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _parallel_class_resolve: (rs, types, success_fn, failure_fn, explicit=<span class="literal">false</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Number of callbacks waiting to be called.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pending_requests = types.length</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Set to a callback that throws an exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    failure = <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Array of successfully resolved classes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    resolved = []</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Called each time a requests finishes, whether in error or in success.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    request_finished = () -&gt;
      pending_requests--</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>pending_requests is 0? Then I am the last callback. Call success_fn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> pending_requests <span class="keyword">is</span> <span class="number">0</span>
        <span class="keyword">unless</span> failure?
          success_fn resolved
        <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Throw the exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          failure_fn failure</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Fetches the class data associated with &#39;type&#39; and adds it to the classloader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">fetch_data</span></span> = (type) =&gt;
      <span class="property">@resolve_class</span> rs, type, ((cdata) -&gt;
        resolved.push cdata
        request_finished()
      ), ((f_fn) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>resolve_class failure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        failure = f_fn
        request_finished()
      ), explicit</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Kick off all of the requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> type <span class="keyword">in</span> types
      fetch_data(type)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Resolves the classes represented by the type strings in types one by one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _regular_class_resolve: (rs, types, success_fn, failure_fn, explicit=<span class="literal">false</span>) -&gt;
    <span class="keyword">return</span> success_fn() <span class="keyword">unless</span> types.length &gt; <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Array of successfully resolved classes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    resolved = []

    <span class="function"><span class="title">fetch_class</span></span> = (type) =&gt;
      <span class="property">@resolve_class</span> rs, type, ((cdata) -&gt;
        resolved.push cdata
        <span class="keyword">if</span> types.length &gt; <span class="number">0</span>
          fetch_class types.shift()
        <span class="keyword">else</span>
          success_fn resolved
      ), failure_fn, explicit

    fetch_class types.shift()</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Only called for reference types.
Ensures that the class is resolved by ensuring that its super classes and
interfaces are also resolved (hence, it is asynchronous).
Calls the success_fn with the ClassData object for this class.
Calls the failure_fn with a function that throws the appropriate exception
in the event of a failure.
If &#39;parallel&#39; is &#39;true&#39;, then we call resolve_class multiple times in
parallel (used by the bootstrap classloader).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  define_class: (rs, type_str, data, success_fn, failure_fn, parallel=<span class="literal">false</span>, explicit=<span class="literal">false</span>) -&gt;
    trace <span class="string">"Defining class <span class="subst">#{type_str}</span>..."</span>
    cdata = <span class="keyword">new</span> ReferenceClassData(data, @)</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Add the class before we fetch its super class / interfaces.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@_add_class</span> type_str, cdata</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>What classes are we fetching?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    types = cdata.get_interface_types()
    types.push cdata.get_super_class_type()
    to_resolve = []
    resolved_already = []</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Prune any resolved classes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> type <span class="keyword">in</span> types
      <span class="keyword">continue</span> <span class="keyword">unless</span> type? <span class="comment"># super_class could've been null.</span>
      clsdata = <span class="property">@get_resolved_class</span> type, <span class="literal">true</span>
      <span class="keyword">if</span> clsdata?
        resolved_already.push clsdata
      <span class="keyword">else</span>
        to_resolve.push type

    <span class="function"><span class="title">process_resolved_classes</span></span> = (cdatas) -&gt;
      cdatas = resolved_already.concat cdatas
      super_cdata = <span class="literal">null</span>
      interface_cdatas = []
      super_type = cdata.get_super_class_type()
      <span class="keyword">for</span> a_cdata <span class="keyword">in</span> cdatas
        type = a_cdata.get_type()
        <span class="keyword">if</span> type <span class="keyword">is</span> super_type
          super_cdata = a_cdata
        <span class="keyword">else</span>
          interface_cdatas.push a_cdata
      cdata.set_resolved super_cdata, interface_cdatas
      success_fn cdata

    <span class="keyword">if</span> to_resolve.length &gt; <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>if parallel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> <span class="literal">false</span>
        <span class="property">@_parallel_class_resolve</span> rs, to_resolve, process_resolved_classes, failure_fn, explicit
      <span class="keyword">else</span>
        <span class="property">@_regular_class_resolve</span> rs, to_resolve, process_resolved_classes, failure_fn, explicit
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Everything is already resolved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      process_resolved_classes([])</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Synchronous method that checks if we have loaded a given method. If so,
it returns it. Otherwise, it throws an exception.
If null_handled is set, it simply returns null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get_loaded_class: (type_str, null_handled=<span class="literal">false</span>) -&gt;
    cdata = <span class="property">@_get_class</span> type_str
    <span class="keyword">return</span> cdata <span class="keyword">if</span> cdata?</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>If it&#39;s an array class, we might be able to get it synchronously...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> util.is_array_type type_str
      cdata = <span class="property">@_try_define_array_class</span> type_str
      <span class="keyword">return</span> cdata <span class="keyword">if</span> cdata?</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>If it&#39;s a primitive class, get it from the bootstrap classloader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="property">@bootstrap</span>.get_primitive_class type_str <span class="keyword">if</span> util.is_primitive_type type_str

    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">if</span> null_handled
    <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Error in get_loaded_class: Class <span class="subst">#{type_str}</span> is not loaded."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Synchronous method that checks if the given class is resolved
already, and returns it if so. If it is not, it throws an exception.
If null_handled is set, it simply returns null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get_resolved_class: (type_str, null_handled=<span class="literal">false</span>) -&gt;
    cdata = <span class="property">@get_loaded_class</span> type_str, null_handled
    <span class="keyword">return</span> cdata <span class="keyword">if</span> cdata?.is_resolved()
    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">if</span> null_handled
    <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Error in get_resolved_class: Class <span class="subst">#{type_str}</span> is not resolved."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Same as get_resolved_class, but for initialized classes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get_initialized_class: (type_str, null_handled=<span class="literal">false</span>) -&gt;
    cdata = <span class="property">@get_resolved_class</span> type_str, null_handled
    <span class="keyword">return</span> cdata <span class="keyword">if</span> cdata?.is_initialized()
    <span class="keyword">return</span> <span class="literal">null</span> <span class="keyword">if</span> null_handled
    <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Error in get_initialized_class: Class <span class="subst">#{type_str}</span> is not initialized."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Asynchronously initializes the given class, and passes the ClassData
representation to success_fn.
Passes a callback to failure_fn that throws an exception in the event of
an error.
This function makes the assumption that cdata is a ReferenceClassData</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _initialize_class: (rs, cdata, success_fn, failure_fn) -&gt;
    trace <span class="string">"Actually initializing class <span class="subst">#{cdata.get_type()}</span>..."</span>
    UNSAFE? || <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Tried to initialize a non-reference type: <span class="subst">#{cdata.get_type()}</span>"</span> <span class="keyword">unless</span> cdata <span class="keyword">instanceof</span> ReferenceClassData</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Iterate through the class hierarchy, pushing StackFrames that run</p>
<p><clinit> functions onto the stack. The last StackFrame pushed will be for
the <clinit> function of the topmost uninitialized class in the hierarchy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    first_clinit = <span class="literal">true</span>
    first_native_frame = StackFrame.native_frame(<span class="string">"$clinit"</span>, (()=&gt;
      <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"The top of the meta stack should be this native frame, but it is not: <span class="subst">#{rs.curr_frame().name}</span> at <span class="subst">#{rs.meta_stack().length()}</span>"</span> <span class="keyword">if</span> rs.curr_frame() != first_native_frame
      rs.meta_stack().pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>success_fn is responsible for getting us back into the runtime state
execution loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op(=&gt;success_fn(cdata))
    ), ((e)=&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>This ClassData is not initialized since we failed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.curr_frame().cdata.reset()
      <span class="keyword">if</span> e <span class="keyword">instanceof</span> JavaException</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Rethrow e if it&#39;s a java/lang/NoClassDefFoundError. Why? &#39;Cuz HotSpot
does it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> e.exception.cls.get_type() <span class="keyword">is</span> <span class="string">'Ljava/lang/NoClassDefFoundError;'</span>
          rs.meta_stack().pop()
          <span class="keyword">throw</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>We hijack the current native frame to transform the exception into a
ExceptionInInitializerError, then call failure_fn to throw it.
failure_fn is responsible for getting us back into the runtime state
loop.
We don&#39;t use the java_throw helper since this Exception object takes
a Throwable as an argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        nf = rs.curr_frame()
        nf.<span class="function"><span class="title">runner</span></span> = =&gt;
          rv = rs.pop()
          rs.meta_stack().pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Throw the exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">throw</span> (<span class="keyword">new</span> JavaException(rv))
        nf.<span class="function"><span class="title">error</span></span> = =&gt;
          rs.meta_stack().pop()
          failure_fn (-&gt; <span class="keyword">throw</span> e)

        cls = <span class="property">@bootstrap</span>.get_resolved_class <span class="string">'Ljava/lang/ExceptionInInitializerError;'</span>
        v = <span class="keyword">new</span> JavaObject rs, cls <span class="comment"># new</span>
        method_spec = sig: <span class="string">'&lt;init&gt;(Ljava/lang/Throwable;)V'</span>
        rs.push_array([v,v,e.exception]) <span class="comment"># dup, ldc</span>
        cls.method_lookup(rs, method_spec).setup_stack(rs) <span class="comment"># invokespecial</span>
      <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Not a Java exception?
No idea what this is; let&#39;s get outta dodge and rethrow it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rs.meta_stack().pop()
        <span class="keyword">throw</span> e
    ))
    first_native_frame.cdata = cdata

    class_file = cdata <span class="comment"># TODO: Rename vars.</span>
    <span class="keyword">while</span> class_file? <span class="keyword">and</span> <span class="keyword">not</span> class_file.is_initialized()
      trace <span class="string">"initializing class: <span class="subst">#{class_file.get_type()}</span>"</span>
      class_file.initialized = <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Run class initialization code. Superclasses get init&#39;ed first.  We
don&#39;t want to call this more than once per class, so don&#39;t do dynamic
lookup. See spec <a href="http://docs.oracle.com/javase/specs/jvms/se5.0/html/Concepts.doc.html#19075">2.17.4</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      clinit = class_file.get_method(<span class="string">'&lt;clinit&gt;()V'</span>)
      <span class="keyword">if</span> clinit?
        trace <span class="string">"\tFound &lt;clinit&gt;. Pushing stack frame."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Push a native frame; needed to handle exceptions and the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> first_clinit
          trace <span class="string">"\tFirst &lt;clinit&gt; in the loop."</span>
          first_clinit = <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>The first frame calls success_fn on success. Subsequent frames
are only used to handle exceptions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          rs.meta_stack().push(first_native_frame)
        <span class="keyword">else</span>
          next_nf = StackFrame.native_frame(<span class="string">"$clinit_secondary"</span>, (()=&gt;
            rs.meta_stack().pop()
          ), ((e)=&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>This ClassData is not initialized; reset its state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.curr_frame().cdata.reset()</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Pop myself off.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.meta_stack().pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Find the next Native Frame (prevents them from trying to run
their static initialization methods)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">while</span> <span class="keyword">not</span> rs.curr_frame().<span class="reserved">native</span>
              rs.meta_stack().pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Rethrow the Exception to pass it on to the next native frame.
The boolean value prevents failure_fn from discarding the current
stack frame.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rs.async_op((=&gt;failure_fn((()-&gt;<span class="keyword">throw</span> e), <span class="literal">true</span>)))
          ))
          next_nf.cdata = class_file
          rs.meta_stack().push next_nf
        clinit.setup_stack(rs)
      class_file = class_file.get_super_class()

    <span class="keyword">unless</span> first_clinit</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Push ourselves back into the execution loop to run the <clinit> methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.run_until_finished((-&gt;), <span class="literal">false</span>, rs.stashed_done_cb)
      <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Classes did not have any clinit functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    success_fn cdata
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Asynchronously loads, resolves, and initializes the given class, and passes its
ClassData representation to success_fn.
Passes a callback to failure_fn that throws an exception in the event
of an error.
Set &#39;explicit&#39; to &#39;true&#39; if this is explicitly invoked by the program and
not by an internal JVM mechanism.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initialize_class: (rs, type_str, success_fn, failure_fn, explicit=<span class="literal">false</span>) -&gt;
    trace <span class="string">"Initializing class <span class="subst">#{type_str}</span>..."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Let&#39;s see if we can do this synchronously.
Note that primitive types are guaranteed to be created synchronously
here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cdata = <span class="property">@get_initialized_class</span> type_str, <span class="literal">true</span>
    <span class="keyword">return</span> success_fn(cdata) <span class="keyword">if</span> cdata?</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>If it&#39;s an array type, the asynchronous part only involves its
component type. Short circuit here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> util.is_array_type type_str
      component_type = util.get_component_type type_str</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Component type doesn&#39;t need to be initialized; just resolved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@resolve_class</span> rs, component_type, ((cdata)=&gt;
        success_fn <span class="property">@_define_array_class</span>(type_str, cdata)
      ), failure_fn, explicit
      <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Only reference types will make it to this point. :-)</p>
<p>Is it at least resolved?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cdata = <span class="property">@get_resolved_class</span> type_str, <span class="literal">true</span>
    <span class="keyword">return</span> <span class="property">@_initialize_class</span>(rs, cdata, success_fn, failure_fn) <span class="keyword">if</span> cdata?</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>OK, OK. We&#39;ll have to asynchronously load it AND initialize it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@resolve_class</span> rs, type_str, ((cdata) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Check if it&#39;s initialized already. If this is a CustomClassLoader, it&#39;s
possible that the class has been retrieved from another ClassLoader,
and has already been initialized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> cdata.is_initialized(rs)
        success_fn cdata
      <span class="keyword">else</span>
        <span class="property">@_initialize_class</span> rs, cdata, success_fn, failure_fn
    ), failure_fn, explicit</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Loads the class indicated by the given type_str. Passes the ClassFile
object for the class to success_fn.
Set &#39;explicit&#39; to &#39;true&#39; if this is explicitly invoked by the program and
not by an internal JVM mechanism.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resolve_class: (rs, type_str, success_fn, failure_fn, explicit=<span class="literal">false</span>) -&gt;
    trace <span class="string">"Resolving class <span class="subst">#{type_str}</span>... [general]"</span>
    rv = <span class="property">@get_resolved_class</span> type_str, <span class="literal">true</span>
    <span class="keyword">return</span> success_fn(rv) <span class="keyword">if</span> rv?</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>If it&#39;s an array type, the asynchronous part only involves its
component type. Short circuit here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> util.is_array_type type_str
      component_type = util.get_component_type type_str
      <span class="property">@resolve_class</span> rs, component_type, ((cdata)=&gt;
        success_fn <span class="property">@_define_array_class</span>(type_str, cdata)
      ), failure_fn, explicit
      <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Unresolved reference class. Let&#39;s resolve it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@_resolve_class</span> rs, type_str, success_fn, failure_fn, explicit</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>The Bootstrap ClassLoader. This is the only ClassLoader that can create
primitive types.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">BootstrapClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>read_classfile is an asynchronous method that consumes a type string, a
success_fn, and a failure_fn, and passes the ReferenceClassData
corresponding to that type string to the success_fn.
Passes an error string to failure_fn.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@read_classfile</span>) -&gt; <span class="keyword">super</span>(@)

  serialize: (visited) -&gt;
    <span class="keyword">return</span> <span class="string">'&lt;*bootstrapLoader&gt;'</span> <span class="keyword">if</span> <span class="string">'bootstrapLoader'</span> <span class="keyword">of</span> visited
    visited[<span class="string">'bootstrapLoader'</span>] = <span class="literal">true</span>
    loaded = {}
    <span class="keyword">for</span> type,cls <span class="keyword">of</span> <span class="property">@loaded_classes</span>
      loaded[<span class="string">"<span class="subst">#{type}</span>(<span class="subst">#{cls.getLoadState()}</span>)"</span>] = cls.loader.serialize(visited)
    ref: <span class="string">'bootstrapLoader'</span>
    loaded: loaded</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Sets the reset bit on all of the classes in the CL to 1.
Causes the classes to be reset when they are first resolved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: -&gt;
    <span class="keyword">for</span> cname <span class="keyword">of</span> <span class="property">@loaded_classes</span>
      <span class="property">@loaded_classes</span>[cname].reset_bit = <span class="number">1</span>
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Returns the given primitive class. Creates it if needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get_primitive_class: (type_str) -&gt;
    cdata = <span class="property">@_get_class</span> type_str
    <span class="keyword">return</span> cdata <span class="keyword">if</span> cdata?

    cdata = <span class="keyword">new</span> PrimitiveClassData type_str, @
    <span class="property">@_add_class</span> type_str, cdata
    <span class="keyword">return</span> cdata</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Asynchronously retrieves the given class, and passes its ClassData
representation to success_fn.
Passes a callback to failure_fn that throws an exception in the event
of an error.
Called only:
<em> With a type_str referring to a Reference Class.
</em> If the class is not already loaded.
Set &#39;explicit&#39; to &#39;true&#39; if this is explicitly invoked by the program and
not by an internal JVM mechanism.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _resolve_class: (rs, type_str, success_fn, failure_fn, explicit=<span class="literal">false</span>) =&gt;
    trace <span class="string">"ASYNCHRONOUS: resolve_class <span class="subst">#{type_str}</span> [bootstrap]"</span>
    rv = <span class="property">@get_resolved_class</span> type_str, <span class="literal">true</span>
    <span class="keyword">return</span> success_fn(rv) <span class="keyword">if</span> rv?

    <span class="property">@read_classfile</span> type_str, ((data)=&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Fetch super class/interfaces in parallel.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@define_class</span> rs, type_str, data, success_fn, failure_fn, <span class="literal">true</span>, explicit
    ), (() =&gt;
      failure_fn(() =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>We create a new frame to create a NoClassDefFoundError and a
ClassNotFoundException.
TODO: Should probably have a better helper for these things
(asynchronous object creation)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        rs.meta_stack().push StackFrame.native_frame <span class="string">'$class_not_found'</span>, (=&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Rewrite myself -- I have another method to run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          rs.curr_frame().<span class="function"><span class="title">runner</span></span> = -&gt;
            rv = rs.pop()
            rs.meta_stack().pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Throw the exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">throw</span> (<span class="keyword">new</span> JavaException(rv))</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>If this was implicitly called by the JVM, we call NoClassDefFoundError.
If the program explicitly called this, then we throw the ClassNotFoundException.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">unless</span> explicit
            rv = rs.pop()
            cls = <span class="property">@bootstrap</span>.get_initialized_class <span class="string">'Ljava/lang/NoClassDefFoundError;'</span>
            v = <span class="keyword">new</span> JavaObject rs, cls
            method_spec = sig: <span class="string">'&lt;init&gt;(Ljava/lang/Throwable;)V'</span>
            rs.push_array([v,v,rv]) <span class="comment"># dup, ldc</span>
            cls.method_lookup(rs, method_spec).setup_stack(rs) <span class="comment"># invokespecial</span>
        ), (-&gt;
          rs.meta_stack().pop()
          failure_fn (-&gt; <span class="keyword">throw</span> e)
        )

        cls = <span class="property">@bootstrap</span>.get_initialized_class <span class="string">'Ljava/lang/ClassNotFoundException;'</span>
        v = <span class="keyword">new</span> JavaObject rs, cls <span class="comment"># new</span>
        method_spec = sig: <span class="string">'&lt;init&gt;(Ljava/lang/String;)V'</span>
        msg = rs.init_string(util.ext_classname type_str)
        rs.push_array([v,v,msg]) <span class="comment"># dup, ldc</span>
        cls.method_lookup(rs, method_spec).setup_stack(rs) <span class="comment"># invokespecial</span>
      )
    )
    <span class="keyword">return</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">CustomClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>@loader_obj is the JavaObject for the java/lang/ClassLoader instance that
represents this ClassLoader.
@bootstrap is an instance of the bootstrap class loader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (bootstrap, <span class="property">@loader_obj</span>) -&gt; <span class="keyword">super</span>(bootstrap)

  serialize: (visited) -&gt; <span class="property">@loader_obj</span>.serialize(visited)</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Asynchronously retrieves the given class, and passes its ClassData
representation to success_fn.
Passes a callback to failure_fn that throws an exception in the event
of an error.
Called only:
<em> With a type_str referring to a Reference Class.
</em> If the class is not already loaded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _resolve_class: (rs, type_str, success_fn, failure_fn, explicit=<span class="literal">false</span>) -&gt;
    trace <span class="string">"ASYNCHRONOUS: resolve_class <span class="subst">#{type_str}</span> [custom]"</span>
    rs.meta_stack().push StackFrame.native_frame(<span class="string">"$<span class="subst">#{@loader_obj.cls.get_type()}</span>"</span>, (()=&gt;
      jclo = rs.pop()
      rs.meta_stack().pop()

      cls = jclo.$cls</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>If loadClass delegated to another ClassLoader, it will not have called
defineClass on the result. If so, we will need to stash this class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@_add_class</span>(type_str, cls) <span class="keyword">unless</span> <span class="property">@get_resolved_class</span>(type_str, <span class="literal">true</span>)?
      rs.async_op(-&gt;success_fn(cls))
    ), ((e)=&gt;
      rs.meta_stack().pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>XXX: Convert the exception.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rs.async_op(-&gt;failure_fn(-&gt;<span class="keyword">throw</span> e))
    ))
    rs.push2 <span class="property">@loader_obj</span>, rs.init_string util.ext_classname type_str</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>We don&#39;t care about the return value of this function, as
define_class handles registering the ClassData with the class loader.
define_class also handles recalling resolve_class for any needed super
classes and interfaces.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@loader_obj</span>.cls.method_lookup(rs, {sig: <span class="string">'loadClass(Ljava/lang/String;)Ljava/lang/Class;'</span>}).setup_stack(rs)</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Push ourselves back into the execution loop to run the method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    rs.run_until_finished((-&gt;), <span class="literal">false</span>, rs.stashed_done_cb)
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
