<!DOCTYPE html>

<html>
<head>
  <title>disassembler.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>disassembler.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
root = exports ? <span class="keyword">this</span>.disassembler = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>pull in external modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_ = require <span class="string">'../vendor/_.js'</span>
util = require <span class="string">'./util'</span>

<span class="string">"use strict"</span>

<span class="function"><span class="title">pad_left</span></span> = (value, padding) -&gt;
  zeroes = <span class="keyword">new</span> Array(padding).join <span class="string">'0'</span>
  (zeroes + value).slice(-padding)

root.<span class="function"><span class="title">disassemble</span></span> = (class_file) -&gt;
  pool = class_file.constant_pool
  <span class="function"><span class="title">access_string</span></span> = (access_flags) -&gt;
    ordered_flags = [ <span class="string">'public'</span>, <span class="string">'protected'</span>, <span class="string">'private'</span>, <span class="string">'static'</span>, <span class="string">'final'</span> ]
    ordered_flags.push <span class="string">'abstract'</span> <span class="keyword">unless</span> access_flags.interface
    privacy = ((<span class="string">"<span class="subst">#{flag}</span> "</span> <span class="keyword">if</span> access_flags[flag]) <span class="keyword">for</span> flag <span class="keyword">in</span> ordered_flags).join <span class="string">''</span>

  source_file = class_file.get_attribute <span class="string">'SourceFile'</span>
  deprecated = class_file.get_attribute <span class="string">'Deprecated'</span>
  annotations = class_file.get_attribute <span class="string">'RuntimeVisibleAnnotations'</span>
  ifaces = class_file.get_interface_types()
  ifaces = (util.ext_classname(i) <span class="keyword">for</span> i <span class="keyword">in</span> ifaces).join <span class="string">','</span>
  rv = <span class="string">"Compiled from \"<span class="subst">#{source_file?.filename ? 'unknown'}</span>\"\n"</span>
  rv += access_string class_file.access_flags
  <span class="keyword">if</span> class_file.access_flags.interface
    rv += <span class="string">"interface <span class="subst">#{class_file.toExternalString()}</span><span class="subst">#{<span class="keyword">if</span> ifaces.length &gt; <span class="number">0</span> <span class="keyword">then</span> " extends #{ifaces}</span>"</span> <span class="keyword">else</span> <span class="string">''</span>}\n<span class="string">"
  else
    rv += "</span><span class="class"><span class="keyword">class</span> #{<span class="title">class_file</span>.<span class="title">toExternalString</span>()} <span class="keyword">extends</span> #{<span class="title">util</span>.<span class="title">ext_classname</span>(<span class="title">class_file</span>.<span class="title">get_super_class_type</span>())}"</span>
    rv += <span class="keyword">if</span> (ifaces <span class="keyword">and</span> <span class="keyword">not</span> class_file.access_flags.interface) <span class="keyword">then</span> <span class="string">" implements <span class="subst">#{ifaces}</span>\n"</span> <span class="keyword">else</span> <span class="string">'\n'</span>
  rv += <span class="string">"  SourceFile: \"<span class="subst">#{source_file.filename}</span>\"\n"</span> <span class="keyword">if</span> source_file
  rv += <span class="string">"  Deprecated: length = 0x\n"</span> <span class="keyword">if</span> deprecated
  <span class="keyword">if</span> annotations
    rv += <span class="string">"  RuntimeVisibleAnnotations: length = 0x<span class="subst">#{annotations.raw_bytes.length.toString(<span class="number">16</span>)}</span>\n"</span>
    rv += <span class="string">"   <span class="subst">#{(pad_left(b.toString(<span class="number">16</span>),<span class="number">2</span>) <span class="keyword">for</span> b <span class="keyword">in</span> annotations.raw_bytes).join ' '}</span>\n"</span>
  inner_classes = class_file.get_attributes <span class="string">'InnerClasses'</span>
  <span class="keyword">for</span> icls <span class="keyword">in</span> inner_classes
    rv += <span class="string">"  InnerClass:\n"</span>
    <span class="keyword">for</span> cls <span class="keyword">in</span> icls.classes
      flags = util.parse_flags cls.inner_access_flags
      access = ((f+<span class="string">' '</span> <span class="keyword">if</span> flags[f]) <span class="keyword">for</span> f <span class="keyword">in</span> [ <span class="string">'public'</span>, <span class="string">'protected'</span>, <span class="string">'private'</span>, <span class="string">'abstract'</span> ]).join <span class="string">''</span>
      cls_type = util.descriptor2typestr pool.get(cls.inner_info_index).deref()
      <span class="keyword">if</span> cls.outer_info_index &lt;= <span class="number">0</span>  <span class="comment"># it's an anonymous class</span>
        rv += <span class="string">"   <span class="subst">#{access}</span>#<span class="subst">#{cls.inner_info_index}</span>; //class <span class="subst">#{cls_type}</span>\n"</span>
      <span class="keyword">else</span>  <span class="comment"># it's a named inner class</span>
        rv += <span class="string">"   <span class="subst">#{access}</span>#<span class="subst">#{cls.inner_name_index}</span>= #<span class="subst">#{cls.inner_info_index}</span> of #<span class="subst">#{cls.outer_info_index}</span>;"</span>
        name = pool.get(cls.inner_name_index).value
        outer_cls_type = util.descriptor2typestr pool.get(cls.outer_info_index).deref()
        rv += <span class="string">" //<span class="subst">#{name}</span>=class <span class="subst">#{cls_type}</span> of class <span class="subst">#{outer_cls_type}</span>\n"</span>
  rv += <span class="string">"  minor version: <span class="subst">#{class_file.minor_version}</span>\n"</span>
  rv += <span class="string">"  major version: <span class="subst">#{class_file.major_version}</span>\n"</span>
  rv += <span class="string">"  Constant pool:\n"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>format floats and doubles in the javap way</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">format_decimal</span></span> = (val,type_char) -&gt;
    valStr = val.toString()
    <span class="keyword">if</span> type_char == <span class="string">'f'</span>
      <span class="keyword">if</span> val <span class="keyword">is</span> util.FLOAT_POS_INFINITY <span class="keyword">or</span> val <span class="keyword">is</span> Number.POSITIVE_INFINITY
        valStr = <span class="string">"Infinity"</span>
      <span class="keyword">else</span> <span class="keyword">if</span> val <span class="keyword">is</span> util.FLOAT_NEG_INFINITY <span class="keyword">or</span> val <span class="keyword">is</span> Number.NEGATIVE_INFINITY
        valStr = <span class="string">"-Infinity"</span>
      <span class="keyword">else</span> <span class="keyword">if</span> val <span class="keyword">is</span> NaN
        valStr = <span class="string">"NaN"</span>

    <span class="keyword">if</span> valStr.match(<span class="regexp">/-?(Infinity|NaN)/</span>)
      str = valStr
    <span class="keyword">else</span>
      m = valStr.match <span class="regexp">/(-?\d+)(\.\d+)?(?:e\+?(-?\d+))?/</span>
      str = m[<span class="number">1</span>] + (<span class="keyword">if</span> m[<span class="number">2</span>] <span class="keyword">then</span> m[<span class="number">2</span>] <span class="keyword">else</span> <span class="string">'.0'</span>)
      str = parseFloat(str).toFixed(<span class="number">7</span>) <span class="keyword">if</span> type_char <span class="keyword">is</span> <span class="string">'f'</span> <span class="keyword">and</span> m[<span class="number">2</span>]?.length &gt; <span class="number">8</span>
      str = str.replace(<span class="regexp">/0+$/,'').replace(/\.$/</span>,<span class="string">'.0'</span>)
      str += <span class="string">"E<span class="subst">#{m[<span class="number">3</span>]}</span>"</span> <span class="keyword">if</span> m[<span class="number">3</span>]?
    str + type_char</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>format the entries for displaying the constant pool. e.g. as &#39;#5.#6&#39; or
&#39;3.14159f&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">format</span></span> = (entry) -&gt;
    val = entry.value
    <span class="keyword">switch</span> entry.type
      <span class="keyword">when</span> <span class="string">'Method'</span>, <span class="string">'InterfaceMethod'</span>, <span class="string">'Field'</span>
        <span class="string">"#<span class="subst">#{val.class_ref.value}</span>.#<span class="subst">#{val.sig.value}</span>"</span>
      <span class="keyword">when</span> <span class="string">'NameAndType'</span> <span class="keyword">then</span> <span class="string">"#<span class="subst">#{val.meth_ref.value}</span>:#<span class="subst">#{val.type_ref.value}</span>"</span>
      <span class="keyword">when</span> <span class="string">'float'</span> <span class="keyword">then</span> format_decimal val, <span class="string">'f'</span>
      <span class="keyword">when</span> <span class="string">'double'</span> <span class="keyword">then</span> format_decimal val, <span class="string">'d'</span>
      <span class="keyword">when</span> <span class="string">'long'</span> <span class="keyword">then</span> val + <span class="string">"l"</span>
      <span class="keyword">else</span> util.escape_whitespace ((<span class="keyword">if</span> entry.deref? <span class="keyword">then</span> <span class="string">"#"</span> <span class="keyword">else</span> <span class="string">""</span>) + val)

  pool.each (idx, entry) -&gt;
    rv += <span class="string">"const #<span class="subst">#{idx}</span> = <span class="subst">#{entry.type}</span>\t<span class="subst">#{format entry}</span>;"</span>
    rv += <span class="string">"<span class="subst">#{util.format_extra_info entry}</span>\n"</span>
  rv += <span class="string">"\n"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>pretty-print our field types, e.g. as &#39;PackageName.ClassName[][]&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="function"><span class="title">pp_type</span></span> = (field_type) -&gt;
    <span class="keyword">if</span> util.is_array_type field_type <span class="keyword">then</span> pp_type(util.get_component_type field_type) + <span class="string">'[]'</span>
    <span class="keyword">else</span> util.ext_classname field_type

  <span class="function"><span class="title">print_excs</span></span> = (exc_attr) -&gt;
    excs = exc_attr.exceptions
    <span class="string">"   throws "</span> + (util.ext_classname(e) <span class="keyword">for</span> e <span class="keyword">in</span> excs).join <span class="string">', '</span>

  rv += <span class="string">"{\n"</span>

  <span class="keyword">for</span> f <span class="keyword">in</span> class_file.get_fields()
    rv += access_string(f.access_flags)
    rv += <span class="string">"<span class="subst">#{pp_type(f.type)}</span> <span class="subst">#{f.name}</span>;\n"</span>
    const_attr = f.get_attribute <span class="string">'ConstantValue'</span>
    <span class="keyword">if</span> const_attr?
      entry = pool.get(const_attr.ref)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>If it&#39;s a string, dereference the value. Otherwise, format the numeric value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      rv += <span class="string">"  Constant value: <span class="subst">#{entry.type}</span> <span class="subst">#{entry.deref?() <span class="keyword">or</span> format(entry)}</span>\n"</span>
    sig = f.get_attribute <span class="string">'Signature'</span>
    <span class="keyword">if</span> sig?
      rv += <span class="string">"  Signature: length = 0x<span class="subst">#{sig.raw_bytes.length.toString(<span class="number">16</span>)}</span>\n"</span>
      rv += <span class="string">"   <span class="subst">#{(pad_left(b.toString(<span class="number">16</span>).toUpperCase(),<span class="number">2</span>) <span class="keyword">for</span> b <span class="keyword">in</span> sig.raw_bytes).join ' '}</span>\n"</span>
    rv += <span class="string">"\n\n"</span>

  <span class="keyword">for</span> sig, m <span class="keyword">of</span> class_file.get_methods()
    rv += access_string m.access_flags
    rv += <span class="string">'synchronized '</span> <span class="keyword">if</span> m.access_flags.synchronized
    rv +=</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>initializers are special-cased</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> m.name <span class="keyword">is</span> <span class="string">'&lt;init&gt;'</span> <span class="keyword">then</span> class_file.toExternalString() <span class="comment"># instance init</span>
      <span class="keyword">else</span> <span class="keyword">if</span> m.name <span class="keyword">is</span> <span class="string">'&lt;clinit&gt;'</span> <span class="keyword">then</span> <span class="string">"{}"</span> <span class="comment"># class init</span>
      <span class="keyword">else</span>
        ret_type = <span class="keyword">if</span> m.return_type? <span class="keyword">then</span> pp_type m.return_type <span class="keyword">else</span> <span class="string">""</span>
        ret_type + <span class="string">" "</span> + m.name
    rv += <span class="string">"(<span class="subst">#{(pp_type(p) <span class="keyword">for</span> p <span class="keyword">in</span> m.param_types).join ', '}</span>)"</span> <span class="keyword">unless</span> m.name <span class="keyword">is</span> <span class="string">'&lt;clinit&gt;'</span>
    rv += print_excs exc_attr <span class="keyword">if</span> exc_attr = m.get_attribute <span class="string">'Exceptions'</span>
    rv += <span class="string">";\n"</span>
    <span class="keyword">unless</span> m.access_flags.<span class="reserved">native</span> <span class="keyword">or</span> m.access_flags.abstract
      rv += <span class="string">"  Code:\n"</span>
      code = m.code
      rv += <span class="string">"   Stack=<span class="subst">#{code.max_stack}</span>, Locals=<span class="subst">#{code.max_locals}</span>, Args_size=<span class="subst">#{m.num_args}</span>\n"</span>
      code.parse_code()
      code.each_opcode (idx, oc) -&gt;
        rv += <span class="string">"   <span class="subst">#{idx}</span>:\t<span class="subst">#{oc.name}</span>"</span>
        rv += oc.annotate(idx, pool)
        rv += <span class="string">"\n"</span>
      <span class="keyword">if</span> code.exception_handlers.length &gt; <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>For printing columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="function"><span class="title">fixed_width</span></span> = (num, width) -&gt;
          num_str = num.toString()
          (<span class="string">" "</span> <span class="keyword">for</span> [<span class="number">0.</span>..width-num_str.length]).join(<span class="string">''</span>) + num_str
        rv += <span class="string">"  Exception table:\n"</span>
        rv += <span class="string">"   from   to  target type\n"</span>
        <span class="keyword">for</span> eh <span class="keyword">in</span> code.exception_handlers
          rv += (fixed_width eh[item], <span class="number">6</span> <span class="keyword">for</span> item <span class="keyword">in</span> [<span class="string">'start_pc'</span>, <span class="string">'end_pc'</span>, <span class="string">'handler_pc'</span>]).join <span class="string">''</span>
          <span class="keyword">if</span> eh.catch_type <span class="keyword">is</span> <span class="string">'&lt;any&gt;'</span>
            rv += <span class="string">"   any\n"</span>
          <span class="keyword">else</span>
            rv += <span class="string">"   Class <span class="subst">#{eh.catch_type[<span class="number">1.</span>..-<span class="number">1</span>]}</span>\n"</span>
        rv += <span class="string">"\n"</span>
      <span class="keyword">for</span> attr <span class="keyword">in</span> code.attrs
        rv += attr.disassemblyOutput?() <span class="keyword">or</span> <span class="string">''</span>
      rv += <span class="string">"  Exceptions:\n<span class="subst">#{print_excs exc_attr}</span>\n"</span> <span class="keyword">if</span> exc_attr
    rv += <span class="string">"\n"</span>

  rv += <span class="string">"}\n"</span>

  <span class="keyword">return</span> rv</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
