<!DOCTYPE html>

<html>
<head>
  <title>methods.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>methods.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>pull in external modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_ = require <span class="string">'../vendor/_.js'</span>
util = require <span class="string">'./util'</span>
opcodes = require <span class="string">'./opcodes'</span>
attributes = require <span class="string">'./attributes'</span>
natives = require <span class="string">'./natives'</span>
runtime = require <span class="string">'./runtime'</span>
logging = require <span class="string">'./logging'</span>
jvm = require <span class="string">'./jvm'</span>
{vtrace,trace,debug_vars} = logging
{ReturnException} = require <span class="string">'./exceptions'</span>
{native_methods,trapped_methods} = natives
{JavaArray,JavaObject} = require <span class="string">'./java_object'</span>

<span class="string">"use strict"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>things assigned to root will be available outside this module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root = exports ? <span class="keyword">this</span>.methods = {}

<span class="class"><span class="keyword">class</span> <span class="title">AbstractMethodField</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Subclasses need to implement parse_descriptor(String)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@cls</span>) -&gt;

  parse: (bytes_array,constant_pool,<span class="property">@idx</span>) -&gt;
    <span class="property">@access_byte</span> = bytes_array.get_uint <span class="number">2</span>
    <span class="property">@access_flags</span> = util.parse_flags <span class="property">@access_byte</span>
    <span class="property">@name</span> = constant_pool.get(bytes_array.get_uint <span class="number">2</span>).value
    <span class="property">@raw_descriptor</span> = constant_pool.get(bytes_array.get_uint <span class="number">2</span>).value
    <span class="property">@parse_descriptor</span> <span class="property">@raw_descriptor</span>
    <span class="property">@attrs</span> = attributes.make_attributes(bytes_array,constant_pool)

  get_attribute: (name) -&gt;
    <span class="keyword">for</span> attr <span class="keyword">in</span> <span class="property">@attrs</span> <span class="keyword">then</span> <span class="keyword">if</span> attr.name <span class="keyword">is</span> name <span class="keyword">then</span> <span class="keyword">return</span> attr
    <span class="keyword">return</span> <span class="literal">null</span>

  get_attributes: (name) -&gt; attr <span class="keyword">for</span> attr <span class="keyword">in</span> <span class="property">@attrs</span> <span class="keyword">when</span> attr.name <span class="keyword">is</span> name

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">Field</span> <span class="keyword">extends</span> <span class="title">AbstractMethodField</span></span>
  parse_descriptor: (raw_descriptor) -&gt;
    <span class="property">@type</span> = raw_descriptor</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Must be called asynchronously.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reflector: (rs, success_fn, failure_fn) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>note: sig is the generic type parameter (if one exists), not the full
field type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sig = _.find(<span class="property">@attrs</span>, (a) -&gt; a.name == <span class="string">"Signature"</span>)?.sig

    <span class="function"><span class="title">create_obj</span></span> = (clazz_obj, type_obj) =&gt;
      <span class="keyword">new</span> JavaObject rs, rs.get_bs_class(<span class="string">'Ljava/lang/reflect/Field;'</span>), {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>XXX this leaves out &#39;annotations&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="string">'Ljava/lang/reflect/Field;clazz'</span>: clazz_obj
        <span class="string">'Ljava/lang/reflect/Field;name'</span>: rs.init_string <span class="property">@name</span>, <span class="literal">true</span>
        <span class="string">'Ljava/lang/reflect/Field;type'</span>: type_obj
        <span class="string">'Ljava/lang/reflect/Field;modifiers'</span>: <span class="property">@access_byte</span>
        <span class="string">'Ljava/lang/reflect/Field;slot'</span>: <span class="property">@idx</span>
        <span class="string">'Ljava/lang/reflect/Field;signature'</span>: <span class="keyword">if</span> sig? <span class="keyword">then</span> rs.init_string sig <span class="keyword">else</span> <span class="literal">null</span>
      }

    clazz_obj = <span class="property">@cls</span>.get_class_object(rs)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>type_obj may not be loaded, so we asynchronously load it here.
In the future, we can speed up reflection by having a synchronous_reflector
method that we can try first, and which may fail.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@cls</span>.loader.resolve_class rs, <span class="property">@type</span>, ((type_cls) =&gt;
      type_obj = type_cls.get_class_object(rs)
      rv = create_obj clazz_obj, type_obj
      success_fn rv
    ), failure_fn
    <span class="keyword">return</span>

<span class="class"><span class="keyword">class</span> <span class="title">root</span>.<span class="title">Method</span> <span class="keyword">extends</span> <span class="title">AbstractMethodField</span></span>
  parse_descriptor: (raw_descriptor) -&gt;
    <span class="property">@reset_caches</span> = <span class="literal">false</span> <span class="comment"># Switched to 'true' in web frontend between JVM invocations.</span>
    [__,param_str,return_str] = <span class="regexp">/\(([^)]*)\)(.*)/</span>.exec(raw_descriptor)
    param_carr = param_str.split <span class="string">''</span>
    <span class="property">@param_types</span> = (field <span class="keyword">while</span> (field = util.carr2descriptor param_carr))
    <span class="property">@param_bytes</span> = <span class="number">0</span>
    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="property">@param_types</span>
      <span class="property">@param_bytes</span> += <span class="keyword">if</span> p <span class="keyword">in</span> [<span class="string">'D'</span>,<span class="string">'J'</span>] <span class="keyword">then</span> <span class="number">2</span> <span class="keyword">else</span> <span class="number">1</span>
    <span class="property">@param_bytes</span>++ <span class="keyword">unless</span> <span class="property">@access_flags</span>.static
    <span class="property">@num_args</span> = <span class="property">@param_types</span>.length
    <span class="property">@num_args</span>++ <span class="keyword">unless</span> <span class="property">@access_flags</span>.static <span class="comment"># nonstatic methods get 'this'</span>
    <span class="property">@return_type</span> = return_str

  full_signature: -&gt; <span class="string">"<span class="subst">#{@cls.get_type()}</span>::<span class="subst">#{@name}</span><span class="subst">#{@raw_descriptor}</span>"</span>

  parse: (bytes_array, constant_pool, idx) -&gt;
    <span class="keyword">super</span> bytes_array, constant_pool, idx
    sig = <span class="property">@full_signature</span>()
    <span class="keyword">if</span> (c = trapped_methods[sig])?
      <span class="property">@code</span> = c
      <span class="property">@access_flags</span>.<span class="reserved">native</span> = <span class="literal">true</span>
    <span class="keyword">else</span> <span class="keyword">if</span> <span class="property">@access_flags</span>.<span class="reserved">native</span>
      <span class="keyword">if</span> (c = native_methods[sig])?
        <span class="property">@code</span> = c
      <span class="keyword">else</span>
        console.log(sig) <span class="keyword">if</span> jvm.show_NYI_natives <span class="keyword">and</span> sig.indexOf(<span class="string">'::registerNatives()V'</span>,<span class="number">1</span>) &lt; <span class="number">0</span> <span class="keyword">and</span> sig.indexOf(<span class="string">'::initIDs()V'</span>,<span class="number">1</span>) &lt; <span class="number">0</span>
        <span class="keyword">if</span> UNSAFE?
          <span class="property">@code</span> = <span class="literal">null</span> <span class="comment"># optimization: avoid copying around params if it is a no-op.</span>
        <span class="keyword">else</span>
          <span class="property">@code</span> = (rs) =&gt;
            <span class="keyword">unless</span> sig.indexOf(<span class="string">'::registerNatives()V'</span>,<span class="number">1</span>) &gt;= <span class="number">0</span> <span class="keyword">or</span> sig.indexOf(<span class="string">'::initIDs()V'</span>,<span class="number">1</span>) &gt;= <span class="number">0</span>
              rs.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/Error;'</span>), <span class="string">"native method NYI: <span class="subst">#{sig}</span>"</span>
    <span class="keyword">else</span>
      <span class="property">@has_bytecode</span> = <span class="literal">true</span>
      <span class="property">@code</span> = _.find(<span class="property">@attrs</span>, (a) -&gt; a.name == <span class="string">'Code'</span>)

  reflector: (rs, is_constructor=<span class="literal">false</span>, success_fn, failure_fn) -&gt;
    typestr = <span class="keyword">if</span> is_constructor <span class="keyword">then</span> <span class="string">'Ljava/lang/reflect/Constructor;'</span> <span class="keyword">else</span> <span class="string">'Ljava/lang/reflect/Method;'</span>
    exceptions = _.find(<span class="property">@attrs</span>, (a) -&gt; a.name == <span class="string">'Exceptions'</span>)?.exceptions ? []
    anns = _.find(<span class="property">@attrs</span>, (a) -&gt; a.name == <span class="string">'RuntimeVisibleAnnotations'</span>)?.raw_bytes
    adefs = _.find(<span class="property">@attrs</span>, (a) -&gt; a.name == <span class="string">'AnnotationDefault'</span>)?.raw_bytes
    sig =  _.find(<span class="property">@attrs</span>, (a) -&gt; a.name == <span class="string">'Signature'</span>)?.sig
    obj = {}

    clazz_obj = <span class="property">@cls</span>.get_class_object(rs)

    <span class="property">@cls</span>.loader.resolve_class(rs, <span class="property">@return_type</span>, ((rt_cls) =&gt;
      rt_obj = rt_cls.get_class_object(rs)
      j = -<span class="number">1</span>
      etype_objs = []
      i = -<span class="number">1</span>
      param_type_objs = []
      fetch_etype = () =&gt;
        j++
        <span class="keyword">if</span> j &lt; exceptions.length
          e_desc = exceptions[j]
          <span class="property">@cls</span>.loader.resolve_class(rs, e_desc,
            ((cls)=&gt;etype_objs[j]=cls.get_class_object(rs);fetch_etype()), failure_fn)
        <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>XXX: missing parameterAnnotations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          obj[typestr + <span class="string">'clazz'</span>] = clazz_obj
          obj[typestr + <span class="string">'name'</span>] = rs.init_string <span class="property">@name</span>, <span class="literal">true</span>
          obj[typestr + <span class="string">'parameterTypes'</span>] = <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Ljava/lang/Class;'</span>), param_type_objs
          obj[typestr + <span class="string">'returnType'</span>] = rt_obj
          obj[typestr + <span class="string">'exceptionTypes'</span>] = <span class="keyword">new</span> JavaArray rs, rs.get_bs_class(<span class="string">'[Ljava/lang/Class;'</span>), etype_objs
          obj[typestr + <span class="string">'modifiers'</span>] = <span class="property">@access_byte</span>
          obj[typestr + <span class="string">'slot'</span>] = <span class="property">@idx</span>
          obj[typestr + <span class="string">'signature'</span>] = <span class="keyword">if</span> sig? <span class="keyword">then</span> rs.init_string sig <span class="keyword">else</span> <span class="literal">null</span>
          obj[typestr + <span class="string">'annotations'</span>] = <span class="keyword">if</span> anns? <span class="keyword">then</span> <span class="keyword">new</span> JavaArray(rs, rs.get_bs_class(<span class="string">'[B'</span>), anns) <span class="keyword">else</span> <span class="literal">null</span>
          obj[typestr + <span class="string">'annotationDefault'</span>] = <span class="keyword">if</span> adefs? <span class="keyword">then</span> <span class="keyword">new</span> JavaArray(rs, rs.get_bs_class(<span class="string">'[B'</span>), adefs) <span class="keyword">else</span> <span class="literal">null</span>
          success_fn(<span class="keyword">new</span> JavaObject rs, rs.get_bs_class(typestr), obj)

      fetch_ptype = () =&gt;
        i++
        <span class="keyword">if</span> i &lt; <span class="property">@param_types</span>.length
          <span class="property">@cls</span>.loader.resolve_class(rs, <span class="property">@param_types</span>[i],
            ((cls)=&gt;param_type_objs[i]=cls.get_class_object(rs);fetch_ptype()), failure_fn)
        <span class="keyword">else</span>
          fetch_etype()

      fetch_ptype()
    ), failure_fn)

  take_params: (caller_stack) -&gt;
    start = caller_stack.length - <span class="property">@param_bytes</span>
    params = caller_stack.slice(start)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>this is faster than splice()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    caller_stack.length -= <span class="property">@param_bytes</span>
    params

  RELEASE? || padding = <span class="string">''</span> <span class="comment"># used in debug mode to align instruction traces</span>

  convert_params: (rs, params) -&gt;
    converted_params = [rs]
    param_idx = <span class="number">0</span>
    <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@access_flags</span>.static
      converted_params.push params[<span class="number">0</span>]
      param_idx = <span class="number">1</span>
    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="property">@param_types</span>
      converted_params.push params[param_idx]
      param_idx += <span class="keyword">if</span> (p <span class="keyword">in</span> [<span class="string">'J'</span>, <span class="string">'D'</span>]) <span class="keyword">then</span> <span class="number">2</span> <span class="keyword">else</span> <span class="number">1</span>
    converted_params

  run_manually: (func, rs, converted_params) -&gt;
    trace <span class="string">"entering native method <span class="subst">#{@full_signature()}</span>"</span>
    <span class="keyword">try</span>
      rv = func converted_params...
    <span class="keyword">catch</span> e
      <span class="keyword">return</span> <span class="keyword">if</span> e <span class="keyword">is</span> ReturnException
      <span class="keyword">throw</span> e
    rs.meta_stack().pop()
    ret_type = <span class="property">@return_type</span>
    <span class="keyword">unless</span> ret_type == <span class="string">'V'</span>
      <span class="keyword">if</span> ret_type == <span class="string">'Z'</span> <span class="keyword">then</span> rs.push rv + <span class="number">0</span> <span class="comment"># cast booleans to a Number</span>
      <span class="keyword">else</span> rs.push rv
      rs.push <span class="literal">null</span> <span class="keyword">if</span> ret_type <span class="keyword">in</span> [ <span class="string">'J'</span>, <span class="string">'D'</span> ]</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Reinitializes the method by removing all cached information from the method.
We amortize the cost by doing it lazily the first time that we call run_bytecode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initialize: -&gt; <span class="property">@reset_caches</span> = <span class="literal">true</span>

  run_bytecode: (rs) -&gt;
    trace <span class="string">"entering method <span class="subst">#{@full_signature()}</span>"</span>
    <span class="keyword">if</span> <span class="property">@reset_caches</span> <span class="keyword">and</span> <span class="property">@code</span>?.opcodes?
      <span class="keyword">for</span> instr <span class="keyword">in</span> <span class="property">@code</span>.opcodes
        instr?.reset_cache()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>main eval loop: execute each opcode, using the pc to iterate through</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    code = <span class="property">@code</span>.opcodes
    cf = rs.curr_frame()
    <span class="keyword">try</span>
      <span class="keyword">while</span> <span class="literal">true</span>
        op = code[cf.pc]
        <span class="keyword">unless</span> RELEASE? <span class="keyword">or</span> logging.log_level &lt; logging.STRACE
          pc = cf.pc
          <span class="keyword">throw</span> <span class="string">"<span class="subst">#{@name}</span>:<span class="subst">#{pc}</span> =&gt; (null)"</span> <span class="keyword">unless</span> op
          vtrace <span class="string">"<span class="subst">#{padding}</span>stack: [<span class="subst">#{debug_vars cf.stack}</span>], local: [<span class="subst">#{debug_vars cf.locals}</span>]"</span>
          annotation = op.annotate(pc, <span class="property">@cls</span>.constant_pool)
          vtrace <span class="string">"<span class="subst">#{padding}</span><span class="subst">#{@cls.get_type()}</span>::<span class="subst">#{@name}</span>:<span class="subst">#{pc}</span> =&gt; <span class="subst">#{op.name}</span>"</span> + annotation

        cf.pc += <span class="number">1</span> + op.byte_count <span class="keyword">if</span> (op.execute rs) <span class="keyword">isnt</span> <span class="literal">false</span>
    <span class="keyword">catch</span> e
      <span class="keyword">return</span> <span class="keyword">if</span> e <span class="keyword">is</span> ReturnException
      <span class="keyword">throw</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Must explicitly return here, to avoid Coffeescript accumulating an array of cf.pc values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span>

  setup_stack: (runtime_state) -&gt;
    ms = runtime_state.meta_stack()
    caller_stack = runtime_state.curr_frame().stack
    params = <span class="property">@take_params</span> caller_stack

    <span class="keyword">if</span> <span class="property">@access_flags</span>.<span class="reserved">native</span>
      <span class="keyword">if</span> <span class="property">@code</span>?
        ms.push(sf = <span class="keyword">new</span> runtime.StackFrame(<span class="keyword">this</span>,[],[]))
        c_params = <span class="property">@convert_params</span> runtime_state, params
        sf.<span class="function"><span class="title">runner</span></span> = =&gt; <span class="property">@run_manually</span> <span class="property">@code</span>, runtime_state, c_params
        <span class="keyword">return</span> sf
      <span class="keyword">return</span>

    <span class="keyword">if</span> <span class="property">@access_flags</span>.abstract
      runtime_state.java_throw rs.get_bs_class(<span class="string">'Ljava/lang/Error;'</span>), <span class="string">"called abstract method: <span class="subst">#{@full_signature()}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Finally, the normal case: running a Java method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ms.push(sf = <span class="keyword">new</span> runtime.StackFrame(<span class="keyword">this</span>,params,[]))
    <span class="keyword">if</span> <span class="property">@code</span>.run_stamp &lt; runtime_state.run_stamp
      <span class="property">@code</span>.run_stamp = runtime_state.run_stamp
      <span class="property">@code</span>.parse_code()
    sf.<span class="function"><span class="title">runner</span></span> = =&gt; <span class="property">@run_bytecode</span> runtime_state
    <span class="keyword">return</span> sf</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
