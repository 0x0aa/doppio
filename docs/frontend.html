<!DOCTYPE html>

<html>
<head>
  <title>frontend.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>frontend.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>root = <span class="keyword">this</span>

<span class="string">"use strict"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>To be initialized on document load</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>stdout = <span class="literal">null</span>
user_input = <span class="literal">null</span>
controller = <span class="literal">null</span>
editor = <span class="literal">null</span>
progress = <span class="literal">null</span>
bs_cl = <span class="literal">null</span>

<span class="function"><span class="title">preload</span></span> = -&gt;
  <span class="keyword">try</span>
    data = node.fs.readFileSync(<span class="string">"/home/doppio/browser/mini-rt.tar"</span>)
  <span class="keyword">catch</span> e
    console.error e

  <span class="keyword">if</span> data?
    file_count = <span class="number">0</span>
    done = <span class="literal">false</span>
    start_untar = (<span class="keyword">new</span> Date).getTime()
    <span class="function"><span class="title">on_complete</span></span> = -&gt;
      end_untar = (<span class="keyword">new</span> Date).getTime()
      console.log <span class="string">"Untarring took a total of <span class="subst">#{end_untar-start_untar}</span>ms."</span>
      $(<span class="string">'#overlay'</span>).fadeOut <span class="string">'slow'</span>
      $(<span class="string">'#progress-container'</span>).fadeOut <span class="string">'slow'</span>
      $(<span class="string">'#console'</span>).click()
    update_bar = _.throttle ((percent, path) -&gt;
      bar = $(<span class="string">'#progress &gt; .bar'</span>)
      preloading_file = $(<span class="string">'#preloading-file'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>+10% hack to make the bar appear fuller before fading kicks in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      display_perc = Math.min Math.ceil(percent*<span class="number">100</span>), <span class="number">100</span>
      bar.width <span class="string">"<span class="subst">#{display_perc}</span>%"</span>, <span class="number">150</span>
      preloading_file.text(
        <span class="keyword">if</span> display_perc &lt; <span class="number">100</span> <span class="keyword">then</span> <span class="string">"Loading <span class="subst">#{path}</span>"</span>  <span class="keyword">else</span> <span class="string">"Done!"</span>))

    untar <span class="keyword">new</span> util.BytesArray(util.bytestr_to_array data), ((percent, path, file) -&gt;
      update_bar(percent, path)
      base_dir = <span class="string">'vendor/classes/'</span>
      [base,ext] = path.split(<span class="string">'.'</span>)
      <span class="keyword">unless</span> ext <span class="keyword">is</span> <span class="string">'class'</span>
        on_complete() <span class="keyword">if</span> percent == <span class="number">100</span>
        <span class="keyword">return</span>
      file_count++
      cls = base.substr(base_dir.length)
      asyncExecute (-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>XXX: We convert from bytestr to array to process the tar file, and
     then back to a bytestr to store as a file in the filesystem.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        node.fs.writeFileSync(path, util.array_to_bytestr(file), <span class="string">'utf8'</span>, <span class="literal">true</span>)
        on_complete() <span class="keyword">if</span> --file_count == <span class="number">0</span> <span class="keyword">and</span> done
      ), <span class="number">0</span>),
      -&gt;
        done = <span class="literal">true</span>
        on_complete() <span class="keyword">if</span> file_count == <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Read in a binary classfile synchronously. Return an array of bytes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">read_classfile</span></span> = (cls, cb, failure_cb) -&gt;
  cls = cls[<span class="number">1.</span>..-<span class="number">1</span>] <span class="comment"># Convert Lfoo/bar/Baz; -&gt; foo/bar/Baz.</span>
  <span class="keyword">for</span> path <span class="keyword">in</span> jvm.classpath
    fullpath = <span class="string">"<span class="subst">#{path}</span><span class="subst">#{cls}</span>.class"</span>
    <span class="keyword">try</span>
      data = util.bytestr_to_array node.fs.readFileSync(fullpath)
    <span class="keyword">catch</span> e
      data = <span class="literal">null</span>
    <span class="keyword">return</span> cb(data) <span class="keyword">if</span> data?

  failure_cb(-&gt; <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Error: No file found for class <span class="subst">#{cls}</span>."</span>)

<span class="function"><span class="title">process_bytecode</span></span> = (bytecode_string) -&gt;
  bytes_array = util.bytestr_to_array bytecode_string
  <span class="keyword">new</span> ReferenceClassData(bytes_array)

<span class="function"><span class="title">onResize</span></span> = -&gt;
  $(<span class="string">'#console'</span>).height($(window).height() * <span class="number">0.7</span>)
  $(<span class="string">'#source'</span>).height($(window).height() * <span class="number">0.7</span>)

$(window).resize(onResize)

$(document).ready -&gt;
  onResize()
  editor = $(<span class="string">'#editor'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>set up the local file loaders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="string">'#file'</span>).change (ev) -&gt;
    <span class="keyword">unless</span> FileReader?
      controller.message <span class="string">"""
        Your browser doesn't support file loading.
        Try using the editor to create files instead.
        """</span>, <span class="string">"error"</span>
      <span class="keyword">return</span> $(<span class="string">'#console'</span>).click() <span class="comment"># click to restore focus</span>
    num_files = ev.target.files.length
    files_uploaded = <span class="number">0</span>
    controller.message <span class="string">"Uploading <span class="subst">#{num_files}</span> files...\n"</span>, <span class="string">'success'</span>, <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Need to make a function instead of making this the body of a loop so we
don&#39;t overwrite &quot;f&quot; before the onload handler calls.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">file_fcn</span></span> = ((f) -&gt;
      reader = <span class="keyword">new</span> FileReader
      reader.<span class="function"><span class="title">onerror</span></span> = (e) -&gt;
        <span class="keyword">switch</span> e.target.error.code
          <span class="keyword">when</span> e.target.error.NOT_FOUND_ERR <span class="keyword">then</span> alert <span class="string">"404'd"</span>
          <span class="keyword">when</span> e.target.error.NOT_READABLE_ERR <span class="keyword">then</span> alert <span class="string">"unreadable"</span>
          <span class="keyword">when</span> e.target.error.SECURITY_ERR <span class="keyword">then</span> alert <span class="string">"only works with --allow-file-access-from-files"</span>
      ext = f.name.split(<span class="string">'.'</span>)[<span class="number">1</span>]
      isClass = ext == <span class="string">'class'</span>
      reader.<span class="function"><span class="title">onload</span></span> = (e) -&gt;
        files_uploaded++
        node.fs.writeFileSync(node.process.cwd() + <span class="string">'/'</span> + f.name, e.target.result)
        controller.message <span class="string">"[<span class="subst">#{files_uploaded}</span>/<span class="subst">#{num_files}</span>] File '<span class="subst">#{f.name}</span>' saved.\n"</span>,
          <span class="string">'success'</span>, files_uploaded != num_files
        <span class="keyword">if</span> isClass
          editor.getSession?().setValue(<span class="string">"/*\n * Binary file: <span class="subst">#{f.name}</span>\n */"</span>)
        <span class="keyword">else</span>
          editor.getSession?().setValue(e.target.result)
        $(<span class="string">'#console'</span>).click() <span class="comment"># click to restore focus)</span>
      <span class="keyword">if</span> isClass <span class="keyword">then</span> reader.readAsBinaryString(f) <span class="keyword">else</span> reader.readAsText(f)
    )
    <span class="keyword">for</span> f <span class="keyword">in</span> ev.target.files
      file_fcn(f)
    <span class="keyword">return</span>

  jqconsole = $(<span class="string">'#console'</span>)
  controller = jqconsole.console
    promptLabel: <span class="string">'doppio &gt; '</span>
    commandHandle: (line) -&gt;
      [cmd,args...] = line.trim().split(<span class="regexp">/\s+/</span>)
      <span class="keyword">if</span> cmd == <span class="string">''</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">true</span>
      handler = commands[cmd]
      <span class="keyword">try</span>
        <span class="keyword">if</span> handler? <span class="keyword">then</span> handler(a.trim() <span class="keyword">for</span> a <span class="keyword">in</span> args <span class="keyword">when</span> a.length&gt;<span class="number">0</span>)
        <span class="keyword">else</span> <span class="string">"Unknown command '<span class="subst">#{cmd}</span>'. Enter 'help' for a list of commands."</span>
      <span class="keyword">catch</span> e
        controller.message e.toString(), <span class="string">'error'</span>
    tabComplete: tabComplete
    autofocus: <span class="literal">false</span>
    animateScroll: <span class="literal">true</span>
    promptHistory: <span class="literal">true</span>
    welcomeMessage: <span class="string">"""
      Welcome to Doppio! You may wish to try the following Java programs:
        java classes/test/FileRead
        java classes/demo/Fib &lt;num&gt;
        java classes/demo/Chatterbot
        java classes/demo/RegexTestHarness
        java classes/demo/GzipDemo c Hello.txt hello.gz (compress)
        java classes/demo/GzipDemo d hello.gz hello.tmp (decompress)
        java classes/demo/DiffPrint Hello.txt hello.tmp

      We support the stock Sun Java Compiler:
        javac classes/test/FileRead.java
        javac classes/demo/Fib.java

      (Note: if you edit a program and recompile with javac, you'll need
        to run 'clear_cache' to see your changes when you run the program.)

      We can run Rhino, the Java-based JS engine:
        rhino

      Text files can be edited by typing `edit [filename]`.

      You can also upload your own files using the uploader above the top-right
      corner of the console.

      Enter 'help' for full a list of commands. Ctrl-D is EOF.

      Doppio has been tested with the latest versions of the following desktop browsers:
        Chrome, Safari, Firefox, Opera, Internet Explorer 10, and Internet Explorer 9.
      """</span>

  <span class="function"><span class="title">stdout</span></span> = (str) -&gt; controller.message str, <span class="string">''</span>, <span class="literal">true</span> <span class="comment"># noreprompt</span>

  <span class="function"><span class="title">user_input</span></span> = (n_bytes, resume) -&gt;
    oldPrompt = controller.promptLabel
    controller.promptLabel = <span class="string">''</span>
    controller.reprompt()
    oldHandle = controller.commandHandle
    controller.<span class="function"><span class="title">commandHandle</span></span> = (line) -&gt;
      controller.commandHandle = oldHandle
      controller.promptLabel = oldPrompt
      <span class="keyword">if</span> line == <span class="string">'\0'</span> <span class="comment"># EOF</span>
        resume <span class="number">0</span>
      <span class="keyword">else</span>
        line += <span class="string">"\n"</span> <span class="comment"># so BufferedReader knows it has a full line</span>
        resume (line.charCodeAt(i) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>..Math.min(n_bytes,line.length)] <span class="keyword">by</span> <span class="number">1</span>)

  <span class="function"><span class="title">close_editor</span></span> = -&gt;
    $(<span class="string">'#ide'</span>).fadeOut <span class="string">'fast'</span>, -&gt;
      $(<span class="string">'#console'</span>).fadeIn(<span class="string">'fast'</span>).click() <span class="comment"># click to restore focus</span>

  $(<span class="string">'#save_btn'</span>).click (e) -&gt;
    fname = $(<span class="string">'#filename'</span>).val()
    contents = editor.getSession().getValue()
    contents += <span class="string">'\n'</span> <span class="keyword">unless</span> contents[contents.length-<span class="number">1</span>] == <span class="string">'\n'</span>
    node.fs.writeFileSync(fname, contents)
    controller.message(<span class="string">"File saved as '<span class="subst">#{fname}</span>'."</span>, <span class="string">'success'</span>)
    close_editor()
    e.preventDefault()

  $(<span class="string">'#close_btn'</span>).click (e) -&gt; close_editor(); e.preventDefault()
  bs_cl = <span class="keyword">new</span> ClassLoader.BootstrapClassLoader(read_classfile)
  preload()

commands =
  javac: (args, cb) -&gt;
    jvm.set_classpath <span class="string">'/home/doppio/vendor/classes/'</span>, <span class="string">'./:/home/doppio'</span>
    rs = <span class="keyword">new</span> runtime.RuntimeState(stdout, user_input, bs_cl)
    jvm.run_class(rs, <span class="string">'classes/util/Javac'</span>, args, -&gt; controller.reprompt())
    <span class="keyword">return</span> <span class="literal">null</span>  <span class="comment"># no reprompt, because we handle it ourselves</span>
  java: (args, cb) -&gt;
    <span class="keyword">if</span> !args[<span class="number">0</span>]? <span class="keyword">or</span> (args[<span class="number">0</span>] == <span class="string">'-classpath'</span> <span class="keyword">and</span> args.length &lt; <span class="number">3</span>)
      <span class="keyword">return</span> <span class="string">"Usage: java [-classpath path1:path2...] class [args...]"</span>
    <span class="keyword">if</span> args[<span class="number">0</span>] == <span class="string">'-classpath'</span>
      jvm.set_classpath <span class="string">'/home/doppio/vendor/classes/'</span>, args[<span class="number">1</span>]
      class_name = args[<span class="number">2</span>]
      class_args = args[<span class="number">3.</span>.]
    <span class="keyword">else</span>
      jvm.set_classpath <span class="string">'/home/doppio/vendor/classes/'</span>, <span class="string">'./'</span>
      class_name = args[<span class="number">0</span>]
      class_args = args[<span class="number">1.</span>.]
    rs = <span class="keyword">new</span> runtime.RuntimeState(stdout, user_input, bs_cl)
    jvm.run_class(rs, class_name, class_args, -&gt; controller.reprompt())
    <span class="keyword">return</span> <span class="literal">null</span>  <span class="comment"># no reprompt, because we handle it ourselves</span>
  test: (args) -&gt;
    <span class="keyword">return</span> <span class="string">"Usage: test all|[class(es) to test]"</span> <span class="keyword">unless</span> args[<span class="number">0</span>]?</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>method signature is:
run_tests(args,stdout,hide_diffs,quiet,keep_going,done_callback)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> args[<span class="number">0</span>] == <span class="string">'all'</span>
      testing.run_tests [], stdout, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">true</span>, -&gt; controller.reprompt()
    <span class="keyword">else</span>
      testing.run_tests args, stdout, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, -&gt; controller.reprompt()
    <span class="keyword">return</span> <span class="literal">null</span>
  javap: (args) -&gt;
    <span class="keyword">return</span> <span class="string">"Usage: javap class"</span> <span class="keyword">unless</span> args[<span class="number">0</span>]?
    <span class="keyword">try</span>
      raw_data = node.fs.readFileSync(<span class="string">"<span class="subst">#{args[<span class="number">0</span>]}</span>.class"</span>)
    <span class="keyword">catch</span> e
      <span class="keyword">return</span> [<span class="string">"Could not find class '<span class="subst">#{args[<span class="number">0</span>]}</span>'."</span>,<span class="string">'error'</span>]
    disassembler.disassemble process_bytecode raw_data
    <span class="keyword">return</span> <span class="literal">null</span>  <span class="comment"># no reprompt, because we handle it ourselves</span>
  rhino: (args, cb) -&gt;
    jvm.set_classpath <span class="string">'/home/doppio/vendor/classes/'</span>, <span class="string">'./'</span>
    rs = <span class="keyword">new</span> runtime.RuntimeState(stdout, user_input, bs_cl)
    jvm.run_class(rs, <span class="string">'org/mozilla/javascript/tools/shell/Main'</span>, args, -&gt; controller.reprompt())
    <span class="keyword">return</span> <span class="literal">null</span>  <span class="comment"># no reprompt, because we handle it ourselves</span>
  kawa: (args, cb) -&gt;
    jvm.set_classpath <span class="string">'/home/doppio/vendor/classes/'</span>, <span class="string">'./'</span>
    rs = <span class="keyword">new</span> runtime.RuntimeState(stdout, user_input, bs_cl)
    jvm.run_class(rs, <span class="string">'kawa/repl'</span>, args, -&gt; controller.reprompt())
    <span class="keyword">return</span> <span class="literal">null</span>  <span class="comment"># no reprompt, because we handle it ourselves</span>
  list_cache: -&gt;
    cached_classes = Object.keys(bs_cl.loaded_classes)
    <span class="string">'  '</span> + cached_classes.sort().join(<span class="string">'\n  '</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Reset the bootstrap classloader</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear_cache: -&gt;
    bs_cl = <span class="keyword">new</span> ClassLoader.BootstrapClassLoader(read_classfile)
    <span class="keyword">return</span> <span class="literal">true</span>
  ls: (args) -&gt;
    <span class="function"><span class="title">read_dir</span></span> = (dir) -&gt; node.fs.readdirSync(dir).sort().join <span class="string">'\n'</span>
    <span class="keyword">if</span> args.length == <span class="number">0</span>
      read_dir <span class="string">'.'</span>
    <span class="keyword">else</span> <span class="keyword">if</span> args.length == <span class="number">1</span>
      read_dir args[<span class="number">0</span>]
    <span class="keyword">else</span>
      (<span class="string">"<span class="subst">#{d}</span>:\n<span class="subst">#{read_dir d}</span>\n"</span> <span class="keyword">for</span> d <span class="keyword">in</span> args).join <span class="string">'\n'</span>
  edit: (args) -&gt;
    <span class="keyword">try</span>
      data = <span class="keyword">if</span> args[<span class="number">0</span>]? <span class="keyword">then</span> node.fs.readFileSync(args[<span class="number">0</span>]) <span class="keyword">else</span> defaultFile
    <span class="keyword">catch</span> e
      data = defaultFile
    $(<span class="string">'#console'</span>).fadeOut <span class="string">'fast'</span>, -&gt;
      $(<span class="string">'#filename'</span>).val args[<span class="number">0</span>]
      $(<span class="string">'#ide'</span>).fadeIn(<span class="string">'fast'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>initialize the editor. technically we only need to do this once, but more
than once is fine too</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      editor = ace.edit(<span class="string">'source'</span>)
      editor.setTheme <span class="string">'ace/theme/twilight'</span>
      ext = args[<span class="number">0</span>]?.split(<span class="string">'.'</span>)[<span class="number">1</span>]
      <span class="keyword">if</span> ext <span class="keyword">is</span> <span class="string">'java'</span> <span class="keyword">or</span> <span class="keyword">not</span> args[<span class="number">0</span>]?
        JavaMode = require(<span class="string">"ace/mode/java"</span>).Mode
        editor.getSession().setMode(<span class="keyword">new</span> JavaMode)
      <span class="keyword">else</span>
        TextMode = require(<span class="string">"ace/mode/text"</span>).Mode
        editor.getSession().setMode(<span class="keyword">new</span> TextMode)
      editor.getSession().setValue(data)
    <span class="literal">true</span>
  cat: (args) -&gt;
    fname = args[<span class="number">0</span>]
    <span class="keyword">return</span> <span class="string">"Usage: cat &lt;file&gt;"</span> <span class="keyword">unless</span> fname?
    <span class="keyword">try</span>
      <span class="keyword">return</span> node.fs.readFileSync(fname)
    <span class="keyword">catch</span> e
      <span class="keyword">return</span> <span class="string">"ERROR: <span class="subst">#{fname}</span> does not exist."</span>
  mv: (args) -&gt;
    <span class="keyword">if</span> args.length &lt; <span class="number">2</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">"Usage: mv &lt;from-file&gt; &lt;to-file&gt;"</span>
    <span class="keyword">try</span>
      node.fs.renameSync(args[<span class="number">0</span>], args[<span class="number">1</span>])
    <span class="keyword">catch</span> e
      <span class="keyword">return</span> <span class="string">"Invalid arguments."</span>
    <span class="literal">true</span>
  cd: (args) -&gt;
    <span class="keyword">if</span> args.length &gt; <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">"Usage: cd &lt;directory&gt;"</span>
    <span class="keyword">if</span> args.length == <span class="number">0</span> <span class="keyword">then</span> args.push(<span class="string">"~"</span>)
    <span class="keyword">try</span>
      node.process.chdir(args[<span class="number">0</span>])
    <span class="keyword">catch</span> e
      <span class="keyword">return</span> <span class="string">"Invalid directory."</span>
    <span class="literal">true</span>
  rm: (args) -&gt;
    <span class="keyword">return</span> <span class="string">"Usage: rm &lt;file&gt;"</span> <span class="keyword">unless</span> args[<span class="number">0</span>]?
    <span class="keyword">if</span> args[<span class="number">0</span>] == <span class="string">'*'</span>
      fnames = node.fs.readdirSync(<span class="string">'.'</span>)
      <span class="keyword">for</span> fname <span class="keyword">in</span> fnames
        fstat = node.fs.statSync(fname)
        <span class="keyword">if</span> fstat.is_directory
          <span class="keyword">return</span> <span class="string">"ERROR: '<span class="subst">#{fname}</span>' is a directory."</span>
        node.fs.unlinkSync(fname)
    <span class="keyword">else</span> node.fs.unlinkSync args[<span class="number">0</span>]
    <span class="literal">true</span>
  emacs: -&gt; <span class="string">"Try 'vim'."</span>
  vim: -&gt; <span class="string">"Try 'emacs'."</span>
  time: (args) -&gt;
    start = (<span class="keyword">new</span> Date).getTime()
    console.profile args[<span class="number">0</span>]
    controller.<span class="function"><span class="title">onreprompt</span></span> = -&gt;
      controller.onreprompt = <span class="literal">null</span>
      console.profileEnd()
      end = (<span class="keyword">new</span> Date).getTime()
      controller.message <span class="string">"\nCommand took a total of <span class="subst">#{end-start}</span>ms to run.\n"</span>, <span class="string">''</span>, <span class="literal">true</span>
    commands[args.shift()](args)
  profile: (args) -&gt;
    count = <span class="number">0</span>
    runs = <span class="number">5</span>
    duration = <span class="number">0</span>
    <span class="function"><span class="title">time_once</span></span> = -&gt;
      start = (<span class="keyword">new</span> Date).getTime()
      controller.<span class="function"><span class="title">onreprompt</span></span> = -&gt;
        <span class="keyword">unless</span> count &lt; runs
          controller.onreprompt = <span class="literal">null</span>
          controller.message <span class="string">"\n<span class="subst">#{args[<span class="number">0</span>]}</span> took an average of <span class="subst">#{duration/runs}</span>ms.\n"</span>, <span class="string">''</span>, <span class="literal">true</span>
          <span class="keyword">return</span>
        end = (<span class="keyword">new</span> Date).getTime()
        <span class="keyword">if</span> count++ == <span class="number">0</span> <span class="comment"># first one to warm the cache</span>
          <span class="keyword">return</span> time_once()
        duration += end - start
        time_once()
      commands[args.shift()](args)
    time_once()
  help: (args) -&gt;
    <span class="string">"""
    Ctrl-D is EOF.

    Java-related commands:
      javac &lt;source file&gt;    -- Invoke the Java 6 compiler.
      java &lt;class&gt; [args...] -- Run with command-line arguments.
      javap &lt;class&gt;          -- Display disassembly.
      time                   -- Measure how long it takes to run a command.

    File management:
      cat &lt;file&gt;             -- Display a file in the console.
      edit &lt;file&gt;            -- Edit a file.
      ls &lt;dir&gt;               -- List files.
      mv &lt;src&gt; &lt;dst&gt;         -- Move / rename a file.
      rm &lt;file&gt;              -- Delete a file.
      cd &lt;dir&gt;               -- Change current directory.

    Cache management:
      list_cache             -- List the cached class files.
      clear_cache            -- Clear the cached class files.

    Applications:
      rhino                  -- Run Rhino, the Java-based JavaScript engine.
      kawa                   -- Run Kawa-Scheme, the Java-based Scheme implementation.
    """</span>

<span class="function"><span class="title">tabComplete</span></span> = -&gt;
  promptText = controller.promptText()
  args = promptText.split <span class="regexp">/\s+/</span>
  <span class="function"><span class="title">getCompletions</span></span> = (args) -&gt;
    <span class="keyword">if</span> args.length <span class="keyword">is</span> <span class="number">1</span> <span class="keyword">then</span> commandCompletions args[<span class="number">0</span>]
    <span class="keyword">else</span> <span class="keyword">if</span> args[<span class="number">0</span>] <span class="keyword">is</span> <span class="string">'time'</span> <span class="keyword">then</span> getCompletions(args[<span class="number">1.</span>.])
    <span class="keyword">else</span> fileNameCompletions args[<span class="number">0</span>], args
  prefix = longestCommmonPrefix(getCompletions(args))
  <span class="keyword">return</span> <span class="keyword">if</span> prefix == <span class="string">''</span>  <span class="comment"># TODO: if we're tab-completing a blank, show all options</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>delete existing text so we can do case correction</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  promptText = promptText.substr(<span class="number">0</span>, promptText.length - util.last(args).length)
  controller.promptText(promptText + prefix)

<span class="function"><span class="title">commandCompletions</span></span> = (cmd) -&gt;
  (name <span class="keyword">for</span> name, handler <span class="keyword">of</span> commands <span class="keyword">when</span> name.substr(<span class="number">0</span>, cmd.length) <span class="keyword">is</span> cmd)

<span class="function"><span class="title">fileNameCompletions</span></span> = (cmd, args) -&gt;
  <span class="function"><span class="title">validExtension</span></span> = (fname) -&gt;
    dot = fname.lastIndexOf(<span class="string">'.'</span>)
    ext = <span class="keyword">if</span> dot <span class="keyword">is</span> -<span class="number">1</span> <span class="keyword">then</span> <span class="string">''</span> <span class="keyword">else</span> fname.slice(dot+<span class="number">1</span>)
    <span class="keyword">if</span> cmd <span class="keyword">is</span> <span class="string">'javac'</span> <span class="keyword">then</span> ext <span class="keyword">is</span> <span class="string">'java'</span>
    <span class="keyword">else</span> <span class="keyword">if</span> cmd <span class="keyword">is</span> <span class="string">'javap'</span> <span class="keyword">or</span> cmd <span class="keyword">is</span> <span class="string">'java'</span> <span class="keyword">then</span> ext <span class="keyword">is</span> <span class="string">'class'</span>
    <span class="keyword">else</span> <span class="literal">true</span>
  chopExt = args.length == <span class="number">2</span> <span class="keyword">and</span> (cmd <span class="keyword">is</span> <span class="string">'javap'</span> <span class="keyword">or</span> cmd <span class="keyword">is</span> <span class="string">'java'</span>)
  toComplete = util.last(args)
  lastSlash = toComplete.lastIndexOf(<span class="string">'/'</span>)
  <span class="keyword">if</span> lastSlash &gt;= <span class="number">0</span>
    dirPfx = toComplete.slice(<span class="number">0</span>, lastSlash+<span class="number">1</span>)
    searchPfx = toComplete.slice(lastSlash+<span class="number">1</span>)
  <span class="keyword">else</span>
    dirPfx = <span class="string">''</span>
    searchPfx = toComplete
  <span class="keyword">try</span>
    dirList = node.fs.readdirSync(<span class="keyword">if</span> dirPfx == <span class="string">''</span> <span class="keyword">then</span> <span class="string">'.'</span> <span class="keyword">else</span> dirPfx)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Slight cheat.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dirList.push(<span class="string">'..'</span>)
    dirList.push(<span class="string">'.'</span>)
  <span class="keyword">catch</span> e
    <span class="keyword">return</span> []

  completions = []
  <span class="keyword">for</span> item <span class="keyword">in</span> dirList
    isDir = node.fs.statSync(dirPfx + item)?.isDirectory()
    <span class="keyword">continue</span> <span class="keyword">unless</span> validExtension(item) <span class="keyword">or</span> isDir
    <span class="keyword">if</span> item.slice(<span class="number">0</span>, searchPfx.length) == searchPfx
      <span class="keyword">if</span> isDir
        completions.push(dirPfx + item + <span class="string">'/'</span>)
      <span class="keyword">else</span> <span class="keyword">if</span> cmd != <span class="string">'cd'</span>
        completions.push(dirPfx + (<span class="keyword">if</span> chopExt <span class="keyword">then</span> item.split(<span class="string">'.'</span>,<span class="number">1</span>)[<span class="number">0</span>] <span class="keyword">else</span> item))
  completions</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>use the awesome greedy regex hack, from <a href="http://stackoverflow.com/a/1922153/10601">http://stackoverflow.com/a/1922153/10601</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">longestCommmonPrefix</span></span> = (lst) -&gt; lst.join(<span class="string">' '</span>).match(<span class="regexp">/^(\S*)\S*(?: \1\S*)*$/i</span>)[<span class="number">1</span>]

defaultFile =
  <span class="string">"""
  class Test {
    public static void main(String[] args) {
      // enter code here
    }
  }
  """</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
