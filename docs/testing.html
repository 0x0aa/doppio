<!DOCTYPE html>

<html>
<head>
  <title>testing.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="frontend.html">
                frontend.coffee
              </a>
            
              
              <a class="source" href="node.html">
                node.coffee
              </a>
            
              
              <a class="source" href="untar.html">
                untar.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="ClassData.html">
                ClassData.coffee
              </a>
            
              
              <a class="source" href="ClassLoader.html">
                ClassLoader.coffee
              </a>
            
              
              <a class="source" href="ConstantPool.html">
                ConstantPool.coffee
              </a>
            
              
              <a class="source" href="attributes.html">
                attributes.coffee
              </a>
            
              
              <a class="source" href="disassembler.html">
                disassembler.coffee
              </a>
            
              
              <a class="source" href="exceptions.html">
                exceptions.coffee
              </a>
            
              
              <a class="source" href="java_object.html">
                java_object.coffee
              </a>
            
              
              <a class="source" href="jvm.html">
                jvm.coffee
              </a>
            
              
              <a class="source" href="logging.html">
                logging.coffee
              </a>
            
              
              <a class="source" href="methods.html">
                methods.coffee
              </a>
            
              
              <a class="source" href="natives.html">
                natives.coffee
              </a>
            
              
              <a class="source" href="opcodes.html">
                opcodes.coffee
              </a>
            
              
              <a class="source" href="runtime.html">
                runtime.coffee
              </a>
            
              
              <a class="source" href="testing.html">
                testing.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>testing.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">#!/usr/bin/env coffee</span>

jvm = require <span class="string">'./jvm'</span>
{RuntimeState} = require <span class="string">'./runtime'</span>
util = require <span class="string">'./util'</span>
{disassemble} = require <span class="string">'./disassembler'</span>
{ReferenceClassData} = require <span class="string">'./ClassData'</span>
fs = node?.fs ? require <span class="string">'fs'</span>
path = node?.path ? require <span class="string">'path'</span>
{BootstrapClassLoader} = require <span class="string">'./ClassLoader'</span>

<span class="string">"use strict"</span>

root = exports ? window.testing ?= {}

root.<span class="function"><span class="title">find_test_classes</span></span> = (doppio_dir) -&gt;
  test_dir = path.resolve doppio_dir, <span class="string">'classes/test'</span>
  <span class="keyword">for</span> file <span class="keyword">in</span> fs.readdirSync(test_dir) <span class="keyword">when</span> path.extname(file) == <span class="string">'.java'</span>
    <span class="string">"classes/test/<span class="subst">#{path.basename(file, '.java')}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Note that the lack of return value here implies that the above is actually
a list comprehension. This is intended behavior.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.<span class="function"><span class="title">run_tests</span></span> = (test_classes, stdout, hide_diffs, quiet, keep_going, callback) -&gt;
  doppio_dir = <span class="keyword">if</span> node? <span class="keyword">then</span> <span class="string">'/home/doppio/'</span> <span class="keyword">else</span> path.resolve __dirname, <span class="string">'..'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>get the tests, if necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> test_classes?.length &gt; <span class="number">0</span>
    test_classes = (tc.replace(<span class="regexp">/\.class$/</span>,<span class="string">''</span>) <span class="keyword">for</span> tc <span class="keyword">in</span> test_classes)
  <span class="keyword">else</span>
    test_classes = root.find_test_classes doppio_dir</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>set up the classpath</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  jcl_dir = path.resolve doppio_dir, <span class="string">'vendor/classes'</span>
  jvm.classpath = [doppio_dir, jcl_dir]

  _runner = () -&gt;
    <span class="keyword">if</span> test_classes.length == <span class="number">0</span>
      quiet || keep_going || stdout <span class="string">"Pass\n"</span>
      <span class="keyword">return</span> callback(<span class="literal">false</span>)
    test = test_classes.shift()
    quiet || stdout <span class="string">"testing <span class="subst">#{test}</span>...\n"</span>
    <span class="keyword">if</span> (disasm_diff = run_disasm_test(doppio_dir, test))?
      stdout <span class="string">"Failed disasm test <span class="subst">#{test}</span>\n"</span>
      hide_diffs || stdout <span class="string">"<span class="subst">#{disasm_diff}</span>\n"</span>
      <span class="keyword">return</span> callback(<span class="literal">true</span>) <span class="keyword">unless</span> keep_going
    run_stdout_test doppio_dir, test, (diff) -&gt;
      <span class="keyword">if</span> diff?
        stdout <span class="string">"Failed output test <span class="subst">#{test}</span>\n"</span>
        hide_diffs || stdout <span class="string">"<span class="subst">#{diff}</span>\n"</span>
        <span class="keyword">return</span> callback(<span class="literal">true</span>) <span class="keyword">unless</span> keep_going
      _runner()

  _runner()</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>remove comments and blank lines, ignore specifics of float/double printing and whitespace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">sanitize</span></span> = (str) -&gt;
  str.replace(<span class="regexp">/\/\/.*/g</span>, <span class="string">''</span>)
     .replace(<span class="regexp">/^\s*$[\n\r]+/mg</span>, <span class="string">''</span>)
     .replace(<span class="regexp">/(float|double)\t.*/g</span>, <span class="string">'$1'</span>)
     .replace(<span class="regexp">/[ \t\r]+/g</span>, <span class="string">' '</span>)
     .replace(<span class="regexp">/[ ]\n/g</span>, <span class="string">'\n'</span>)
     .replace(<span class="regexp">/\[ \]/g</span>, <span class="string">'[]'</span>)

<span class="function"><span class="title">run_disasm_test</span></span> = (doppio_dir, test_class) -&gt;
  test_path = path.resolve(doppio_dir, test_class)
  javap_disasm = sanitize(fs.readFileSync <span class="string">"<span class="subst">#{test_path}</span>.disasm"</span>, <span class="string">'utf8'</span>)
  bytes_array = util.bytestr_to_array fs.readFileSync <span class="string">"<span class="subst">#{test_path}</span>.class"</span>, <span class="string">'binary'</span>
  doppio_disasm = sanitize disassemble <span class="keyword">new</span> ReferenceClassData bytes_array
  <span class="keyword">return</span> cleandiff doppio_disasm, javap_disasm

<span class="function"><span class="title">run_stdout_test</span></span> = (doppio_dir, test_class, callback) -&gt;
  java_output = fs.readFileSync <span class="string">"<span class="subst">#{path.resolve doppio_dir, test_class}</span>.runout"</span>, <span class="string">'utf8'</span>
  doppio_output = <span class="string">''</span>
  <span class="function"><span class="title">stdout</span></span> = (str) -&gt; doppio_output += str
  rs = <span class="keyword">new</span> RuntimeState stdout, (-&gt;), <span class="keyword">new</span> BootstrapClassLoader(jvm.read_classfile)
  jvm.run_class rs, test_class, [], -&gt;
    callback cleandiff(doppio_output, java_output)

<span class="function"><span class="title">cleandiff</span></span> = (our_str, their_str) -&gt;
  our_lines = our_str.split <span class="regexp">/\n/</span>
  their_lines = their_str.split <span class="regexp">/\n/</span>
  [oidx,tidx] = [<span class="number">0</span>,<span class="number">0</span>]
  diff = []
  <span class="keyword">while</span> oidx &lt; our_lines.length <span class="keyword">and</span> tidx &lt; their_lines.length
    <span class="keyword">continue</span> <span class="keyword">if</span> our_lines[oidx++] == their_lines[tidx++]
    diff.push <span class="string">"D:<span class="subst">#{our_lines[oidx-<span class="number">1</span>]}</span>\nJ:<span class="subst">#{their_lines[tidx-<span class="number">1</span>]}</span>"</span>
  <span class="keyword">for</span> extra <span class="keyword">in</span> our_lines[oidx..]
    diff.push <span class="string">"D:<span class="subst">#{extra}</span>"</span>
  <span class="keyword">for</span> extra <span class="keyword">in</span> their_lines[tidx..]
    diff.push <span class="string">"J:<span class="subst">#{extra}</span>"</span>
  <span class="keyword">return</span> diff.join <span class="string">'\n'</span> <span class="keyword">if</span> diff.length &gt; <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>unused for now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">cleandiff_fancy</span></span> = (our_str, their_str) -&gt;
  our_lines = our_str.split <span class="regexp">/\n/</span>
  their_lines = their_str.split <span class="regexp">/\n/</span>
  <span class="keyword">if</span> our_lines.length == <span class="number">0</span>
    <span class="keyword">return</span> (<span class="string">"J:<span class="subst">#{line}</span>"</span> <span class="keyword">for</span> line <span class="keyword">in</span> their_lines).join <span class="string">'\n'</span>
  <span class="keyword">if</span> their_lines.length == <span class="number">0</span>
    <span class="keyword">return</span> (<span class="string">"D:<span class="subst">#{line}</span>"</span> <span class="keyword">for</span> line <span class="keyword">in</span> our_lines).join <span class="string">'\n'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>using something like Levenshtein distance to get the minimal diff</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dist = []
  cfrm = []  <span class="comment"># comefrom path matrix: 1 = Up, 2 = Left, 3 = Diag, 4 = Diag-match</span>
  <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>.their_lines.length] <span class="keyword">by</span> <span class="number">1</span>
    dist.push (<span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> [<span class="number">0.</span>.our_lines.length] <span class="keyword">by</span> <span class="number">1</span>)
    cfrm.push (<span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> [<span class="number">0.</span>.our_lines.length] <span class="keyword">by</span> <span class="number">1</span>)
    dist[i][<span class="number">0</span>] = i
    cfrm[i][<span class="number">0</span>] = <span class="number">1</span>
  <span class="keyword">for</span> j <span class="keyword">in</span> [<span class="number">0.</span>.our_lines.length] <span class="keyword">by</span> <span class="number">1</span>
    dist[<span class="number">0</span>][j] = j
    cfrm[<span class="number">0</span>][j] = <span class="number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>compute least-cost path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">1.</span>.their_lines.length] <span class="keyword">by</span> <span class="number">1</span>
    <span class="keyword">for</span> j <span class="keyword">in</span> [<span class="number">1.</span>.our_lines.length] <span class="keyword">by</span> <span class="number">1</span>
      <span class="keyword">if</span> our_lines[j-<span class="number">1</span>] == their_lines[i-<span class="number">1</span>]
        dist[i][j] = dist[i-<span class="number">1</span>][j-<span class="number">1</span>]
        cfrm[i][j] = <span class="number">4</span>  <span class="comment"># diag-match</span>
      <span class="keyword">else</span>
        dd = [dist[i-<span class="number">1</span>][j], dist[i][j-<span class="number">1</span>], dist[i-<span class="number">1</span>][j-<span class="number">1</span>]]
        d = Math.min dd...
        dist[i][j] = d + <span class="number">1</span>
        cfrm[i][j] = dd.indexOf(d) + <span class="number">1</span>
  i = their_lines.length
  j = our_lines.length</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>they match if the final cost is still zero</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> <span class="keyword">if</span> dist[i][j] == <span class="number">0</span>
  diff = []
  <span class="keyword">until</span> i == <span class="number">0</span> <span class="keyword">and</span> j == <span class="number">0</span>
    <span class="keyword">switch</span> cfrm[i][j]
      <span class="keyword">when</span> <span class="number">1</span>  <span class="comment"># up</span>
        diff.unshift <span class="string">"doppio{<span class="subst">#{j}</span>}:<span class="subst">#{our_lines[j]}</span>\njava  {<span class="subst">#{i}</span>}:<span class="subst">#{their_lines[i--]}</span>"</span>
      <span class="keyword">when</span> <span class="number">2</span>  <span class="comment"># left</span>
        diff.unshift <span class="string">"doppio{<span class="subst">#{j}</span>}:<span class="subst">#{our_lines[j--]}</span>\njava  {<span class="subst">#{i}</span>}:<span class="subst">#{their_lines[i]}</span>"</span>
      <span class="keyword">when</span> <span class="number">3</span>  <span class="comment"># diag mismatch</span>
        diff.unshift <span class="string">"doppio{<span class="subst">#{j}</span>}:<span class="subst">#{our_lines[j--]}</span>\njava  {<span class="subst">#{i}</span>}:<span class="subst">#{their_lines[i--]}</span>"</span>
      <span class="keyword">when</span> <span class="number">4</span>  <span class="comment"># diag match</span>
        i--
        j--
  <span class="keyword">return</span> diff.join <span class="string">'\n'</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
